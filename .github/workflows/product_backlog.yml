name: üöÄ Crear Backlog y Sprints del Proyecto - Visi√≥n Computacional

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  setup-project-backlog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Crear Proyecto de GitHub si no existe
        id: project_setup
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PROJECT_NAME="Product Backlog - Visi√≥n Computacional"
          PROJECT_NUMBER=$(gh project list --owner "@me" --format json | jq -r ".projects[] | select(.title == \"$PROJECT_NAME\") | .number")
          
          if [ -z "$PROJECT_NUMBER" ]; then
            echo "Proyecto '$PROJECT_NAME' no encontrado. Cre√°ndolo ahora..."
            PROJECT_URL=$(gh project create --owner "@me" --title "$PROJECT_NAME")
            PROJECT_NUMBER=$(echo "$PROJECT_URL" | rev | cut -d'/' -f1 | rev)
            echo "Proyecto creado con el n√∫mero: $PROJECT_NUMBER"
          else
            echo "Proyecto '$PROJECT_NAME' ya existe con el n√∫mero: $PROJECT_NUMBER"
          fi
          echo "PROJECT_NUMBER=$PROJECT_NUMBER" >> $GITHUB_OUTPUT

      - name: Crear Etiquetas de Prioridad si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Creando etiquetas de prioridad..."
          gh label create "Prioridad: Alta" --color "D93F0B" --description "Esta tarea es cr√≠tica y bloquea otras." || echo "La etiqueta 'Prioridad: Alta' ya existe."
          gh label create "Prioridad: Media" --color "FBCA04" --description "Tarea importante pero no urgente." || echo "La etiqueta 'Prioridad: Media' ya existe."
          gh label create "Prioridad: Baja" --color "0E8A16" --description "Tarea menor o mejora deseable." || echo "La etiqueta 'Prioridad: Baja' ya existe."
          
          echo "Creando etiquetas de tipo..."
          gh label create "Backend" --color "1D76DB" --description "Tareas de backend y APIs." || echo "La etiqueta 'Backend' ya existe."
          gh label create "Frontend" --color "5319E7" --description "Tareas de frontend y UI." || echo "La etiqueta 'Frontend' ya existe."
          gh label create "IA/ML" --color "FF6B6B" --description "Tareas relacionadas con Inteligencia Artificial." || echo "La etiqueta 'IA/ML' ya existe."
      
      - name: Crear Milestones si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GH_REPO: ${{ github.repository }}
        run: |
          MILESTONE_W1_TITLE="Sprint Visi√≥n Computacional - Semana 1 (17-19 Nov 2025)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_W1_TITLE\")" | grep -qF "$MILESTONE_W1_TITLE"; then
            echo "Milestone '$MILESTONE_W1_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_W1_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_W1_TITLE" \
              -f description='Implementaci√≥n de funcionalidades de visi√≥n computacional con Azure. Semana 1: OCR y Reconocimiento Facial.' \
              -f due_on='2025-11-19T23:59:59Z'
          fi

          MILESTONE_W2_TITLE="Sprint Visi√≥n Computacional - Semana 2 (20-24 Nov 2025)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_W2_TITLE\")" | grep -qF "$MILESTONE_W2_TITLE"; then
            echo "Milestone '$MILESTONE_W2_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_W2_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_W2_TITLE" \
              -f description='Implementaci√≥n de funcionalidades de visi√≥n computacional con Azure. Semana 2: An√°lisis de Im√°genes y Detecci√≥n de Objetos.' \
              -f due_on='2025-11-24T23:59:59Z'
          fi

      - name: Crear Issues y a√±adirlas al Proyecto
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          PROJECT_NUMBER: ${{ steps.project_setup.outputs.PROJECT_NUMBER }}
        run: |
          create_and_add_to_project() {
            local title="$1"
            local body="$2"
            local labels="$3"
            local milestone="$4"
            
            ISSUE_URL=$(gh issue list --state all --search "in:title \"$title\"" --json url -q ".[0].url")

            if [ -n "$ISSUE_URL" ]; then
              echo "Issue '$title' ya existe. Omitiendo creaci√≥n."
            else
              echo "Creando issue '$title'..."
              IFS=',' read -ra LABEL_ARRAY <<< "$labels"
              LABEL_ARGS=""
              for label in "${LABEL_ARRAY[@]}"; do
                LABEL_ARGS="$LABEL_ARGS --label \"$label\""
              done
              
              ISSUE_URL=$(eval "gh issue create --title \"$title\" --body \"$body\" $LABEL_ARGS --milestone \"$milestone\"")
            fi

            if [ -n "$ISSUE_URL" ]; then
                echo "A√±adiendo issue $ISSUE_URL al proyecto..."
                PROJECT_ID=$(gh project view ${{ env.PROJECT_NUMBER }} --owner "@me" --format json | jq -r '.id')
                CONTENT_ID=$(gh issue view $ISSUE_URL --json id | jq -r '.id')

                ITEM_ID=$(gh api graphql -f query='
                  mutation($project:ID!, $content:ID!) {
                    addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                      item { id }
                    }
                  }
                ' -f project="$PROJECT_ID" -f content="$CONTENT_ID" | jq -r '.data.addProjectV2ItemById.item.id')

                TODO_COLUMN_ID="f75ad846"
                STATUS_FIELD_ID="PVTSSF_lAHOCfyr_s4BFLg_zg2l7HM"
                
                gh api graphql -f query="
                  mutation {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: \"$PROJECT_ID\",
                      itemId: \"$ITEM_ID\",
                      fieldId: \"$STATUS_FIELD_ID\",
                      value: {singleSelectOptionId: \"$TODO_COLUMN_ID\"}
                    }) {
                      projectV2Item { id }
                    }
                  }
                " || echo "No se pudo mover la issue a la columna Todo."
            fi
          }

          # HU-VC1: Reconocimiento Facial
          create_and_add_to_project \
            "[BE] HU-VC1: Reconocimiento Facial para Login y Registro" \
            "$(cat << 'EOF'
## üéØ Historia de Usuario

**Como** usuario de BrainBlitz  
**Quiero** autenticarme usando reconocimiento facial  
**Para que** pueda acceder de forma segura y r√°pida sin depender de contrase√±as

---

## üìã Contexto

Los usuarios necesitan una forma segura y moderna de autenticarse sin depender √∫nicamente de contrase√±as mediante reconocimiento facial biom√©trico.

## üéØ Objetivo

Permitir que los usuarios se registren e inicien sesi√≥n usando reconocimiento facial, mejorando la seguridad y experiencia de usuario.

## ‚úÖ Criterios de Aceptaci√≥n

### 1. Registro Facial
- Endpoint POST /api/face/register que acepta imagen Base64 y token Firebase
- Validaci√≥n de rostro visible usando DeepFace
- Generaci√≥n de embeddings faciales con modelo VGG-Face
- Almacenamiento de embeddings en Firestore
- Prevenci√≥n de duplicados

### 2. Login Facial
- Endpoint POST /api/face/login que acepta imagen Base64 y email
- Comparaci√≥n facial con embedding almacenado
- Umbral de confianza m√≠nimo (0.7)
- Generaci√≥n de token personalizado Firebase

### 3. Frontend
- Componente FaceRegister.jsx con vista previa de c√°mara
- Componente FaceLogin.jsx con captura de foto
- Integraci√≥n con AuthContext

### 4. Seguridad
- Autenticaci√≥n requerida para registro
- Almacenamiento seguro de embeddings
- Rate limiting en endpoints

### 5. Despliegue
- Microservicio facial en Azure Container Instances
- Health check funcional

## üìä Estimaci√≥n: 13 Story Points
## üéØ Prioridad: Alta
## üìÖ Fecha: 18 Noviembre 2025
## üîß Tecnolog√≠as: DeepFace, VGG-Face, Azure, Firebase, React
EOF
)" \
            "Prioridad: Alta,Backend,IA/ML" \
            "Sprint Visi√≥n Computacional - Semana 1 (17-19 Nov 2025)"

          # HU-VC2: OCR
          create_and_add_to_project \
            "[BE] HU-VC2: OCR - Extracci√≥n de Texto de Im√°genes" \
            "$(cat << 'EOF'
## üéØ Historia de Usuario

**Como** administrador o usuario  
**Quiero** extraer texto de im√°genes autom√°ticamente  
**Para que** pueda crear preguntas r√°pidamente desde capturas o documentos

---

## üìã Contexto

Los usuarios necesitan convertir im√°genes con texto en texto editable para generar preguntas autom√°ticamente.

## üéØ Objetivo

Implementar OCR que permita extraer texto de im√°genes facilitando la creaci√≥n de preguntas.

## ‚úÖ Criterios de Aceptaci√≥n

### 1. Configuraci√≥n Azure
- Variables AZURE_COMPUTER_VISION_KEY y ENDPOINT en .env
- Instalaci√≥n de dependencias Azure

### 2. Endpoint Backend
- Ruta POST /api/vision/extract-text
- Controlador visionController.js con m√©todo extractText
- Validaci√≥n imagen Base64, l√≠mite 4MB

### 3. Integraci√≥n Azure OCR
- POST a endpoint Azure Computer Vision v3.2
- Manejo as√≠ncrono (analyze ‚Üí get results)
- Extracci√≥n de l√≠neas de texto

### 4. Respuesta
- JSON con texto completo, idioma, confianza, l√≠neas

### 5. Frontend
- Componente OCRQuestionCreator.jsx
- Preview imagen, bot√≥n extraer texto
- Integraci√≥n con AIQuestionGenerator

### 6. Documentaci√≥n
- Endpoint en swagger.yaml
- Instrucciones configuraci√≥n Azure

## üìä Estimaci√≥n: 8 Story Points
## üéØ Prioridad: Media
## üìÖ Fecha: 17 Noviembre 2025
## üîß Tecnolog√≠as: Azure Computer Vision OCR, Node.js, React
EOF
)" \
            "Prioridad: Media,Backend,IA/ML" \
            "Sprint Visi√≥n Computacional - Semana 1 (17-19 Nov 2025)"

          # HU-VC3: An√°lisis de Im√°genes
          create_and_add_to_project \
            "[BE] HU-VC3: An√°lisis Inteligente de Im√°genes" \
            "$(cat << 'EOF'
## üéØ Historia de Usuario

**Como** creador de contenido  
**Quiero** analizar im√°genes para obtener descripciones y tags  
**Para que** pueda generar preguntas visuales autom√°ticamente

---

## üìã Contexto

Los usuarios necesitan generar preguntas autom√°ticamente a partir de an√°lisis de im√°genes con IA.

## üéØ Objetivo

Implementar an√°lisis inteligente que genere descripciones, tags, categor√≠as y metadatos autom√°ticamente.

## ‚úÖ Criterios de Aceptaci√≥n

### 1. Endpoint Backend
- Ruta POST /api/vision/analyze-image
- M√©todo analyzeImage en visionController.js

### 2. Integraci√≥n Azure
- POST con visualFeatures: Description, Tags, Categories, Objects, Color
- Procesamiento respuesta JSON

### 3. Extracci√≥n Datos
- Descripci√≥n principal y alternativas
- Tags con confianza
- Categor√≠as detectadas
- Objetos con bounding boxes
- Colores dominantes

### 4. Frontend
- Componente ImageAnalysisQuestionCreator.jsx
- Mostrar resultados en secciones
- Generaci√≥n autom√°tica de preguntas
- Integraci√≥n con AIQuestionGenerator

### 5. Documentaci√≥n
- Endpoint en Swagger
- Ejemplos de uso

## üìä Estimaci√≥n: 10 Story Points
## üéØ Prioridad: Media
## üìÖ Fecha: 20 Noviembre 2025
## üîß Tecnolog√≠as: Azure Computer Vision Analyze, Node.js, React
EOF
)" \
            "Prioridad: Media,Backend,IA/ML" \
            "Sprint Visi√≥n Computacional - Semana 2 (20-24 Nov 2025)"

          # HU-VC4: Detecci√≥n de Objetos
          create_and_add_to_project \
            "[BE] HU-VC4: Detecci√≥n de Objetos en Im√°genes" \
            "$(cat << 'EOF'
## üéØ Historia de Usuario

**Como** creador de preguntas visuales  
**Quiero** detectar y localizar objetos autom√°ticamente  
**Para que** pueda crear preguntas sobre identificaci√≥n y conteo

---

## üìã Contexto

Los usuarios necesitan crear preguntas visuales donde se identifiquen objetos espec√≠ficos en im√°genes.

## üéØ Objetivo

Implementar detecci√≥n de objetos que identifique y localice objetos espec√≠ficos.

## ‚úÖ Criterios de Aceptaci√≥n

### 1. Endpoint Backend
- Ruta POST /api/vision/detect-objects
- M√©todo detectObjects en visionController.js

### 2. Integraci√≥n Azure
- POST a endpoint Object Detection
- Procesamiento JSON con objetos detectados

### 3. Extracci√≥n Objetos
- Lista con nombre, confianza, bounding box
- Filtrado por confianza
- Agrupaci√≥n por tipo

### 4. Frontend
- Componente ObjectDetectionQuestionCreator.jsx
- Visualizaci√≥n con bounding boxes
- Hover interactivo
- Filtro por confianza

### 5. Generaci√≥n Preguntas
- Preguntas de identificaci√≥n
- Preguntas de conteo
- Pre-llenado formulario

### 6. Documentaci√≥n
- Endpoint en Swagger
- Ejemplos visuales

## üìä Estimaci√≥n: 10 Story Points
## üéØ Prioridad: Media
## üìÖ Fecha: 21 Noviembre 2025
## üîß Tecnolog√≠as: Azure Object Detection, Node.js, React, Canvas
EOF
)" \
            "Prioridad: Media,Backend,IA/ML" \
            "Sprint Visi√≥n Computacional - Semana 2 (20-24 Nov 2025)"
      
      - name: Crear Ramas y Vincularlas a las Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          MAIN_BRANCH_SHA=$(git rev-parse main)
          gh issue list --state open --json number,title | jq -c '.[]' | while read issue; do
            ISSUE_NUMBER=$(echo $issue | jq -r '.number')
            ISSUE_TITLE=$(echo $issue | jq -r '.title')
            BRANCH_TITLE=$(echo "$ISSUE_TITLE" | iconv -t ascii//TRANSLIT | sed -E 's/\[(BE|FE)\] //g' | sed -E 's/HU-VC[0-9]+: //g' | sed -E 's/[^a-zA-Z0-9]+/-/g' | sed -E 's/^-+|-+$//g' | tr '[:upper:]' '[:lower:]')
            BRANCH_NAME="feature/hu-vc-${ISSUE_NUMBER}-${BRANCH_TITLE}"

            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "La rama '$BRANCH_NAME' ya existe."
            else
              echo "Creando rama '$BRANCH_NAME'..."
              gh api repos/${{ github.repository }}/git/refs --method POST -f ref="refs/heads/${BRANCH_NAME}" -f sha="$MAIN_BRANCH_SHA"
              gh issue comment $ISSUE_NUMBER --body "üåø Rama creada: \`$BRANCH_NAME\`

### üìù Instrucciones:

\`\`\`bash
git fetch origin
git checkout $BRANCH_NAME
git commit -m \"feat(vision): descripci√≥n\"
git push origin $BRANCH_NAME
\`\`\`"
            fi
          done
