
name: üöÄ Crear Backlog y Sprints del Proyecto

on:
  workflow_dispatch: # Permite ejecutar este workflow manualmente desde la pesta√±a Actions

# Define el token con permisos de escritura
permissions:
  contents: read
  issues: write
  # Es necesario a√±adir permisos para 'pull-requests: write' para que pueda crear etiquetas
  pull-requests: write

jobs:
  setup-project-backlog:
    runs-on: ubuntu-latest
    steps:
      # PASO 1: Descarga el c√≥digo del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # PASO 2: Crea las Etiquetas de Prioridad si no existen
      - name: Crear Etiquetas de Prioridad si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creando etiquetas de prioridad..."
          gh label create "Prioridad: Alta" --color "D93F0B" --description "Esta tarea es cr√≠tica y bloquea otras." || echo "La etiqueta 'Prioridad: Alta' ya existe."
          gh label create "Prioridad: Media" --color "FBCA04" --description "Tarea importante pero no urgente." || echo "La etiqueta 'Prioridad: Media' ya existe."
          gh label create "Prioridad: Baja" --color "0E8A16" --description "Tarea menor o mejora deseable." || echo "La etiqueta 'Prioridad: Baja' ya existe."
      
      # PASO 3: Crea los Milestones (Sprints) solo si no existen
      - name: Crear Milestones si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # --- Sprint Backend ---
          MILESTONE_BE_TITLE="Sprint Backend (7-15 Octubre)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_BE_TITLE\")" | grep -qF "$MILESTONE_BE_TITLE"; then
            echo "Milestone '$MILESTONE_BE_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_BE_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_BE_TITLE" \
              -f description='Infraestructura completa. Todas las APIs y funcionalidades de backend deben estar listas.' \
              -f due_on='2024-10-15T23:59:59Z'
          fi

          # --- Sprint Frontend ---
          MILESTONE_FE_TITLE="Sprint Frontend (16-21 Octubre)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_FE_TITLE\")" | grep -qF "$MILESTONE_FE_TITLE"; then
            echo "Milestone '$MILESTONE_FE_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_FE_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_FE_TITLE" \
              -f description='Implementaci√≥n de UI/UX usando las APIs del backend ya terminadas.' \
              -f due_on='2024-10-21T23:59:59Z'
          fi

      # PASO 4: Crea todos los Issues solo si no existen
      - name: Crear Issues si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Funci√≥n para crear un issue solo si no existe un t√≠tulo id√©ntico
          create_issue_if_not_exists() {
            local title="$1"
            local body="$2"
            local label="$3"
            local milestone="$4"
            
            if gh issue list --state all --search "in:title \"$title\"" --json title | grep -qF "$title"; then
              echo "Issue '$title' ya existe. Omitiendo."
            else
              echo "Creando issue '$title'..."
              gh issue create --title "$title" --body "$body" --label "$label" --milestone "$milestone"
            fi
          }

          # ===============================================
          # ==         ISSUES SPRINT BACKEND             ==
          # ===============================================

          create_issue_if_not_exists \
            "[BE] US1: Registro de preferencia de accesibilidad" \
            "**Como** un nuevo jugador,
          **Quiero** poder indicar durante el registro si tengo dificultades visuales,
          **Para que** el juego pueda activar autom√°ticamente las funcionalidades de accesibilidad para m√≠.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El formulario de registro debe incluir un checkbox o toggle con la etiqueta \"Tengo dificultades visuales\".
          - ‚úÖ El backend debe poder almacenar esta preferencia en el documento del usuario en Firebase (ej. \`visualDifficulty: boolean\`).
          - ‚úÖ El valor por defecto para esta preferencia debe ser \`false\` si el usuario no lo marca." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          create_issue_if_not_exists \
            "[BE] US5: Almacenamiento del historial de interacciones de voz" \
            "**Como** usuario del modo de voz,
          **Quiero** que mis interacciones de voz se almacenen en un historial,
          **Para que** pueda revisar mi actividad y los administradores puedan analizar patrones de uso.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El backend debe registrar cada interacci√≥n de voz exitosa en una nueva colecci√≥n de Firebase (ej. \`voiceInteractions\`).
          - ‚úÖ Cada registro debe incluir el \`userId\`, \`questionId\`, la respuesta dada, el timestamp y la duraci√≥n.
          - ‚úÖ Se debe crear un endpoint API seguro (\`GET /api/voice-interactions/:userId\`) para que los usuarios puedan recuperar su propio historial." \
            "Prioridad: Media" \
            "Sprint Backend (7-15 Octubre)"

          create_issue_if_not_exists \
            "[BE] US7: Configuraci√≥n administrativa de accesibilidad" \
            "**Como** administrador de la plataforma,
          **Quiero** tener un panel para configurar los ajustes de accesibilidad y monitorear su uso,
          **Para que** pueda gestionar la funcionalidad y entender su adopci√≥n.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El panel de administraci√≥n debe tener una nueva secci√≥n para \"Ajustes de Accesibilidad\".
          - ‚úÖ Los administradores deben poder habilitar o deshabilitar globalmente el modo de voz.
          - ‚úÖ El backend debe proporcionar un endpoint que devuelva estad√≠sticas agregadas." \
            "Prioridad: Baja" \
            "Sprint Backend (7-15 Octubre)"

          create_issue_if_not_exists \
            "[BE] US8: Compatibilidad WebSocket con modo de voz" \
            "**Como** desarrollador del backend,
          **Quiero** asegurar que el modo de voz se integre sin problemas con el sistema de juego multijugador,
          **Para que** la funcionalidad de accesibilidad no interrumpa ni degrade la experiencia de juego en tiempo real.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El servidor de WebSocket debe ser capaz de recibir y procesar eventos relacionados con el modo de voz (ej. \`voiceResponse\`).
          - ‚úÖ Las pruebas de estr√©s deben confirmar que el rendimiento del servidor WebSocket no se degrada." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          create_issue_if_not_exists \
            "[BE] US9: Procesamiento y validaci√≥n de respuestas por voz" \
            "**Como** usuario del modo de voz,
          **Quiero** que el sistema procese y valide mis respuestas habladas,
          **Para que** pueda participar en el juego usando solo mi voz.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ Se debe crear un nuevo endpoint en el backend (\`POST /api/voice-responses/validate\`).
          - ‚úÖ El backend debe implementar una l√≥gica para validar la respuesta contra la respuesta correcta.
          - ‚úÖ La interacci√≥n debe registrarse en el historial de interacciones de voz." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          # ===============================================
          # ==         ISSUES SPRINT FRONTEND            ==
          # ===============================================

          create_issue_if_not_exists \
            "[FE] US2: Activaci√≥n autom√°tica del modo de voz" \
            "**Como** un usuario con dificultades visuales,
          **Quiero** que el modo de voz se active autom√°ticamente cuando inicio sesi√≥n,
          **Para que** no tenga que buscar y activar la opci√≥n manualmente.
          
          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ Al iniciar sesi√≥n, el frontend debe verificar la preferencia \`visualDifficulty\` del usuario.
          - ‚úÖ Si es \`true\`, el modo de voz debe activarse autom√°ticamente.
          - ‚úÖ El usuario debe poder deshabilitar manualmente el modo de voz si lo desea." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"

          create_issue_if_not_exists \
            "[FE] US3: Lectura de preguntas mediante Text-to-Speech (TTS)" \
            "**Como** usuario del modo de voz,
          **Quiero** que el sistema lea en voz alta las preguntas y las opciones de respuesta,
          **Para que** pueda entender el contenido del juego sin necesidad de verlo.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ Cuando se muestra una nueva pregunta, el texto y las opciones deben ser le√≠dos autom√°ticamente usando la Web Speech API.
          - ‚úÖ El usuario debe poder pausar y reanudar la lectura de audio." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"

          create_issue_if_not_exists \
            "[FE] US4: Configuraci√≥n de ajustes de voz" \
            "**Como** usuario del modo de voz,
          **Quiero** poder configurar los ajustes de la voz (tipo, velocidad y volumen),
          **Para que** pueda personalizar la experiencia de audio a mi gusto.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ Debe haber un panel de ajustes de accesibilidad.
          - ‚úÖ El usuario debe poder elegir entre las voces disponibles en su navegador.
          - ‚úÖ El usuario debe poder ajustar la velocidad y el volumen de la voz.
          - ‚úÖ Los ajustes deben guardarse en el \`localStorage\`." \
            "Prioridad: Media" \
            "Sprint Frontend (16-21 Octubre)"

          create_issue_if_not_exists \
            "[FE] US6: Sistema de tutorial de audio" \
            "**Como** un nuevo usuario con dificultades visuales,
          **Quiero** recibir un tutorial de audio que me gu√≠e a trav√©s de las funcionalidades,
          **Para que** pueda aprender a jugar sin asistencia visual.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El tutorial de audio debe ofrecerse autom√°ticamente a los nuevos usuarios con la opci√≥n activada.
          - ‚úÖ El tutorial debe cubrir c√≥mo navegar, c√≥mo se leen las preguntas y c√≥mo responder por voz.
          - ‚úÖ El usuario debe poder omitir el tutorial." \
            "Prioridad: Media" \
            "Sprint Frontend (16-21 Octubre)"
          
          create_issue_if_not_exists \
            "[FE] US9: Reconocimiento de respuestas por voz" \
            "**Como** usuario del modo de voz,
          **Quiero** poder responder a las preguntas usando comandos de voz,
          **Para que** pueda participar plenamente en el juego sin usar el mouse o el teclado.

          ---
          ### **Criterios de Aceptaci√≥n:**
          - ‚úÖ El sistema debe usar la Web Speech API para escuchar y transcribir los comandos de voz.
          - ‚úÖ Debe reconocer respuestas clave como \"A\", \"B\", \"C\", \"D\", \"Primera opci√≥n\", etc.
          - ‚úÖ Debe haber una retroalimentaci√≥n visual y auditiva para confirmar que la respuesta fue recibida.
          - ‚úÖ La respuesta debe enviarse al backend para su validaci√≥n." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"
