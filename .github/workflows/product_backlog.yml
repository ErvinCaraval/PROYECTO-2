name: ğŸš€ Crear Backlog y Sprints del Proyecto

on:
  workflow_dispatch: # Permite ejecutar este workflow manualmente desde la pestaÃ±a Actions

# Define el token con permisos de escritura
permissions:
  contents: write # âš ï¸ Se cambiÃ³ a 'write' para poder crear ramas
  issues: write
  # Es necesario aÃ±adir permisos para 'pull-requests: write' para que pueda crear etiquetas
  pull-requests: write

# âš ï¸ MODIFICACIÃ“N AÃ‘ADIDA: Define el nÃºmero de tu proyecto para que las issues se asignen a Ã©l.
env:
  PROJECT_NUMBER: 1 # <-- Revisa que este sea el nÃºmero correcto de tu proyecto.

jobs:
  setup-project-backlog:
    runs-on: ubuntu-latest
    steps:
      # PASO 1: Descarga el cÃ³digo del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # PASO 2: Crea las Etiquetas de Prioridad si no existen
      - name: Crear Etiquetas de Prioridad si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creando etiquetas de prioridad..."
          gh label create "Prioridad: Alta" --color "D93F0B" --description "Esta tarea es crÃ­tica y bloquea otras." || echo "La etiqueta 'Prioridad: Alta' ya existe."
          gh label create "Prioridad: Media" --color "FBCA04" --description "Tarea importante pero no urgente." || echo "La etiqueta 'Prioridad: Media' ya existe."
          gh label create "Prioridad: Baja" --color "0E8A16" --description "Tarea menor o mejora deseable." || echo "La etiqueta 'Prioridad: Baja' ya existe."
      
      # PASO 3: Crea los Milestones (Sprints) solo si no existen
      - name: Crear Milestones si no existen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # --- Sprint Backend ---
          MILESTONE_BE_TITLE="Sprint Backend (7-15 Octubre)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_BE_TITLE\")" | grep -qF "$MILESTONE_BE_TITLE"; then
            echo "Milestone '$MILESTONE_BE_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_BE_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_BE_TITLE" \
              -f description='Infraestructura completa. Todas las APIs y funcionalidades de backend deben estar listas.' \
              -f due_on='2025-10-15T23:59:59Z'
          fi

          # --- Sprint Frontend ---
          MILESTONE_FE_TITLE="Sprint Frontend (16-21 Octubre)"
          if gh api /repos/${GH_REPO}/milestones --paginate -q ".[] | select(.title == \"$MILESTONE_FE_TITLE\")" | grep -qF "$MILESTONE_FE_TITLE"; then
            echo "Milestone '$MILESTONE_FE_TITLE' ya existe. Omitiendo."
          else
            echo "Creando milestone '$MILESTONE_FE_TITLE'..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${GH_REPO}/milestones" \
              -f title="$MILESTONE_FE_TITLE" \
              -f description='ImplementaciÃ³n de UI/UX usando las APIs del backend ya terminadas.' \
              -f due_on='2025-10-21T23:59:59Z'
          fi

      # PASO 4: Crea todos los Issues, los aÃ±ade al proyecto y solo si no existen
      - name: Crear Issues y aÃ±adirlas al Proyecto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # La funciÃ³n ahora tambiÃ©n aÃ±ade la issue al proyecto.
          create_and_add_to_project() {
            local title="$1"
            local body="$2"
            local label="$3"
            local milestone="$4"
            
            ISSUE_URL=$(gh issue list --state all --search "in:title \"$title\"" --json url -q ".[0].url")

            if [ -n "$ISSUE_URL" ]; then
              echo "Issue '$title' ya existe. Omitiendo creaciÃ³n."
            else
              echo "Creando issue '$title'..."
              ISSUE_URL=$(gh issue create --title "$title" --body "$body" --label "$label" --milestone "$milestone")
            fi

            if [ -n "$ISSUE_URL" ]; then
                echo "AÃ±adiendo issue $ISSUE_URL al proyecto ${{ env.PROJECT_NUMBER }}..."
                PROJECT_ID=$(gh project view ${{ env.PROJECT_NUMBER }} --owner "@me" --format json | jq -r '.id')
                CONTENT_ID=$(gh issue view $ISSUE_URL --json id | jq -r '.id')
                
                gh api graphql -f query='
                  mutation($project:ID!, $content:ID!) {
                    addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                      item { id }
                    }
                  }' -f project="$PROJECT_ID" -f content="$CONTENT_ID" || echo "Fallo al aÃ±adir la issue al proyecto. Puede que ya estuviera aÃ±adida."
            fi
          }

          # ===============================================
          # ==         ISSUES SPRINT BACKEND             ==
          # ===============================================

          create_and_add_to_project \
            "[BE] US1: Registro de preferencia de accesibilidad" \
            "**Como** un nuevo jugador,
          **Quiero** poder indicar durante el registro si tengo dificultades visuales,
          **Para que** el juego pueda activar automÃ¡ticamente las funcionalidades de accesibilidad para mÃ­.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El formulario de registro debe incluir un checkbox o toggle con la etiqueta \"Tengo dificultades visuales\".
          - âœ… El backend debe poder almacenar esta preferencia en el documento del usuario en Firebase (ej. \`visualDifficulty: boolean\`).
          - âœ… El valor por defecto para esta preferencia debe ser \`false\` si el usuario no lo marca." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          create_and_add_to_project \
            "[BE] US5: Almacenamiento del historial de interacciones de voz" \
            "**Como** usuario del modo de voz,
          **Quiero** que mis interacciones de voz se almacenen en un historial,
          **Para que** pueda revisar mi actividad y los administradores puedan analizar patrones de uso.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El backend debe registrar cada interacciÃ³n de voz exitosa en una nueva colecciÃ³n de Firebase (ej. \`voiceInteractions\`).
          - âœ… Cada registro debe incluir el \`userId\`, \`questionId\`, la respuesta dada, el timestamp y la duraciÃ³n.
          - âœ… Se debe crear un endpoint API seguro (\`GET /api/voice-interactions/:userId\`) para que los usuarios puedan recuperar su propio historial." \
            "Prioridad: Media" \
            "Sprint Backend (7-15 Octubre)"

          create_and_add_to_project \
            "[BE] US7: ConfiguraciÃ³n administrativa de accesibilidad" \
            "**Como** administrador de la plataforma,
          **Quiero** tener un panel para configurar los ajustes de accesibilidad y monitorear su uso,
          **Para que** pueda gestionar la funcionalidad y entender su adopciÃ³n.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El panel de administraciÃ³n debe tener una nueva secciÃ³n para \"Ajustes de Accesibilidad\".
          - âœ… Los administradores deben poder habilitar o deshabilitar globalmente el modo de voz.
          - âœ… El backend debe proporcionar un endpoint que devuelva estadÃ­sticas agregadas." \
            "Prioridad: Baja" \
            "Sprint Backend (7-15 Octubre)"

          create_and_add_to_project \
            "[BE] US8: Compatibilidad WebSocket con modo de voz" \
            "**Como** desarrollador del backend,
          **Quiero** asegurar que el modo de voz se integre sin problemas con el sistema de juego multijugador,
          **Para que** la funcionalidad de accesibilidad no interrumpa ni degrade la experiencia de juego en tiempo real.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El servidor de WebSocket debe ser capaz de recibir y procesar eventos relacionados con el modo de voz (ej. \`voiceResponse\`).
          - âœ… Las pruebas de estrÃ©s deben confirmar que el rendimiento del servidor WebSocket no se degrada." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          create_and_add_to_project \
            "[BE] US9: Procesamiento y validaciÃ³n de respuestas por voz" \
            "**Como** usuario del modo de voz,
          **Quiero** que el sistema procese y valide mis respuestas habladas,
          **Para que** pueda participar en el juego usando solo mi voz.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… Se debe crear un nuevo endpoint en el backend (\`POST /api/voice-responses/validate\`).
          - âœ… El backend debe implementar una lÃ³gica para validar la respuesta contra la respuesta correcta.
          - âœ… La interacciÃ³n debe registrarse en el historial de interacciones de voz." \
            "Prioridad: Alta" \
            "Sprint Backend (7-15 Octubre)"

          # ===============================================
          # ==         ISSUES SPRINT FRONTEND            ==
          # ===============================================

          create_and_add_to_project \
            "[FE] US2: ActivaciÃ³n automÃ¡tica del modo de voz" \
            "**Como** un usuario con dificultades visuales,
          **Quiero** que el modo de voz se active automÃ¡ticamente cuando inicio sesiÃ³n,
          **Para que** no tenga que buscar y activar la opciÃ³n manualmente.
          
          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… Al iniciar sesiÃ³n, el frontend debe verificar la preferencia \`visualDifficulty\` del usuario.
          - âœ… Si es \`true\`, el modo de voz debe activarse automÃ¡ticamente.
          - âœ… El usuario debe poder deshabilitar manualmente el modo de voz si lo desea." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"

          create_and_add_to_project \
            "[FE] US3: Lectura de preguntas mediante Text-to-Speech (TTS)" \
            "**Como** usuario del modo de voz,
          **Quiero** que el sistema lea en voz alta las preguntas y las opciones de respuesta,
          **Para que** pueda entender el contenido del juego sin necesidad de verlo.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… Cuando se muestra una nueva pregunta, el texto y las opciones deben ser leÃ­dos automÃ¡ticamente usando la Web Speech API.
          - âœ… El usuario debe poder pausar y reanudar la lectura de audio." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"

          create_and_add_to_project \
            "[FE] US4: ConfiguraciÃ³n de ajustes de voz" \
            "**Como** usuario del modo de voz,
          **Quiero** poder configurar los ajustes de la voz (tipo, velocidad y volumen),
          **Para que** pueda personalizar la experiencia de audio a mi gusto.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… Debe haber un panel de ajustes de accesibilidad.
          - âœ… El usuario debe poder elegir entre las voces disponibles en su navegador.
          - âœ… El usuario debe poder ajustar la velocidad y el volumen de la voz.
          - âœ… Los ajustes deben guardarse en el \`localStorage\`." \
            "Prioridad: Media" \
            "Sprint Frontend (16-21 Octubre)"

          create_and_add_to_project \
            "[FE] US6: Sistema de tutorial de audio" \
            "**Como** un nuevo usuario con dificultades visuales,
          **Quiero** recibir un tutorial de audio que me guÃ­e a travÃ©s de las funcionalidades,
          **Para que** pueda aprender a jugar sin asistencia visual.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El tutorial de audio debe ofrecerse automÃ¡ticamente a los nuevos usuarios con la opciÃ³n activada.
          - âœ… El tutorial debe cubrir cÃ³mo navegar, cÃ³mo se leen las preguntas y cÃ³mo responder por voz.
          - âœ… El usuario debe poder omitir el tutorial." \
            "Prioridad: Media" \
            "Sprint Frontend (16-21 Octubre)"
          
          create_and_add_to_project \
            "[FE] US9: Reconocimiento de respuestas por voz" \
            "**Como** usuario del modo de voz,
          **Quiero** poder responder a las preguntas usando comandos de voz,
          **Para que** pueda participar plenamente en el juego sin usar el mouse o el teclado.

          ---
          ### **Criterios de AceptaciÃ³n:**
          - âœ… El sistema debe usar la Web Speech API para escuchar y transcribir los comandos de voz.
          - âœ… Debe reconocer respuestas clave como \"A\", \"B\", \"C\", \"D\", \"Primera opciÃ³n\", etc.
          - âœ… Debe haber una retroalimentaciÃ³n visual y auditiva para confirmar que la respuesta fue recibida.
          - âœ… La respuesta debe enviarse al backend para su validaciÃ³n." \
            "Prioridad: Alta" \
            "Sprint Frontend (16-21 Octubre)"

      # âš ï¸ PASO 5 AÃ‘ADIDO: Crea una rama por cada Issue que no la tenga
      - name: Crear Ramas para Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Obtiene el SHA de la Ãºltima versiÃ³n de la rama 'main'
          MAIN_BRANCH_SHA=$(git rev-parse main)

          # Itera sobre todas las issues abiertas
          gh issue list --state open --json number,title | jq -c '.[]' | while read issue; do
            ISSUE_NUMBER=$(echo $issue | jq -r '.number')
            ISSUE_TITLE=$(echo $issue | jq -r '.title')

            # Limpia el tÃ­tulo para crear un nombre de rama vÃ¡lido
            # Convierte a minÃºsculas, reemplaza espacios con guiones, elimina caracteres especiales.
            BRANCH_TITLE=$(echo "$ISSUE_TITLE" | iconv -t ascii//TRANSLIT | sed -E 's/\[(BE|FE)\] //g' | sed -E 's/[^a-zA-Z0-9]+/-/g' | sed -E 's/^-+\|-+$//g' | tr '[:upper:]' '[:lower:]')
            
            # Construye el nombre final de la rama
            BRANCH_NAME="hu-${ISSUE_NUMBER}-${BRANCH_TITLE}"

            # Revisa si la rama ya existe en el repositorio remoto
            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "La rama '$BRANCH_NAME' ya existe. Omitiendo."
            else
              echo "Creando rama '$BRANCH_NAME'..."
              # Crea la rama en el repositorio remoto directamente desde el Ãºltimo commit de 'main'
              gh api repos/${{ github.repository }}/git/refs \
                --method POST \
                -f ref="refs/heads/${BRANCH_NAME}" \
                -f sha="$MAIN_BRANCH_SHA"
            fi
          done
