import{a as U,u as q,r as d,j as e}from"./index-Hu8ytDjz.js";import{B as m}from"./Button-B1jkMoj_.js";import{A as I}from"./Alert-BJY2_q9k.js";import{S as D}from"./LoadingOverlay-DOICkFUH.js";const _=({topics:E,onQuestionExtracted:F,onCancel:N})=>{const{isVoiceModeEnabled:r,speak:s}=U(),{user:J}=q(),[v,y]=d.useState(null),[w,R]=d.useState(E[0]||""),[x,C]=d.useState(null),[M,P]=d.useState(null),[g,b]=d.useState(!1),[z,o]=d.useState(""),[O,h]=d.useState(""),[l,f]=d.useState(null),[H,K]=d.useState({pregunta:"",opciones:{a:"",b:"",c:"",d:""}}),[j,S]=d.useState(0),[u,T]=d.useState([]),$=d.useRef(null),Q="http://localhost:5000/api",L=a=>{const t=a.target.files?.[0];if(!t)return;if(!["image/jpeg","image/png","image/jpg"].includes(t.type)){o("Por favor selecciona una imagen (PNG, JPG, JPEG)");return}if(t.size>10*1024*1024){o("La imagen es demasiado grande. M√°ximo 10MB");return}C(t),o("");const n=new FileReader;n.onload=i=>{P(i.target.result)},n.readAsDataURL(t),r&&s(`Imagen seleccionada: ${t.name}. Presiona procesar para extraer la pregunta.`,{force:!0})},B=async()=>{if(!x){o("Por favor selecciona o captura una imagen");return}b(!0),o(""),h("");try{const a=new FileReader;a.onload=async t=>{const n=t.target.result;try{const c=await(await fetch(`${Q}/ocr/process-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageBase64:n,mimeType:x.type||"image/jpeg",language:"es"})})).json();if(c.success){const p=c.pregunta&&!c.pregunta.includes("no detectada"),G=Object.values(c.opciones||{}).filter(A=>A&&!A.includes("no detectada"));!p||G.length===0?(f({pregunta:c.pregunta||"",opciones:c.opciones||{a:"",b:"",c:"",d:""}}),h("‚ö†Ô∏è Detecci√≥n parcial. Por favor completa los campos vac√≠os manualmente."),r&&s("Extracci√≥n parcial. Por favor completa la pregunta y las opciones manualmente.",{force:!0})):(f({pregunta:c.pregunta,opciones:c.opciones}),h("‚úÖ Pregunta extra√≠da correctamente"),r&&s(`Pregunta detectada: ${c.pregunta}`,{force:!0}))}else o(c.error||"Error procesando la imagen")}catch(i){o(`Error al procesar la imagen: ${i.message}`)}finally{b(!1)}},a.readAsDataURL(x)}catch(a){o(`Error: ${a.message}`),b(!1)}},V=async()=>{const a=l.pregunta?.trim(),t=l.opciones,n=[t.a?.trim()||"",t.b?.trim()||"",t.c?.trim()||"",t.d?.trim()||""].filter(p=>p),i=n.length>=2;if(!a){o("Por favor escribe la pregunta");return}if(!i){o("Por favor completa al menos 2 opciones de respuesta");return}if(!w){o("Por favor selecciona un tema");return}if(j<0||j>=n.length){o("Por favor selecciona cu√°l opci√≥n es correcta");return}b(!0),o("");const c={text:a,options:n,correctAnswerIndex:j,category:w,explanation:""};try{F&&(await F(c),h("‚úÖ Pregunta guardada exitosamente"),T([...u,c]),setTimeout(()=>{C(null),P(null),f(null),y(null),S(0),h("")},2e3))}catch(p){o(`Error al guardar la pregunta: ${p.message}`)}finally{b(!1)}},k=()=>{C(null),P(null),f(null),y(null),S(0),stopCamera(),o(""),h("")};return d.useEffect(()=>{r&&!v&&!x&&s("Formulario de captura de pregunta. Selecciona una imagen o toma una foto.",{force:!0})},[r,v,x]),e.jsxs("div",{className:"grid gap-4 p-4",children:[r&&e.jsx("div",{className:"flex justify-end mb-3 -mt-1",children:e.jsx(m,{variant:"outline",size:"sm",type:"button",onClick:async()=>{await s("Captura de pregunta. Puedes subir una imagen o tomar una foto desde la c√°mara. La aplicaci√≥n extraer√° autom√°ticamente el texto y las opciones.",{force:!0})},"aria-label":"Explicar la p√°gina",children:"üõà Explicar p√°gina"})}),z&&e.jsx(I,{intent:"error",children:z}),O&&e.jsx(I,{intent:"success",children:O}),u.length>0&&!l&&e.jsxs("div",{className:"p-3 bg-gradient-to-r from-green-500/20 to-green-500/10 rounded-lg border border-green-400/30",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-semibold text-white",children:["‚úÖ ",u.length," pregunta",u.length!==1?"s":""," guardada",u.length!==1?"s":""]}),e.jsx("p",{className:"text-xs text-green-300 mt-1",children:"üí° Puedes agregar m√°s o finalizar"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"secondary",size:"sm",onClick:()=>y("upload"),onFocus:()=>r&&s("Subir otra imagen",{force:!0}),onMouseEnter:()=>r&&s("Subir otra imagen",{force:!0}),children:"üì∑ Otra imagen"}),e.jsx(m,{variant:"secondary",size:"sm",onClick:N,onFocus:()=>r&&s("Finalizar y cerrar",{force:!0}),onMouseEnter:()=>r&&s("Finalizar y cerrar",{force:!0}),children:"‚úì Finalizar"})]})]}),!v&&!x&&!l&&e.jsxs("div",{className:"grid gap-3",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Crear pregunta"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-3",children:e.jsx(m,{onClick:()=>y("upload"),size:"lg",onFocus:()=>r&&s("Subir imagen",{force:!0}),onMouseEnter:()=>r&&s("Subir imagen",{force:!0}),children:"üì± Subir imagen"})})]}),v==="upload"&&!l&&e.jsxs("div",{className:"grid gap-3",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Subir imagen"}),e.jsx("input",{ref:$,type:"file",accept:"image/jpeg,image/png,image/jpg",onChange:L,className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white"})]}),x&&!l&&e.jsxs("div",{className:"grid gap-3",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Vista previa"}),M&&e.jsx("img",{src:M,alt:"Preview",className:"w-full max-h-96 rounded-xl object-contain border-2 border-white/10"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(m,{onClick:B,disabled:g,size:"lg",onFocus:()=>r&&s("Procesar imagen",{force:!0}),onMouseEnter:()=>r&&s("Procesar imagen",{force:!0}),children:g?e.jsx(D,{size:"sm"}):"‚ö° Procesar"}),e.jsx(m,{variant:"secondary",onClick:k,disabled:g,onFocus:()=>r&&s("Seleccionar otra imagen",{force:!0}),onMouseEnter:()=>r&&s("Seleccionar otra imagen",{force:!0}),children:"Cambiar imagen"})]})]}),l&&e.jsxs("div",{className:"grid gap-6",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-br from-bb-primary/20 to-bb-primary/10 rounded-xl border-2 border-bb-primary/40",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"üìù Pregunta extra√≠da"}),e.jsx("p",{className:"text-xs text-white/70",children:"Completa los campos para guardar tu pregunta"})]}),!l.pregunta||l.pregunta.includes("Pregunta no detectada")?e.jsx("div",{className:"p-3 bg-orange-500/10 border border-orange-400/30 rounded-lg",children:e.jsxs("p",{className:"text-sm text-orange-300",children:["‚ö†Ô∏è ",e.jsx("strong",{children:"Importante:"})," OCR no detect√≥ la pregunta correctamente. Por favor completa los campos manualmente."]})}):null,e.jsxs("div",{className:"grid gap-2.5",children:[e.jsx("label",{className:"text-sm font-semibold text-white",children:"Tema"}),e.jsx("select",{value:w,onChange:a=>R(a.target.value),className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none transition",children:E.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"grid gap-2.5",children:[e.jsx("label",{className:"text-sm font-semibold text-white",children:"Pregunta"}),e.jsx("textarea",{value:l.pregunta||"",placeholder:"Escribe la pregunta aqu√≠...",className:"w-full p-4 rounded-xl bg-white/5 border-2 border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-bb-primary/30 focus:border-bb-primary resize-none transition text-base",rows:"4",onChange:a=>{f(t=>({...t,pregunta:a.target.value}))}})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-semibold text-white",children:"Opciones de respuesta"}),e.jsx("span",{className:"text-xs text-white/60",children:"M√≠nimo 2 opciones"})]}),e.jsx("div",{className:"grid gap-4 p-5 bg-white/5 rounded-lg border border-white/10",children:["a","b","c","d"].map((a,t)=>{const n=l.opciones[a],i=!n||n.trim()===""||n.includes("no detectada");return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-bold text-bb-primary text-lg min-w-[2.5rem]",children:[a.toUpperCase(),")"]}),e.jsx("input",{type:"text",value:n&&!n.includes("no detectada")?n:"",placeholder:i?"Opci√≥n opcional":"",className:`flex-1 p-3 rounded-lg bg-white/5 border text-white text-sm focus:outline-none focus:ring-2 transition ${i?"border-orange-400/50 focus:ring-orange-400/30":"border-white/10 focus:ring-bb-primary/30 focus:border-bb-primary"}`,onChange:c=>{f(p=>({...p,opciones:{...p.opciones,[a]:c.target.value}}))}}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx("input",{type:"radio",name:"correctOption",checked:j===t,onChange:()=>S(t),disabled:g||i,className:"h-5 w-5 cursor-pointer accent-bb-primary",title:i?"Completa esta opci√≥n para seleccionar":"Respuesta correcta"})})]},a)})}),["a","b","c","d"].some(a=>{const t=l.opciones[a];return!t||t.trim()===""||t.includes("no detectada")})&&e.jsxs("p",{className:"text-xs text-orange-300 flex items-center gap-1",children:[e.jsx("span",{children:"‚ö†Ô∏è"})," Los campos destacados en naranja no fueron detectados. Ed√≠talos manualmente."]})]}),e.jsxs("div",{className:"grid gap-3 p-5 bg-bb-primary/15 rounded-lg border border-bb-primary/40",children:[e.jsxs("label",{className:"text-sm font-semibold text-white flex items-center gap-2",children:[e.jsx("span",{children:"‚úì Respuesta Correcta"}),e.jsx("span",{className:"text-xs font-normal text-white/60",children:"(Selecciona arriba)"})]}),e.jsx("div",{className:"text-sm text-white/80",children:(()=>{const n=["a","b","c","d"][j],i=l.opciones[n];return i&&!i.includes("no detectada")?`${n.toUpperCase()}) ${i}`:"Selecciona una opci√≥n v√°lida"})()})]}),e.jsxs("p",{className:"text-xs text-white/60 flex items-center gap-2 p-2 bg-white/5 rounded-lg",children:[e.jsx("span",{children:"‚ÑπÔ∏è"}),e.jsx("span",{children:"Puedes editar todos los campos. Aseg√∫rate de que todo sea correcto antes de guardar."})]}),u.length>0&&e.jsxs("div",{className:"p-3 bg-gradient-to-r from-green-500/20 to-green-500/10 rounded-lg border border-green-400/30",children:[e.jsxs("p",{className:"text-sm font-semibold text-white",children:["‚úÖ ",u.length," pregunta",u.length!==1?"s":""," guardada",u.length!==1?"s":""]}),e.jsx("p",{className:"text-xs text-green-300 mt-1",children:"üí° Puedes guardar esta y agregar m√°s, o finalizar"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:grid-cols-3 md:flex md:gap-3 pt-2",children:[e.jsx(m,{onClick:V,disabled:g,onFocus:()=>r&&s("Confirmar y guardar la pregunta",{force:!0}),onMouseEnter:()=>r&&s("Confirmar y guardar la pregunta",{force:!0}),children:g?"‚è≥ Guardando‚Ä¶":"‚úîÔ∏è Confirmar"}),e.jsx(m,{variant:"secondary",onClick:k,disabled:g,onFocus:()=>r&&s("Cargar otra imagen",{force:!0}),onMouseEnter:()=>r&&s("Cargar otra imagen",{force:!0}),children:"üì∑ Otra imagen"}),u.length>0&&e.jsx(m,{variant:"secondary",onClick:N,disabled:g,onFocus:()=>r&&s("Finalizar y cerrar",{force:!0}),onMouseEnter:()=>r&&s("Finalizar y cerrar",{force:!0}),children:"‚úì Finalizar"}),u.length===0&&e.jsx(m,{variant:"secondary",onClick:N,disabled:g,onFocus:()=>r&&s("Volver atr√°s",{force:!0}),onMouseEnter:()=>r&&s("Volver atr√°s",{force:!0}),children:"‚Üê Atr√°s"})]})]})]})};export{_ as O};
//# sourceMappingURL=OCRQuestionCapture-tYTHYRD8.js.map
