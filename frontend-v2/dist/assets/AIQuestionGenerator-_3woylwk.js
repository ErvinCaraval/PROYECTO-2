import{a as H,u as K,r,j as e}from"./index-BOaVjrce.js";import{B as v}from"./Button-D2tu_0bI.js";import{I as V}from"./Input-Cm1bFLR1.js";import{A as _}from"./Alert-BchDzBqE.js";import{f as re,a as se}from"./api-BirJDgAi.js";import{A as ne}from"./Skeleton-Onp4HXDJ.js";import{m as U}from"./socket-CnHv-2vf.js";import{L as oe,S as ie}from"./LoadingOverlay-rVvsqzvW.js";const le=({topics:h,onQuestionCreated:T,onCancel:o})=>{const{isVoiceModeEnabled:s,speak:i}=H(),{user:y}=K(),[d,g]=r.useState({question:"",options:["","","",""],correctIndex:0,selectedTopic:h[0]||""}),[q,k]=r.useState(""),[j,C]=r.useState(!1),[M,x]=r.useState(""),F=(a,c)=>{g(l=>({...l,options:l.options.map((b,N)=>N===a?c:b)}))},w=r.useCallback(()=>d.question.trim()?d.options.some(a=>!a.trim())?"Todas las opciones son requeridas":"":"La pregunta es requerida",[d]);r.useEffect(()=>{const a=w();k(a)},[d,y,w]);const P=async a=>{a.preventDefault();const c=w();if(c){k(c);return}C(!0),k(""),x("");try{const l={text:d.question,options:d.options,correctAnswerIndex:d.correctIndex,category:d.selectedTopic,explanation:""};if(x("Guardando..."),T){const b=await Promise.resolve(T(l)),N=b&&b.text?b.text:l.text;x(`Pregunta creada: "${N}"`)}else x("Â¡Pregunta preparada!")}catch(l){console.error("Error al preparar la pregunta:",l),k(l.message||"Error al guardar la pregunta")}finally{C(!1)}};return e.jsxs("form",{className:"grid gap-4",onSubmit:P,children:[s&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(v,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const a=[];a.push("Formulario para escribir preguntas manualmente."),a.push("Campo Tema: selecciona el tema de la pregunta."),a.push("Campo Pregunta: escribe el texto de la pregunta."),a.push("Opciones: escribe las posibles respuestas. Marca cuÃ¡l es la correcta con el botÃ³n de opciÃ³n."),a.push("BotÃ³n AtrÃ¡s: vuelve al generador de preguntas."),a.push("BotÃ³n Guardar: guarda la pregunta actual."),await i(a.join(" "),{action:"page_guide",questionId:"manual_question_form",force:!0})},"aria-label":"Explicar la pÃ¡gina",children:"ðŸ›ˆ Explicar pÃ¡gina"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Escribe tu pregunta"}),q&&e.jsx(_,{intent:"error",children:q}),M&&e.jsx(_,{intent:"success",children:M}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/80",htmlFor:"topic-select",children:"Tema"}),e.jsx("select",{id:"topic-select",value:d.selectedTopic,onChange:a=>g(c=>({...c,selectedTopic:a.target.value})),disabled:j,className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",children:h.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/80",htmlFor:"question-input",children:"Pregunta"}),e.jsx(V,{id:"question-input",type:"text",value:d.question,onChange:a=>g(c=>({...c,question:a.target.value})),disabled:j,required:!0})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm text-white/80",children:"Opciones"}),e.jsx("div",{className:"grid gap-3",children:d.options.map((a,c)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{type:"text",value:a,onChange:l=>F(c,l.target.value),disabled:j,required:!0,placeholder:`OpciÃ³n ${c+1}`,className:"flex-1"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"radio",name:"correctOption",checked:d.correctIndex===c,onChange:()=>g(l=>({...l,correctIndex:c})),disabled:j,className:"h-4 w-4"}),e.jsx("span",{children:"Correcta"})]})]},c))})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:o,disabled:j,onFocus:()=>s&&i("AtrÃ¡s: vuelve al generador de preguntas.",{force:!0}),onMouseEnter:()=>s&&i("AtrÃ¡s: vuelve al generador de preguntas.",{force:!0}),children:"AtrÃ¡s"}),e.jsx(v,{type:"submit",disabled:j,onFocus:()=>s&&i("Guardar: guarda la pregunta actual.",{force:!0}),onMouseEnter:()=>s&&i("Guardar: guarda la pregunta actual.",{force:!0}),children:j?"Guardandoâ€¦":"Guardar"})]})]})};function ce({open:h,title:T,onClose:o,children:s,className:i=""}){return r.useEffect(()=>{const y=g=>{g.key==="Escape"&&(o==null||o())};h&&document.addEventListener("keydown",y);const d=document.body.style.overflow;return h&&(document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",y),document.body.style.overflow=d}},[h,o]),e.jsx(ne,{children:h&&e.jsxs(U.div,{className:"fixed inset-0 z-[3000] flex items-center justify-center px-4 py-8",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("button",{"aria-label":"Cerrar",className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:o}),e.jsxs(U.div,{role:"dialog","aria-modal":"true",className:`relative w-full max-w-2xl max-h-[85vh] overflow-auto rounded-2xl border border-white/10 bg-bb-bg-primary/90 shadow-xl ${i}`,initial:{scale:.98,y:10,opacity:0},animate:{scale:1,y:0,opacity:1},exit:{scale:.98,y:10,opacity:0},transition:{type:"spring",stiffness:200,damping:22},children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 px-6 py-5 border-b border-white/10 bg-bb-bg-primary/90",children:[T?e.jsx("h2",{className:"text-xl md:text-2xl font-bold",children:T}):e.jsx("span",{className:"sr-only",children:"Modal"}),e.jsx("button",{onClick:o,className:"rounded-md p-2 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-bb-primary","aria-label":"Cerrar",children:"âœ•"})]}),e.jsx("div",{className:"px-6 py-5",children:s})]})]})})}const ye=({onQuestionsGenerated:h,onClose:T})=>{const{isVoiceModeEnabled:o,speak:s}=H(),{user:i}=K(),[y,d]=r.useState([]),[g,q]=r.useState(""),[k,j]=r.useState("medium"),[C,M]=r.useState(null),[x,F]=r.useState(""),[w,P]=r.useState(!1),[a,c]=r.useState(!1),[l,b]=r.useState(null),[N,O]=r.useState(""),[X,G]=r.useState(0),[J,Q]=r.useState([]),[R,Y]=r.useState(""),[B,S]=r.useState(!1),[W,p]=r.useState(""),[ue,z]=r.useState(""),[de,Z]=r.useState([]);r.useEffect(()=>{ee(),te()},[]),r.useEffect(()=>{F(typeof C=="number"?String(C):"")},[C]),r.useEffect(()=>{O(typeof l=="number"?String(l):"")},[l]);const ee=async()=>{try{const t=await re();d(t),t.length>0&&q(t[0])}catch{p("Error obteniendo temas. Por favor intenta de nuevo.")}},te=async()=>{try{const t=await se();Z(t)}catch{p("No se pudieron cargar los niveles de dificultad. Por favor, intenta de nuevo mÃ¡s tarde.")}},ae=async()=>{if(!g){p("Por favor selecciona un tema vÃ¡lido");return}S(!0),p("");try{const t="http://localhost:5000",n=i&&i.getIdToken?await i.getIdToken():null,I=await(await fetch(`${t}/api/ai/generate-questions`,{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:`Bearer ${n}`}:{}},body:JSON.stringify({topic:g,difficulty:k,count:C,useAI:w})})).json();if(I.success){const $=I.questions.map(u=>({...(()=>{if(!Array.isArray(u.options)||typeof u.correctAnswerIndex!="number")return u;const f=u.options.map((m,L)=>({opt:m,origIdx:L}));for(let m=f.length-1;m>0;m--){const L=Math.floor(Math.random()*(m+1));[f[m],f[L]]=[f[L],f[m]]}const A=f.findIndex(m=>m.origIdx===u.correctAnswerIndex);return{...u,options:f.map(m=>m.opt),correctAnswerIndex:A}})(),createdBy:(i==null?void 0:i.uid)||"anon",createdAt:Date.now(),category:g,difficulty:k}));let D=!1;try{const u=i&&i.getIdToken?await i.getIdToken():null,A=await(await fetch(`${t}/api/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",...u?{Authorization:`Bearer ${u}`}:{}},body:JSON.stringify({questions:$})})).json();A.success?D=!0:(p(m=>(m?m+" | ":"")+(A.error||"Error guardando preguntas en Firestore")),p("No se pudieron guardar las preguntas. "+(A.error||"Por favor, intenta de nuevo.")))}catch{p("OcurriÃ³ un error al guardar las preguntas. Por favor, verifica tu conexiÃ³n e intenta de nuevo.")}if(!D){S(!1);return}h(I.questions),S(!1)}else p(I.error||"Error generando preguntas"),p("No se pudieron generar las preguntas: "+(I.error||"Por favor, intenta de nuevo."))}catch{p("Error de conexiÃ³n. Por favor, verifica tu conexiÃ³n a internet e intenta nuevamente.")}finally{S(!1)}};return e.jsxs(ce,{open:!0,title:"ðŸ¤– Generador de Preguntas",onClose:T,children:[o&&!a&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(v,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const t=[];!a&&!w?(t.push("EstÃ¡s en el generador de preguntas."),t.push("BotÃ³n Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial."),t.push("BotÃ³n Escribir preguntas: te permite escribir preguntas manualmente."),t.push("Selecciona una opciÃ³n para continuar.")):w&&!a&&(t.push("Formulario para generar preguntas con inteligencia artificial."),t.push("Campo Tema: selecciona el tema de las preguntas."),t.push("Campo Dificultad: elige la dificultad."),t.push("Campo Cantidad: indica cuÃ¡ntas preguntas quieres generar."),t.push("BotÃ³n Crear preguntas: genera las preguntas."),t.push("BotÃ³n AtrÃ¡s: vuelve a la pantalla anterior.")),await s(t.join(" "),{action:"page_guide",questionId:"ai_question_generator",force:!0})},"aria-label":"Explicar la pÃ¡gina",onFocus:()=>s("Explicar pÃ¡gina: describe la funciÃ³n de cada botÃ³n y campo en esta vista.",{force:!0}),onMouseEnter:()=>s("Explicar pÃ¡gina: describe la funciÃ³n de cada botÃ³n y campo en esta vista.",{force:!0}),children:"ðŸ›ˆ Explicar pÃ¡gina"})}),B&&e.jsx(oe,{text:"Generandoâ€¦",mobileOnly:!0}),!a&&!w&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx(v,{onClick:()=>P(!0),size:"lg",onFocus:()=>o&&s("Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial.",{force:!0}),onMouseEnter:()=>o&&s("Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial.",{force:!0}),children:"Crear con IA"}),e.jsx(v,{variant:"secondary",size:"lg",onClick:()=>{c(!0),P(!1),G(0),Q([])},onFocus:()=>o&&s("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),onMouseEnter:()=>o&&s("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),children:"Escribir preguntas"})]}),w&&!a&&e.jsxs("form",{className:"mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4",onSubmit:async t=>{t.preventDefault(),S(!0),p("");try{await ae(),p("")}catch{p("Error al generar preguntas. Por favor, intÃ©ntalo de nuevo.")}finally{S(!1)}},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"topic",className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{id:"topic",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:g,onChange:t=>q(t.target.value),disabled:y.length===0,children:y.length===0?e.jsx("option",{value:"",children:"No hay temas"}):y.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"difficulty",className:"block mb-1 text-sm text-white/80",children:"Dificultad"}),e.jsxs("select",{id:"difficulty",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:k,onChange:t=>j(t.target.value),children:[e.jsx("option",{value:"easy",children:"FÃ¡cil"}),e.jsx("option",{value:"medium",children:"Media"}),e.jsx("option",{value:"hard",children:"DifÃ­cil"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"numQuestions",className:"block mb-1 text-sm text-white/80",children:"Cantidad"}),e.jsxs("div",{children:[e.jsx(V,{id:"numQuestions",type:"text",inputMode:"numeric",pattern:"[0-9]*",value:x,onChange:t=>{const n=t.target.value.replace(/\D+/g,"");F(n);const E=n?parseInt(n,10):NaN;Number.isNaN(E)?M(null):M(E)},onBlur:()=>{const t=parseInt(x||"",10);if(Number.isNaN(t)||t<1){M(null),F("");return}const n=Math.max(1,t);M(n),F(String(n))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(x===""||C===null)&&e.jsx("div",{className:`mt-1 text-xs ${x===""?"text-white/60":"text-red-300"}`,children:x===""?"Ingresa un nÃºmero (>= 1)":"Valor invÃ¡lido"})]})]}),W&&e.jsx(_,{intent:"error",className:"sm:col-span-3",children:W}),e.jsxs("div",{className:"sm:col-span-3 mt-2 flex flex-wrap gap-3 justify-end items-center",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:()=>P(!1),disabled:B,onFocus:()=>o&&s("AtrÃ¡s: vuelve a la pantalla anterior.",{force:!0}),onMouseEnter:()=>o&&s("AtrÃ¡s: vuelve a la pantalla anterior.",{force:!0}),children:"AtrÃ¡s"}),e.jsx(v,{type:"submit",disabled:B,onFocus:()=>o&&s("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),onMouseEnter:()=>o&&s("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),children:B?e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:16,className:"mr-2"}),"Creandoâ€¦"]}):"Crear preguntas"})]})]}),a&&e.jsx("div",{className:"mt-2",children:X===0?e.jsxs("form",{className:"grid grid-cols-1 gap-4",onSubmit:t=>{t.preventDefault(),G(1),Q([]),Y(g)},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{value:g,onChange:t=>q(t.target.value),className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",children:y.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"Â¿CuÃ¡ntas preguntas?"}),e.jsxs("div",{children:[e.jsx(V,{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:N,onChange:t=>{const n=t.target.value.replace(/\D+/g,"");O(n);const E=n?parseInt(n,10):NaN;Number.isNaN(E)?b(null):b(E)},onBlur:()=>{const t=parseInt(N||"",10);if(Number.isNaN(t)||t<1){b(null),O("");return}const n=Math.max(1,t);b(n),O(String(n))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(N===""||l===null)&&e.jsx("div",{className:`mt-1 text-xs ${N===""?"text-white/60":"text-red-300"}`,children:N===""?"Ingresa un nÃºmero (>= 1)":"Valor invÃ¡lido"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:()=>c(!1),onFocus:()=>o&&s("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),onMouseEnter:()=>o&&s("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),children:"Volver"}),e.jsx(v,{type:"submit",onFocus:()=>o&&s("Empezar: inicia la creaciÃ³n manual de preguntas.",{force:!0}),onMouseEnter:()=>o&&s("Empezar: inicia la creaciÃ³n manual de preguntas.",{force:!0}),children:"Empezar"})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"text-center mb-3 font-bold",children:["Â¡Vamos! Pregunta ",J.length+1," de ",l]}),e.jsx(le,{topics:[R],onQuestionCreated:async t=>{try{S(!0),p("");const n="http://localhost:5000";if(!i||!i.getIdToken)throw new Error("Debes iniciar sesiÃ³n para crear preguntas");const E=await i.getIdToken(),I=await fetch(`${n}/api/questions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E}`},body:JSON.stringify(t)}),$=await I.json();if(!I.ok)throw new Error($.error||"Error al guardar la pregunta");const D=$.question||{...t},u=[...J,{...D,category:R}];if(u.length===l){const f=await fetch(`${n}/api/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E}`},body:JSON.stringify({questions:u})}),A=await f.json();if(!f.ok)throw new Error(A.error||"Error al guardar las preguntas en lote");return h&&h(u),z("Â¡Todas las preguntas han sido guardadas exitosamente!"),setTimeout(()=>{c(!1),z("")},1500),u}else return Q(u),G(f=>f+1),z(`Â¡Pregunta ${u.length} de ${l} guardada exitosamente!`),setTimeout(()=>z(""),1500),D}catch(n){p("No se pudo guardar la pregunta: "+(n.message||"Por favor, intenta de nuevo."))}finally{S(!1)}},onCancel:()=>{c(!1)}})]})})]})};export{ye as default};
//# sourceMappingURL=AIQuestionGenerator-_3woylwk.js.map
