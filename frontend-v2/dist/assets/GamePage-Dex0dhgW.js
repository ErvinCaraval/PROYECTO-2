import{a as F,r as a,j as e,u as X,c as ae,b as ne}from"./index-CGdjcbgg.js";import{m as J,g as G}from"./socket-DMrvrCBC.js";import{B as Y}from"./Button-BVl7jPIk.js";import{f as oe}from"./api-DoyG0mL_.js";import{R as ie}from"./Ranking-DK9MMbM_.js";import{C as O,a as K,b as ce}from"./Card-DGvGZJ_T.js";import{A as W}from"./Alert-CiOSpG0n.js";class le{constructor(){this.isRecording=!1,this.mediaRecorder=null,this.audioChunks=[],this.apiBase="http://localhost:5000/api",this.stream=null}isAvailable(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}isListening(){return this.isRecording}async start(){if(!this.isAvailable())throw new Error("La grabaciÃ³n de audio no estÃ¡ soportada en este navegador.");if(this.isRecording){console.warn("AssemblyAI: La grabaciÃ³n ya estÃ¡ en progreso.");return}try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.stream),this.audioChunks=[],this.mediaRecorder.ondataavailable=d=>{this.audioChunks.push(d.data)},this.mediaRecorder.onstart=()=>{this.isRecording=!0,console.log("AssemblyAI: GrabaciÃ³n iniciada.")},this.mediaRecorder.start()}catch(d){throw console.error("AssemblyAI: Error al iniciar la grabaciÃ³n:",d),new Error("No se pudo acceder al micrÃ³fono. Por favor, verifica los permisos.")}}stop(){return new Promise((d,t)=>{if(!this.mediaRecorder||!this.isRecording)return t("No hay ninguna grabaciÃ³n en progreso.");this.mediaRecorder.onstop=async()=>{this.isRecording=!1,console.log("AssemblyAI: GrabaciÃ³n detenida.");const r=new Blob(this.audioChunks,{type:"audio/webm"}),o=new FileReader;o.onloadend=async()=>{const i=o.result.split(",")[1];try{console.log("AssemblyAI: Enviando audio al backend para transcripciÃ³n (voice-interactions)..."),console.log("ðŸš€ Enviando peticiÃ³n al backend...");const n=await oe(`${this.apiBase}/voice-interactions/process-audio`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audioBase64:i,mimeType:"audio/webm"})});console.log("ðŸ“¦ Respuesta completa del backend:",n),n.success?(console.log("AssemblyAI: TranscripciÃ³n recibida:",n.text),d({transcript:n.text||"",audioBase64:i,audioMimeType:"audio/webm",assemblyAIResult:{success:!0,text:n.text,confidence:n.confidence,language:n.language}})):(console.error("AssemblyAI: Error en la transcripciÃ³n:",n.error),t(new Error(n.error||"Error en el servidor al transcribir el audio.")))}catch(n){console.error("AssemblyAI: Error al enviar el audio al backend:",n),t(new Error("No se pudo conectar con el servidor para la transcripciÃ³n."))}},o.onerror=i=>{console.error("AssemblyAI: Error al convertir el audio a Base64:",i),t(new Error("Hubo un problema al procesar el audio grabado."))},o.readAsDataURL(r)},this.mediaRecorder.stop(),this.stream&&(this.stream.getTracks().forEach(r=>r.stop()),this.stream=null)})}async recognizeAnswer(d=[]){return this.isListening()?this.stop():(await this.start(),{isListening:!0})}matchAnswer(d,t){if(!t||t.length===0)return{option:d,index:-1,isValid:!1};let r=d.toLowerCase().trim().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"");try{r=r.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}catch{}r=r.replace(/\bah\b/gi,"a").replace(/\beh\b/gi,"e").replace(/\bbe\b/gi,"b").replace(/\bce\b/gi,"c").replace(/\bde\b/gi,"d"),console.log("ðŸ§¹ Transcript limpio para matching:",r);const o=r.match(/(?:\bopcion\b\s*)?([a-d])(?:\b|$)/);if(o){const n=o[1].toUpperCase(),s=n.charCodeAt(0)-65;if(s>=0&&s<t.length)return console.log("ðŸ“Œ Detectada letra de opciÃ³n:",n,"Ã­ndice:",s),{option:t[s],index:s,isValid:!0}}const i=[/primera|primero|uno|1/,/segunda|segundo|dos|2/,/tercera|tercero|tres|3/,/cuarta|cuarto|cuatro|4/];for(let n=0;n<i.length&&n<t.length;n++)if(i[n].test(r))return{option:t[n],index:n,isValid:!0};for(let n=0;n<t.length;n++){const s=t[n].toLowerCase(),h=s.normalize?s.normalize("NFD").replace(/[\u0300-\u036f]/g,""):s;if(r.includes(h))return{option:t[n],index:n,isValid:!0}}return{option:d,index:-1,isValid:!1}}}const U=new le,de=({options:f,onAnswer:d,disabled:t=!1})=>{const{isVoiceModeEnabled:r}=F(),[o,i]=a.useState(!1),[n,s]=a.useState(!1),[h,g]=a.useState(""),[j,w]=a.useState(""),I=a.useRef(!1),N=()=>{I.current=!1,i(!1),s(!1)};if(!r||!U.isAvailable())return null;const b=async()=>{if(!(t||o||n)){I.current=!0,g(""),w("");try{if(!await navigator.mediaDevices.getUserMedia({audio:!0}))throw N(),new Error("Se requiere permiso para usar el micrÃ³fono.");await U.start(),i(!0)}catch(p){console.error("Error starting recording:",p),N(),g(p.message||"No se pudo iniciar la grabaciÃ³n.")}}},R=async()=>{if(I.current&&o){N(),g(""),s(!0);try{console.log("ðŸŽ¤ Deteniendo grabaciÃ³n y enviando audio...");const p=await U.stop();console.log("ðŸ“ Resultado recibido:",p);const{transcript:Q,audioBase64:q,audioMimeType:V,assemblyAIResult:_}=p;if(!Q)throw new Error("No se detectÃ³ ninguna voz.");w(`Transcrito: "${Q}"`),console.log("ðŸ” Intentando matchear respuesta:",Q);const y=U.matchAnswer(Q,f);console.log("âœ¨ Resultado del match:",y),y.isValid?(console.log("âœ… Respuesta vÃ¡lida, llamando onAnswer con Ã­ndice:",y.index),d(y.index,q,_,V),w(`âœ… Respuesta reconocida: ${f[y.index]}`)):(console.log("âŒ No se pudo matchear la respuesta"),g("No pude entender tu respuesta. IntÃ©ntalo de nuevo."))}catch(p){console.error("Error stopping recording or processing:",p),g(p.message||"Error al procesar el audio.")}finally{s(!1)}}},M={onMouseDown:b,onMouseUp:R,onMouseLeave:R,onTouchStart:b,onTouchEnd:R};let E="ðŸŽ¤ MantÃ©n presionado para hablar",$="ðŸŽ¤ MantÃ©n",A="primary",S=!1;return o?(E="ðŸŽ¤ Escuchando...",$="ðŸŽ¤ Escuchando",A="secondary",S=!0):n&&(E="ðŸ”„ Procesando...",$="ðŸ”„ Procesando",A="secondary",S=!0),e.jsxs("div",{className:"space-y-2 w-full",children:[e.jsx(Y,{...M,disabled:t||!r,variant:A,className:`w-full touch-none ${S?"animate-pulse":""}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[o&&e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"hidden sm:inline",children:E}),e.jsx("span",{className:"inline sm:hidden",children:$})]})}),j&&e.jsx("div",{className:"text-sm text-green-500 bg-green-500/10 border border-green-500/30 rounded p-2 text-center font-semibold animate-fade-in",children:j}),h&&e.jsx("div",{className:"text-sm text-red-400 bg-red-500/20 p-2 rounded text-center font-semibold",children:h})]})};function ue({text:f,question:d,options:t,onSelect:r,selected:o,showResult:i=!1,correctIndex:n=null}){const s=typeof f=="string"&&f.length>0?f:d,{isVoiceModeEnabled:h,speak:g,stopSpeaking:j,isVoiceAvailable:w,voiceInteractionsService:I}=F(),{user:N}=X(),b=N||typeof window<"u"&&window.__USER__||null,R=d&&(d.id||d.questionId)||"general",[M,E]=a.useState(!1),[$,A]=a.useState(!1),[S,p]=a.useState(""),[Q,q]=a.useState(!1),[V,_]=a.useState("");a.useEffect(()=>{A(!1)},[s,t]),a.useEffect(()=>{h&&s&&Array.isArray(t)&&t.length>0&&!$&&!i&&y().catch(u=>{p("No se pudo leer la pregunta automÃ¡ticamente. Usa el botÃ³n para escuchar.")})},[h,s,t,$,i]);const y=async()=>{if(!(!h||!s)){E(!0),A(!0),p("");try{let u=`Pregunta: ${s}`;Array.isArray(t)&&t.length>0&&t.forEach((x,B)=>{u+=`. OpciÃ³n ${String.fromCharCode(65+B)}: ${x}`}),await g(u)}catch(u){p("No se pudo leer la pregunta automÃ¡ticamente. Usa el botÃ³n para escuchar."),console.error("Error reading question:",u)}finally{E(!1)}}},L=async u=>{if(!(!h||!t[u]))try{await g(`OpciÃ³n ${String.fromCharCode(65+u)}: ${t[u]}`)}catch(x){console.error("Error reading option:",x)}},z=u=>i?u===n?"border-emerald-400/60 bg-emerald-500/10":o===u&&u!==n?"border-red-400/60 bg-red-500/10":"border-white/15 bg-white/5":o===u?"border-bb-primary bg-white/10":"border-white/20 bg-white/5 hover:bg-white/10";return e.jsxs("div",{className:"w-full flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"w-full max-w-xl mx-auto bg-white/10 border border-white/20 rounded-2xl shadow-lg p-6 mb-6 flex flex-col items-center",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold leading-snug break-words text-center mb-2",children:s}),h&&e.jsxs("div",{className:"w-full flex flex-col items-center gap-2 mt-2",children:[e.jsx(Y,{variant:"secondary",size:"md",onClick:y,title:"Leer pregunta y opciones",className:"px-3 py-2 text-base",disabled:M,children:"ðŸ”Š Leer pregunta y opciones"}),S&&e.jsx("div",{className:"text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded p-2 text-center font-semibold",children:S}),!w&&e.jsx("div",{className:"text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded p-2 text-center font-semibold",children:"La sÃ­ntesis de voz no estÃ¡ disponible en tu navegador."}),w&&!i&&e.jsx(de,{options:t,onAnswer:async(u,x,B,l)=>{I&&b&&R&&await I.logVoiceAnswer(b.uid,R,t[u],void 0,t[u],u,void 0,x,B,l),j(),q(!1),_(""),r(u)},disabled:o!==null})]})]}),e.jsx(J.div,{role:"group","aria-label":"Opciones de respuesta",className:"grid grid-cols-1 sm:grid-cols-2 gap-2 w-full max-w-2xl mx-auto",initial:"hidden",animate:"show",variants:{hidden:{},show:{transition:{staggerChildren:.04}}},children:t.map((u,x)=>e.jsxs(J.button,{onClick:()=>r(x),disabled:o!==null,initial:{opacity:0,y:10},animate:{opacity:1,y:0},whileHover:{scale:o===null?1.01:1},whileTap:{scale:o===null?.99:1},transition:{type:"spring",stiffness:160,damping:14},className:`col-span-1 text-left w-full rounded-xl border px-4 py-3 text-sm md:text-base transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-bb-primary break-words ${z(x)}`,"aria-pressed":o===x,onFocus:()=>{h&&!M&&L(x)},children:[e.jsx("span",{className:"mr-2 inline-flex h-6 w-6 items-center justify-center rounded-md bg-white/10 text-sm font-semibold",children:String.fromCharCode(65+x)}),e.jsx("span",{className:"align-middle",children:u})]},x))}),V&&e.jsx("div",{className:"p-3 bg-red-500/10 border border-red-500/20 rounded-lg mt-4 max-w-xl mx-auto",children:e.jsx("p",{className:"text-sm text-red-400",children:V})})]})}function me({seconds:f=20,onEnd:d,onTick:t}){const[r,o]=a.useState(f),i=a.useRef(),n=a.useRef(d),s=a.useRef(t);a.useEffect(()=>{n.current=d},[d]),a.useEffect(()=>{s.current=t},[t]),a.useEffect(()=>(o(f),i.current&&clearInterval(i.current),f>0&&(i.current=setInterval(()=>{o(g=>{const j=g-1;return j<=0&&(i.current&&clearInterval(i.current),n.current&&n.current()),j})},1e3)),()=>{i.current&&clearInterval(i.current)}),[f]),a.useEffect(()=>{s.current&&s.current(r)},[r]),a.useEffect(()=>()=>{i.current&&clearInterval(i.current)},[]);const h=()=>r<=3?"text-red-300 border-red-400/40":r<=6?"text-amber-300 border-amber-400/40":"text-white border-white/20";return e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`mx-auto flex h-14 w-14 items-center justify-center rounded-full border-4 font-extrabold ${h()}`,children:r}),e.jsx("span",{className:"mt-1 block text-xs text-white/70",children:"segundos restantes"})]})}function ye(){const[f,d]=a.useState(!1),{gameId:t}=ae(),{user:r}=X(),{isVoiceModeEnabled:o,speak:i,voiceInteractionsService:n}=F(),[s,h]=a.useState(null),[g,j]=a.useState(0),[w,I]=a.useState(0),N=a.useRef(w);a.useEffect(()=>{N.current=w},[w]);const[b,R]=a.useState(null),M=a.useRef(b);a.useEffect(()=>{M.current=b},[b]);const[E,$]=a.useState([]),[A,S]=a.useState(!1),[p,Q]=a.useState(null),[q,V]=a.useState(0),[,_]=a.useState(10),y=ne();a.useEffect(()=>((async()=>{const m=await G();r&&t&&(m.emit("requestQuestion",{gameId:t}),console.log("[GamePage] Emitiendo requestQuestion:",{gameId:t}))})(),setTimeout(()=>{s||d(!0)},5e3),r?((async()=>{const m=await G();m.connected||(console.log("[GamePage] Intentando conectar socket..."),m.connect());function T(){console.log("[GamePage] Socket conectado:",m.id)}function D({question:c,index:v,timeout:C}){if(console.log("[GamePage] Evento newQuestion recibido:",c),Array.isArray(c.options)||(c.options=[]),h({...c,options:[...c.options]}),j(v),R(null),S(!1),_(typeof C=="number"?C:o?120:10),V(k=>k+1),o&&r&&c&&Array.isArray(c.options)&&c.options.length>0&&c.text){const k=N.current||"?";let H=`Pregunta ${v+1} de ${k}. ${c.text}`;c.options.forEach((se,re)=>{H+=`. OpciÃ³n ${String.fromCharCode(65+re)}: ${se}`}),i(H,{action:"new_question_full",questionId:c.id||`question_${v}`,metadata:{questionIndex:v,totalQuestions:k,gameId:t}})}}function Z({correctAnswerIndex:c,explanation:v,players:C}){if(console.log("[GamePage] Evento answerResult recibido:",{correctAnswerIndex:c,explanation:v,players:C}),S(!0),Q({correctAnswerIndex:c,explanation:v}),$(C),o&&r){const P=M.current;P!==null&&typeof c=="number"&&i(P===c?"Â¡Respuesta correcta!":"Respuesta incorrecta.",{action:"answer_result",questionId:s?.id||`question_${g}`,metadata:{isCorrect:P===c,selectedIndex:P,correctIndex:c,explanation:v}})}}function ee({players:c}){if(console.log("[GamePage] Evento gameFinished recibido:",c),o&&r){const v=c.find(k=>k.uid===r.uid),C=c.findIndex(k=>k.uid===r.uid)+1,P=c.length;i(`Â¡Juego terminado! Obtuviste el puesto ${C} de ${P} jugadores.`,{action:"game_finished",questionId:"game",metadata:{position:C,totalPlayers:P,score:v?.score||0}})}y(`/summary/${t}`,{state:{players:c}})}function te({questionsCount:c}){console.log("[GamePage] Evento gameStarted recibido:",c),I(c),o&&r&&i(`Â¡Juego iniciado! TendrÃ¡s ${c} preguntas para responder.`,{action:"game_started",questionId:"game",metadata:{questionsCount:c,gameId:t}}),(async()=>((await G()).emit("requestQuestion",{gameId:t}),console.log("[GamePage] Solicitud de primera pregunta tras gameStarted:",{gameId:t})))()}m.on("connect",T),m.on("newQuestion",D),m.on("answerResult",Z),m.on("gameFinished",ee),m.on("gameStarted",te)})(),()=>{(async()=>{const m=await G();m.off("connect"),m.off("newQuestion"),m.off("answerResult"),m.off("gameFinished"),m.off("gameStarted")})()}):void 0),[r,t,y]),a.useEffect(()=>{if(o&&r&&s&&Array.isArray(s.options)&&s.options.length>0&&s.text){const l=N.current||"?";let m=`Pregunta ${g+1} de ${l}. ${s.text}`;s.options.forEach((T,D)=>{m+=`. OpciÃ³n ${String.fromCharCode(65+D)}: ${T}`}),i(m,{action:"new_question_full",questionId:s.id||`question_${g}`,metadata:{questionIndex:g,totalQuestions:l,gameId:t}})}},[g,s,o,r,i,t]);const L=a.useRef(s);L.current=s;const z=a.useCallback(l=>{if(b!==null)return;R(l);const m=L.current&&Array.isArray(L.current.options)?L.current.options[l]:void 0;(async()=>(await G()).emit("submitAnswer",{gameId:t,uid:r.uid,answerIndex:l,answerValue:m}))()},[t,r,b]),u=a.useCallback(()=>{b===null&&(async()=>(await G()).emit("submitAnswer",{gameId:t,uid:r.uid,answerIndex:null,answerValue:null}))()},[t,r,b]),x=a.useCallback(l=>{o&&r&&l<=3&&l>0&&i(`Â¡AtenciÃ³n! Te quedan ${l} segundos para responder.`,{action:"timer_warning",questionId:s?.id||`question_${g}`,metadata:{timeLeft:l}})},[o,r,s,g,i]),B=()=>[...E].sort((T,D)=>D.score-T.score).findIndex(T=>T.uid===r.uid)+1;return e.jsxs("div",{className:"container min-h-screen px-4 py-4 md:py-6 grid gap-4 md:gap-6 lg:grid-cols-[2fr_1fr]",children:[e.jsxs("header",{className:"flex items-start md:items-end justify-between gap-3 md:gap-4 lg:col-span-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold",children:"ðŸŽ¯ Juego de Preguntas"}),e.jsxs("div",{className:"mt-2 flex items-center gap-3 md:gap-4",children:[e.jsxs("span",{className:"text-xs md:text-sm text-white/80 whitespace-nowrap",children:["Pregunta ",g+1," de ",w||"?"]}),e.jsx("div",{className:"h-2 w-32 md:w-48 rounded-full bg-white/10",children:e.jsx("div",{className:"h-2 rounded-full bg-gradient-to-r from-bb-primary to-bb-accent",style:{width:`${(g+1)/(w||1)*100}%`}})})]})]}),e.jsxs("div",{className:"text-right shrink-0",children:[e.jsxs("div",{className:"text-lg md:text-xl font-bold",children:["#",B()]}),e.jsx("div",{className:"text-[10px] md:text-xs text-white/70",children:"Tu posiciÃ³n"}),o&&e.jsx("button",{className:"mt-2 px-3 py-2 rounded-md text-xs md:text-sm bg-white/10 hover:bg-white/20 border border-white/20",onClick:()=>{const l=[];l.push("EstÃ¡s en la pÃ¡gina de juego de preguntas."),l.push(`Progreso: pregunta ${g+1} de ${w||"desconocido"}.`),l.push("A la izquierda estÃ¡ la tarjeta con la pregunta y las opciones. Usa las teclas o el ratÃ³n para seleccionar tu respuesta."),l.push("A la derecha verÃ¡s el temporizador de la pregunta."),l.push("MÃ¡s abajo, se mostrarÃ¡ si tu respuesta fue correcta y la explicaciÃ³n, cuando estÃ© disponible."),l.push("A la derecha de la pÃ¡gina estÃ¡ el ranking con la puntuaciÃ³n de los jugadores."),i(l.join(" "),{action:"page_guide",questionId:"game",metadata:{gameId:t}})},children:"ðŸ›ˆ Explicar pÃ¡gina"})]})]}),e.jsxs("main",{className:"space-y-4",children:[s&&e.jsx(O,{className:"transition hover:shadow-glow",children:e.jsxs(K,{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 md:gap-4",children:[e.jsx("div",{className:"min-w-0 flex-1",children:e.jsx(ue,{text:s.text,question:s.question,options:s.options,onSelect:z,selected:b,showResult:A,correctIndex:p?.correctAnswerIndex??null})}),e.jsx("div",{className:"shrink-0 pt-1",children:e.jsx(me,{seconds:b===null?typeof timeLeft=="number"?timeLeft:o?120:10:0,onEnd:u,onTick:l=>{_(l),x(l)}},q)})]}),A&&p&&e.jsxs(W,{intent:"info",children:[e.jsx("div",{className:"font-semibold mb-1",children:"âœ… Â¡Respuesta revelada!"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Correcta:"})," ",s.options[p.correctAnswerIndex]]}),p.explanation&&e.jsxs("div",{className:"mt-2 text-white/90",children:[e.jsx("strong",{children:"ExplicaciÃ³n:"})," ",p.explanation]})]})]})}),!s&&!f&&e.jsxs("div",{className:"flex items-center gap-3 text-white/80",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Esperando la siguiente pregunta..."})]}),!s&&f&&e.jsx(W,{intent:"error",children:"No se encontraron preguntas para este tema. Verifica que hayas generado preguntas y que el tema coincida exactamente."})]}),e.jsx("aside",{children:e.jsxs(O,{children:[e.jsx(ce,{className:"pb-2",children:e.jsx("h3",{className:"text-xl md:text-2xl font-semibold",children:"Ranking"})}),e.jsx(K,{children:e.jsx(ie,{players:E})})]})})]})}export{ye as default};
//# sourceMappingURL=GamePage-Dex0dhgW.js.map
