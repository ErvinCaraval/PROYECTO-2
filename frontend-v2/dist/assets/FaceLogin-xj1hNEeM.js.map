{"version":3,"file":"FaceLogin-xj1hNEeM.js","sources":["../../src/pages/FaceLogin.jsx"],"sourcesContent":["import React, { useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { signInWithCustomToken } from 'firebase/auth';\nimport { auth } from '../services/firebase';\nimport Button from '../components/ui/Button';\nimport Input from '../components/ui/Input';\nimport Alert from '../components/ui/Alert';\nimport FaceCaptureCamera from '../components/FaceCaptureCamera';\nimport { optimizeImage, getImageSize } from '../utils/imageOptimizer';\n\nexport default function FaceLogin() {\n  const [email, setEmail] = useState('');\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [capturedImage, setCapturedImage] = useState(null);\n  const [preview, setPreview] = useState(null);\n  const [step, setStep] = useState('email'); // 'email' o 'capture'\n  \n  const navigate = useNavigate();\n\n  const handleCapture = async (base64String) => {\n    try {\n      // Optimizar imagen antes de guardarla\n      const optimized = await optimizeImage(base64String, 300, 300, 0.6);\n      const originalSize = getImageSize(base64String);\n      const optimizedSize = getImageSize(optimized);\n      console.log(`Imagen optimizada: ${originalSize}KB ‚Üí ${optimizedSize}KB (${Math.round((1 - optimizedSize/originalSize) * 100)}% reducci√≥n)`);\n      setCapturedImage(optimized);\n      setPreview(optimized);\n    } catch (error) {\n      console.error('Error optimizando imagen, usando original:', error);\n      setCapturedImage(base64String);\n      setPreview(base64String);\n    }\n  };\n\n  const retakePhoto = () => {\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  const handleEmailSubmit = (e) => {\n    e.preventDefault();\n    if (!email) {\n      setError('Por favor, ingresa tu email');\n      return;\n    }\n    setError('');\n    setStep('capture');\n  };\n\n  const loginWithFace = async () => {\n    if (!capturedImage) {\n      setError('Por favor, captura una foto primero');\n      return;\n    }\n\n    if (!email) {\n      setError('Email requerido');\n      setStep('email');\n      return;\n    }\n\n    setLoading(true);\n    setError('');\n    setSuccess('');\n\n    try {\n      // Obtener URL base de la API\n      const apiBase = import.meta.env.VITE_API_URL || 'http://localhost:5000';\n\n      // Enviar imagen al backend para verificaci√≥n\n      const response = await fetch(`${apiBase}/api/face/login`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          image: capturedImage,\n          email: email\n        })\n      });\n\n      // Verificar que la respuesta sea JSON\n      const contentType = response.headers.get('content-type');\n      if (!contentType || !contentType.includes('application/json')) {\n        const text = await response.text();\n        console.error('Respuesta no es JSON:', text.substring(0, 200));\n        throw new Error(`El servidor devolvi√≥ un error. Verifica que el backend est√© corriendo en ${apiBase}`);\n      }\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Error en el login facial');\n      }\n\n      if (data.success && data.verified) {\n        // Login exitoso - usar el customToken para autenticar\n        if (data.customToken) {\n          await signInWithCustomToken(auth, data.customToken);\n          setSuccess('¬°Login facial exitoso! Redirigiendo...');\n          \n          // Redirigir despu√©s de 1 segundo\n          setTimeout(() => {\n            navigate('/dashboard');\n          }, 1000);\n        } else {\n          throw new Error('No se recibi√≥ token de autenticaci√≥n');\n        }\n      } else {\n        throw new Error(data.error || 'Las caras no coinciden. Acceso denegado.');\n      }\n    } catch (err) {\n      setError(err.message || 'Error al verificar la cara. Por favor, intenta de nuevo.');\n      console.error('Error en login facial:', err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const backToEmail = () => {\n    setStep('email');\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  return (\n    <div className=\"container min-h-screen px-4 py-10\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"text-center mb-6\">\n          <h1 className=\"text-3xl font-extrabold\">üîê Login Facial</h1>\n          <p className=\"text-white/70 mt-2\">\n            Inicia sesi√≥n usando reconocimiento facial\n          </p>\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6\">\n          {error && <Alert intent=\"error\" className=\"mb-4\">{error}</Alert>}\n          {success && <Alert intent=\"success\" className=\"mb-4\">{success}</Alert>}\n\n          {step === 'email' ? (\n            <form onSubmit={handleEmailSubmit} className=\"space-y-4\">\n              <div>\n                <label className=\"block mb-1 text-sm text-white/80\" htmlFor=\"email\">\n                  Correo electr√≥nico\n                </label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"t√∫@correo.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  disabled={loading}\n                />\n              </div>\n\n              <Button type=\"submit\" size=\"lg\" disabled={loading} className=\"w-full\">\n                Continuar con Login Facial\n              </Button>\n            </form>\n          ) : (\n            <div className=\"space-y-4\">\n              {!preview ? (\n                <FaceCaptureCamera\n                  onCapture={handleCapture}\n                  onCancel={backToEmail}\n                  disabled={loading}\n                  buttonText=\"üì∑ Capturar Foto\"\n                  showCancel={true}\n                />\n              ) : (\n                <>\n                  {/* Preview de la foto capturada */}\n                  <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                    <img\n                      src={preview}\n                      alt=\"Foto capturada\"\n                      className=\"w-full h-auto max-h-[480px] mx-auto\"\n                    />\n                  </div>\n\n                  {/* Botones de acci√≥n */}\n                  <div className=\"flex gap-4 justify-center\">\n                    <Button\n                      onClick={retakePhoto}\n                      variant=\"outline\"\n                      disabled={loading}\n                      size=\"lg\"\n                    >\n                      üîÑ Tomar Otra Foto\n                    </Button>\n                    <Button\n                      onClick={loginWithFace}\n                      disabled={loading}\n                      size=\"lg\"\n                    >\n                      {loading ? 'Verificando...' : '‚úÖ Verificar y Login'}\n                    </Button>\n                  </div>\n                </>\n              )}\n            </div>\n          )}\n\n          <div className=\"mt-6 text-center space-y-2\">\n            {step === 'email' && (\n              <Button\n                onClick={() => navigate('/login')}\n                variant=\"ghost\"\n                size=\"sm\"\n              >\n                ‚Üê Volver a Login Normal\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":["FaceLogin","email","setEmail","useState","error","setError","success","setSuccess","loading","setLoading","capturedImage","setCapturedImage","preview","setPreview","step","setStep","navigate","useNavigate","handleCapture","base64String","optimized","optimizeImage","originalSize","getImageSize","optimizedSize","retakePhoto","handleEmailSubmit","e","loginWithFace","apiBase","response","contentType","text","data","signInWithCustomToken","auth","err","backToEmail","jsxs","Alert","jsx","Input","Button","Fragment","FaceCaptureCamera"],"mappings":"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"}