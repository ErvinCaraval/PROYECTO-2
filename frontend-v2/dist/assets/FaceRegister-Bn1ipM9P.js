import{r as c,u as P,b as A,j as e}from"./index-BP-VUWEV.js";import{B as w}from"./Button-C88ZZduS.js";import{A as v}from"./Alert-C6PvCdCu.js";import{F,o as O,g as z}from"./imageOptimizer-B6QFrVqj.js";function V(){const[j,l]=c.useState(""),[y,p]=c.useState(""),[u,h]=c.useState(!1),[k,s]=c.useState(""),[E,f]=c.useState(null),[N,x]=c.useState(null),{user:o}=P(),m=A(),[C,b]=c.useState(!1),R=async a=>{try{s("Optimizando imagen...");const t=await O(a,200,200,.3),i=z(a),n=z(t),r=Math.round((1-n/i)*100);console.log(`âœ“ Imagen optimizada: ${i}KB â†’ ${n}KB (${r}% reducciÃ³n)`),f(t),x(t),s("")}catch(t){console.error("Error optimizando imagen, usando original:",t),f(a),x(a),s("")}},$=()=>{f(null),x(null),l(""),p("")},B=async()=>{if(!E){l("Por favor, captura una foto primero");return}if(!o){l("Debes estar autenticado para registrar tu cara. Redirigiendo al login..."),setTimeout(()=>{m("/login")},2e3);return}h(!0),s("Preparando registro..."),l(""),p("");try{console.log("1. Iniciando registro facial...");let a;try{s("Obteniendo autenticaciÃ³n..."),a=await o.getIdToken(),console.log("2. Token obtenido correctamente")}catch(r){throw console.error("Error obteniendo token:",r),new Error("No se pudo obtener el token de autenticaciÃ³n. Por favor, inicia sesiÃ³n nuevamente.")}const t="http://localhost:5000/api";console.log("3. API URL:",t),console.log("4. TamaÃ±o de imagen:",E.length,"caracteres");const i=new AbortController,n=setTimeout(()=>i.abort(),3e4);try{console.log("5. Enviando peticiÃ³n al backend..."),s("Enviando imagen...");const r=JSON.stringify({image:E,token:a});console.log(`TamaÃ±o del payload: ${(r.length/1024).toFixed(2)}KB`);const d=await fetch(`${t}/face/register`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,"Accept-Encoding":"gzip, deflate"},body:r,signal:i.signal,priority:"high"});clearTimeout(n),console.log("6. Respuesta recibida. Status:",d.status),s("Procesando resultado...");const T=d.headers.get("content-type");if(!T||!T.includes("application/json")){const I=await d.text();throw console.error("Respuesta no es JSON:",I.substring(0,200)),new Error(`El servidor devolviÃ³ un error (${d.status}). Verifica la consola para mÃ¡s detalles.`)}const g=await d.json();if(console.log("7. Datos JSON parseados:",g),!d.ok)throw console.error("Respuesta no OK:",g),new Error(g.error||`Error en el servidor (${d.status})`);if(g.success)console.log("8. Registro facial exitoso!"),p("Â¡Registro facial completado exitosamente!"),s(""),setTimeout(()=>{o?.displayName?m("/dashboard"):m("/complete-profile")},2e3);else throw new Error(g.error||"Error en el registro")}catch(r){throw clearTimeout(n),r.name==="AbortError"?(console.error("Timeout en la peticiÃ³n"),new Error("La peticiÃ³n tardÃ³ demasiado tiempo. Intenta con una imagen mÃ¡s pequeÃ±a.")):r instanceof TypeError?(console.error("Error de conexiÃ³n:",r),new Error(`No se pudo conectar al servidor (${t}). Verifica que estÃ© activo.`)):r}}catch(a){const t=a.message||"Error al registrar la cara. Por favor, intenta de nuevo.";l(t),console.error("Error en registro facial:",a)}finally{h(!1),s("")}};c.useEffect(()=>{(async()=>{if(!o)return b(!1);try{const t=await o.getIdToken(),r=await(await fetch("http://localhost:5000/api/face/exists",{method:"GET",headers:{Authorization:`Bearer ${t}`}})).json();b(!!r.exists)}catch(t){console.error("Error checking face registration:",t)}})()},[o]);const S=async()=>{if(!o){l("Debes estar autenticado para eliminar tu registro facial");return}if(confirm("Â¿EstÃ¡s seguro de eliminar tu registro facial? Esta acciÃ³n no se puede deshacer.")){h(!0);try{const a=await o.getIdToken(),i=await fetch(`http://localhost:5000/api/face/${o.uid}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}}),n=await i.json();if(!i.ok)throw new Error(n.error||"Error eliminando registro facial");p("Registro facial eliminado correctamente"),b(!1),x(null),f(null)}catch(a){l(a.message||"Error eliminando registro facial")}finally{h(!1)}}};return e.jsx("div",{className:"container min-h-screen px-4 py-10",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-extrabold",children:"ğŸ“¸ Registro Facial"}),e.jsx("p",{className:"text-white/70 mt-2",children:o?"Captura una foto de tu rostro para habilitar el login facial":"Paso 2: Captura una foto de tu rostro para completar tu registro"}),!o&&e.jsx("p",{className:"text-white/50 text-sm mt-1",children:"Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6",children:[j&&e.jsx(v,{intent:"error",className:"mb-4",children:j}),y&&e.jsx(v,{intent:"success",className:"mb-4",children:y}),k&&e.jsxs(v,{intent:"info",className:"mb-4",children:["â³ ",k]}),N?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative bg-black rounded-lg overflow-hidden",children:e.jsx("img",{src:N,alt:"Foto capturada",className:"w-full h-auto max-h-[480px] mx-auto"})}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(w,{onClick:$,variant:"outline",disabled:u,size:"lg",children:"ğŸ”„ Tomar Otra Foto"}),e.jsx(w,{onClick:B,disabled:u,size:"lg",children:u?"â³ Registrando...":"âœ… Registrar Cara"})]})]}):e.jsx(F,{onCapture:R,onCancel:()=>m("/dashboard"),disabled:u,buttonText:"ğŸ“· Capturar Foto",showCancel:!0}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(w,{onClick:()=>m("/dashboard"),variant:"ghost",size:"sm",children:"â† Volver al Dashboard"}),C&&e.jsx(w,{onClick:S,variant:"destructive",size:"sm",disabled:u,children:"ğŸ—‘ï¸ Eliminar registro facial"})]})})]})]})})}export{V as default};
//# sourceMappingURL=FaceRegister-Bn1ipM9P.js.map
