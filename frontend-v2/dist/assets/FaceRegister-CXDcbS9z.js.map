{"version":3,"file":"FaceRegister-CXDcbS9z.js","sources":["../../src/pages/FaceRegister.jsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuth } from '../AuthContext';\nimport Button from '../components/ui/Button';\nimport Alert from '../components/ui/Alert';\nimport FaceCaptureCamera from '../components/FaceCaptureCamera';\nimport { optimizeImage, getImageSize } from '../utils/imageOptimizer';\n\nexport default function FaceRegister() {\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [progress, setProgress] = useState('');\n  const [capturedImage, setCapturedImage] = useState(null);\n  const [preview, setPreview] = useState(null);\n  \n  const { user } = useAuth();\n  const navigate = useNavigate();\n  const [hasRegistration, setHasRegistration] = useState(false);\n\n  const handleCapture = async (base64String) => {\n    try {\n      setProgress('Optimizando imagen...');\n      // Optimizar imagen agresivamente para m√°xima velocidad\n      const optimized = await optimizeImage(base64String, 240, 240, 0.5);\n      const originalSize = getImageSize(base64String);\n      const optimizedSize = getImageSize(optimized);\n      const reduction = Math.round((1 - optimizedSize/originalSize) * 100);\n      console.log(`‚úì Imagen optimizada: ${originalSize}KB ‚Üí ${optimizedSize}KB (${reduction}% reducci√≥n)`);\n      setCapturedImage(optimized);\n      setPreview(optimized);\n      setProgress('');\n    } catch (error) {\n      console.error('Error optimizando imagen, usando original:', error);\n      setCapturedImage(base64String);\n      setPreview(base64String);\n      setProgress('');\n    }\n  };\n\n  const retakePhoto = () => {\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  const registerFace = async () => {\n    if (!capturedImage) {\n      setError('Por favor, captura una foto primero');\n      return;\n    }\n\n    if (!user) {\n      setError('Debes estar autenticado para registrar tu cara. Redirigiendo al login...');\n      setTimeout(() => {\n        navigate('/login');\n      }, 2000);\n      return;\n    }\n\n    setLoading(true);\n    setProgress('Preparando registro...');\n    setError('');\n    setSuccess('');\n\n    try {\n      console.log('1. Iniciando registro facial...');\n      \n      // Obtener token de Firebase\n      let token;\n      try {\n        setProgress('Obteniendo autenticaci√≥n...');\n        token = await user.getIdToken();\n        console.log('2. Token obtenido correctamente');\n      } catch (tokenErr) {\n        console.error('Error obteniendo token:', tokenErr);\n        throw new Error('No se pudo obtener el token de autenticaci√≥n. Por favor, inicia sesi√≥n nuevamente.');\n      }\n\n      // Obtener URL base de la API\n      const apiBase = import.meta.env.VITE_API_URL || 'http://localhost:5000';\n      console.log('3. API URL:', apiBase);\n      console.log('4. Tama√±o de imagen:', capturedImage.length, 'caracteres');\n\n      // Crear un timeout para la petici√≥n\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 segundos timeout (optimizado)\n\n      try {\n        console.log('5. Enviando petici√≥n al backend...');\n        setProgress('Enviando imagen...');\n        // Enviar imagen al backend\n        const response = await fetch(`${apiBase}/face/register`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${token}`\n          },\n          body: JSON.stringify({\n            image: capturedImage,\n            token: token\n          }),\n          signal: controller.signal\n        });\n\n        clearTimeout(timeoutId);\n        console.log('6. Respuesta recibida. Status:', response.status);\n        setProgress('Procesando resultado...');\n\n        // Verificar que la respuesta sea JSON\n        const contentType = response.headers.get('content-type');\n        if (!contentType || !contentType.includes('application/json')) {\n          const text = await response.text();\n          console.error('Respuesta no es JSON:', text.substring(0, 200));\n          throw new Error(`El servidor devolvi√≥ un error (${response.status}). Verifica la consola para m√°s detalles.`);\n        }\n\n        const data = await response.json();\n        console.log('7. Datos JSON parseados:', data);\n\n        if (!response.ok) {\n          console.error('Respuesta no OK:', data);\n          throw new Error(data.error || `Error en el servidor (${response.status})`);\n        }\n\n        if (data.success) {\n          console.log('8. Registro facial exitoso!');\n          setSuccess('¬°Registro facial completado exitosamente!');\n          setProgress('');\n          \n          // Redirigir a completar perfil o dashboard despu√©s de 2 segundos\n          setTimeout(() => {\n            // Verificar si el usuario tiene displayName, si no, ir a complete-profile\n            if (!user?.displayName) {\n              navigate('/complete-profile');\n            } else {\n              navigate('/dashboard');\n            }\n          }, 2000);\n        } else {\n          throw new Error(data.error || 'Error en el registro');\n        }\n      } catch (fetchErr) {\n        clearTimeout(timeoutId);\n        \n        if (fetchErr.name === 'AbortError') {\n          console.error('Timeout en la petici√≥n');\n          throw new Error('La petici√≥n tard√≥ demasiado tiempo. Intenta con una imagen m√°s peque√±a.');\n        }\n        \n        if (fetchErr instanceof TypeError) {\n          console.error('Error de conexi√≥n:', fetchErr);\n          throw new Error(`No se pudo conectar al servidor (${apiBase}). Verifica que est√© activo.`);\n        }\n        \n        throw fetchErr;\n      }\n    } catch (err) {\n      const errorMsg = err.message || 'Error al registrar la cara. Por favor, intenta de nuevo.';\n      setError(errorMsg);\n      console.error('Error en registro facial:', err);\n    } finally {\n      setLoading(false);\n      setProgress('');\n    }\n  };\n\n  // Check if current user already has a facial registration\n  useEffect(() => {\n    const check = async () => {\n      if (!user) return setHasRegistration(false);\n      try {\n        const token = await user.getIdToken();\n        const apiBase = import.meta.env.VITE_API_URL || 'http://localhost:5000';\n        const res = await fetch(`${apiBase}/face/exists`, {\n          method: 'GET',\n          headers: { Authorization: `Bearer ${token}` }\n        });\n        const data = await res.json();\n        setHasRegistration(!!data.exists);\n      } catch (err) {\n        console.error('Error checking face registration:', err);\n      }\n    };\n    check();\n  }, [user]);\n\n  const deleteFaceRegistration = async () => {\n    if (!user) {\n      setError('Debes estar autenticado para eliminar tu registro facial');\n      return;\n    }\n    if (!confirm('¬øEst√°s seguro de eliminar tu registro facial? Esta acci√≥n no se puede deshacer.')) return;\n\n    setLoading(true);\n    try {\n      const token = await user.getIdToken();\n      const apiBase = import.meta.env.VITE_API_URL || 'http://localhost:5000';\n      const res = await fetch(`${apiBase}/face/${user.uid}`, {\n        method: 'DELETE',\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data.error || 'Error eliminando registro facial');\n      setSuccess('Registro facial eliminado correctamente');\n      setHasRegistration(false);\n      setPreview(null);\n      setCapturedImage(null);\n    } catch (err) {\n      setError(err.message || 'Error eliminando registro facial');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"container min-h-screen px-4 py-10\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"text-center mb-6\">\n          <h1 className=\"text-3xl font-extrabold\">üì∏ Registro Facial</h1>\n          <p className=\"text-white/70 mt-2\">\n            {user ? \n              'Captura una foto de tu rostro para habilitar el login facial' :\n              'Paso 2: Captura una foto de tu rostro para completar tu registro'\n            }\n          </p>\n          {!user && (\n            <p className=\"text-white/50 text-sm mt-1\">\n              Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial\n            </p>\n          )}\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6\">\n          {error && <Alert intent=\"error\" className=\"mb-4\">{error}</Alert>}\n          {success && <Alert intent=\"success\" className=\"mb-4\">{success}</Alert>}\n          {progress && <Alert intent=\"info\" className=\"mb-4\">‚è≥ {progress}</Alert>}\n\n          {!preview ? (\n            <FaceCaptureCamera\n              onCapture={handleCapture}\n              onCancel={() => navigate('/dashboard')}\n              disabled={loading}\n              buttonText=\"üì∑ Capturar Foto\"\n              showCancel={true}\n            />\n          ) : (\n            <div className=\"space-y-4\">\n              {/* Preview de la foto capturada */}\n              <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                <img\n                  src={preview}\n                  alt=\"Foto capturada\"\n                  className=\"w-full h-auto max-h-[480px] mx-auto\"\n                />\n              </div>\n\n              {/* Botones de acci√≥n */}\n              <div className=\"flex gap-4 justify-center\">\n                <Button\n                  onClick={retakePhoto}\n                  variant=\"outline\"\n                  disabled={loading}\n                  size=\"lg\"\n                >\n                  üîÑ Tomar Otra Foto\n                </Button>\n                <Button\n                  onClick={registerFace}\n                  disabled={loading}\n                  size=\"lg\"\n                >\n                  {loading ? '‚è≥ Registrando...' : '‚úÖ Registrar Cara'}\n                </Button>\n              </div>\n            </div>\n          )}\n\n          <div className=\"mt-6 text-center\">\n            <div className=\"flex items-center justify-center gap-3\">\n              <Button\n                onClick={() => navigate('/dashboard')}\n                variant=\"ghost\"\n                size=\"sm\"\n              >\n                ‚Üê Volver al Dashboard\n              </Button>\n\n              {hasRegistration && (\n                <Button\n                  onClick={deleteFaceRegistration}\n                  variant=\"destructive\"\n                  size=\"sm\"\n                  disabled={loading}\n                >\n                  üóëÔ∏è Eliminar registro facial\n                </Button>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":["FaceRegister","error","setError","useState","success","setSuccess","loading","setLoading","progress","setProgress","capturedImage","setCapturedImage","preview","setPreview","user","useAuth","navigate","useNavigate","hasRegistration","setHasRegistration","handleCapture","base64String","optimized","optimizeImage","originalSize","getImageSize","optimizedSize","reduction","retakePhoto","registerFace","token","tokenErr","apiBase","controller","timeoutId","response","contentType","text","data","fetchErr","err","errorMsg","useEffect","deleteFaceRegistration","res","jsxs","jsx","Alert","Button","FaceCaptureCamera"],"mappings":"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"}