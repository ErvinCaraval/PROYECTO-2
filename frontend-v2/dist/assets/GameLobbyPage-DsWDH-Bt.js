import{c as V,u as F,a as R,r,b as B,j as e}from"./index-BiJ2oatD.js";import{g as v,m as J,d as O}from"./socket-Bgb55DCa.js";import{B as m}from"./Button-nvjz7pcz.js";import{A as D}from"./Alert-C8s4BsWK.js";import{C as N,a as w,b as L}from"./Card-BEIfdDR1.js";import{L as H}from"./LoadingOverlay-CDNIPSM9.js";import{A as K,S as T}from"./Skeleton-CuTyN1O4.js";function ae(){const{gameId:t}=V(),{user:s}=F(),{isVoiceModeEnabled:C,speak:k}=R(),[n,E]=r.useState([]),[u,S]=r.useState(null),[z]=r.useState("waiting"),[b,$]=r.useState(""),p=B(),[f,g]=r.useState(!1),[j,c]=r.useState(!1),[h,x]=r.useState(0),d=a=>{C&&k(a,{action:"text_read",questionId:"lobby",metadata:{origin:"lobby"}})};r.useEffect(()=>{s&&(async()=>{if(!s)return;const a=await v(),y=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?1e4:15e3;let l,o;a.connected?(console.log("[GameLobbyPage] Socket ya conectado:",a.id),g(!0),c(!1)):(console.log("[GameLobbyPage] Socket no conectado, reconectando..."),a.disconnect(),a.connect(),x(y/1e3),l=setTimeout(()=>{a.connected||(c(!0),x(0),console.warn("[GameLobbyPage] Timeout de conexiÃ³n alcanzado despuÃ©s de",y,"ms"))},y),o=setInterval(()=>{x(i=>i<=1?(clearInterval(o),0):i-1)},1e3)),E(i=>i.length===0?[{uid:s.uid,displayName:s.displayName||s.email,email:s.email}]:i),S(i=>i??s.uid);function P(){g(!0),c(!1),x(0),l&&clearTimeout(l),o&&clearInterval(o)}function A(){g(!1)}function G(i){console.error("[GameLobbyPage] Error de conexiÃ³n:",i),c(!0),x(0),l&&clearTimeout(l),o&&clearInterval(o)}return a.on("connect",P),a.on("disconnect",A),a.on("connect_error",G),a.emit("joinGame",{gameId:t,uid:s.uid,displayName:s.displayName||s.email}),a.on("playerJoined",({players:i})=>{E(i),i.length>0&&S(i[0].uid)}),a.on("gameStarted",()=>{console.log("[GameLobbyPage] Evento gameStarted recibido, navegando a /game/"+t),p(`/game/${t}`)}),a.on("error",({error:i})=>{$(i)}),()=>{l&&clearTimeout(l),o&&clearInterval(o),a.off("playerJoined"),a.off("gameStarted"),a.off("error"),a.off("connect",P),a.off("disconnect",A),a.off("connect_error",G),O()}})()},[t,s,p]);const M=()=>{console.log("[GameLobbyPage] Emitiendo startGame:",{gameId:t}),(async()=>(await v()).emit("startGame",{gameId:t}))()},_=()=>{navigator.clipboard.writeText(t),alert("Game code copied to clipboard!")},q=async()=>{c(!1),g(!1);try{const a=await v();console.log("[GameLobbyPage] Reintentando conexiÃ³n..."),a.disconnect(),a.removeAllListeners(),setTimeout(()=>{a.connect()},1e3)}catch(a){console.error("[GameLobbyPage] Error al reintentar conexiÃ³n:",a),c(!0)}};return b?e.jsxs("div",{className:"min-h-screen container px-4 py-10",children:[e.jsx(D,{intent:"error",className:"mb-4",children:b==="Game already started"?"La partida ya ha comenzado. No puedes unirte en este momento.":b}),e.jsx(m,{onClick:()=>p("/dashboard"),onFocus:()=>d("Volver al panel principal"),onMouseEnter:()=>d("Volver al panel principal"),children:"Volver al inicio"})]}):e.jsxs("div",{className:"min-h-screen container px-4 py-8",children:[!f&&!j&&e.jsx("span",{className:"sr-only","aria-live":"polite",children:`Conectando a la sala ${h>0?`(${h}s)`:""}`}),!f&&!j&&e.jsx(H,{text:`Conectando a la salaâ€¦ ${h>0?`(${h}s)`:""}`,mobileOnly:!0}),j&&e.jsxs("div",{className:"fixed inset-0 z-[3500] flex items-center justify-center px-6 md:hidden",role:"dialog","aria-modal":"true","aria-labelledby":"lobby-conn-title","aria-describedby":"lobby-conn-desc",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm"}),e.jsx("div",{className:"relative flex flex-col items-center gap-4 rounded-2xl border border-white/10 bg-bb-bg-primary/90 px-6 py-4 shadow-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{id:"lobby-conn-title",className:"text-lg font-semibold mb-2",children:"âš ï¸ Problema de conexiÃ³n"}),e.jsx("p",{id:"lobby-conn-desc",className:"text-sm text-white/80 mb-4",children:"No se pudo conectar a la sala. Esto puede deberse a problemas de red o el servidor."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"secondary",size:"sm",onClick:q,title:"Reintentar conexiÃ³n",children:"ðŸ”„ Reintentar"}),e.jsx(m,{variant:"outline",size:"sm",onClick:()=>p("/dashboard"),title:"Volver al inicio",children:"ðŸ  Volver"})]})]})})]}),e.jsxs("header",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"ðŸŽ® Sala de Juego"}),e.jsx("p",{className:"text-white/70",children:"Comparte el cÃ³digo para que tus amigos se unan"}),C&&e.jsx(m,{variant:"outline",size:"sm",className:"mt-2",onClick:async()=>{const a=[];a.push("EstÃ¡s en la sala de juego."),a.push("Arriba estÃ¡ el cÃ³digo de la partida que puedes copiar para compartir."),a.push("A la izquierda verÃ¡s la lista de jugadores conectados."),a.push("A la derecha estÃ¡n las acciones: iniciar partida si eres anfitriÃ³n, o esperar si eres jugador."),a.push("El anfitriÃ³n puede iniciar cuando haya al menos un jugador."),k(a.join(" "),{action:"page_guide",questionId:"lobby",force:!0})},"aria-label":"Explicar la pÃ¡gina",title:"Explicar la pÃ¡gina",children:"ðŸ›ˆ Explicar pÃ¡gina"})]}),e.jsx(N,{className:"w-full md:w-auto",children:e.jsxs(w,{className:"flex items-center gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-white/70",children:"CÃ³digo"}),e.jsx("div",{className:"text-xl font-bold tracking-widest",children:t})]}),e.jsx(m,{variant:"secondary",onClick:_,"aria-label":"Copiar cÃ³digo",onFocus:()=>d("Copiar cÃ³digo de la partida"),onMouseEnter:()=>d("Copiar cÃ³digo de la partida"),className:"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-bb-primary",title:"Copiar cÃ³digo",children:"ðŸ“‹ Copiar"})]})})]}),e.jsxs("main",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(N,{className:"lg:col-span-2",children:[e.jsx(L,{className:"pb-2",children:e.jsxs("h3",{className:"text-2xl font-semibold",children:["ðŸ‘¥ Jugadores (",n.length,")"]})}),e.jsx(w,{children:e.jsx("div",{className:"grid gap-3 sm:grid-cols-2",role:"list","aria-label":"Lista de jugadores",children:e.jsx(K,{children:(n&&n.length>0?n:f?[]:Array.from({length:4}).map((a,I)=>({uid:`sk-${I}`,_sk:!0}))).map(a=>e.jsx(J.div,{layout:!0,initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{type:"spring",stiffness:140,damping:16},className:`flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3 transition-transform duration-150 hover:-translate-y-0.5 ${a.uid===u?"ring-1 ring-bb-primary/50":""}`,role:"listitem","aria-label":a._sk?"Cargando jugador":`${a.displayName||a.email}${a.uid===u?" (AnfitriÃ³n)":""}`,children:a._sk?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-8 w-8 rounded-full"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(T,{className:"h-4 w-40"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xl",children:a.uid===u?"ðŸ‘‘":"ðŸ‘¤"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold truncate",children:a.displayName||a.email}),a.uid===u&&e.jsx("div",{className:"text-xs text-white/70",children:"AnfitriÃ³n"})]})]})},a.uid))})})})]}),e.jsxs(N,{children:[e.jsx(L,{className:"pb-2",children:e.jsx("h3",{className:"text-2xl font-semibold",children:"Acciones"})}),e.jsx(w,{className:"space-y-3",children:s&&s.uid===u&&z==="waiting"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Â¿Listo para comenzar la partida?"}),e.jsx(m,{onClick:M,disabled:n.length<1,size:"lg",onFocus:()=>d("Iniciar la partida"),onMouseEnter:()=>d("Iniciar la partida"),"aria-disabled":n.length<1,title:n.length<1?"Esperando jugadores":"Iniciar partida","aria-describedby":n.length<1?"players-waiting-hint":void 0,children:"ðŸš€ Iniciar partida"}),n.length<1&&e.jsx("p",{id:"players-waiting-hint",className:"text-sm text-white/70",children:"Esperando a que se unan jugadores..."})]}):e.jsxs("div",{className:"flex items-center gap-3","aria-live":"polite",children:[e.jsx("span",{children:"â³"}),e.jsx("p",{className:"text-sm text-white/80",children:"Esperando a que el anfitriÃ³n inicie la partidaâ€¦"})]})})]})]})]})}export{ae as default};
//# sourceMappingURL=GameLobbyPage-DsWDH-Bt.js.map
