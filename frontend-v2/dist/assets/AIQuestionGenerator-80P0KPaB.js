import{a as fe,u as be,r as o,j as e,m as ve}from"./index-B7SNj0r6.js";import{B as C}from"./Button-BAFGbEtv.js";import{I as me}from"./Input-D9M14c8m.js";import{A as se}from"./Alert-CmJLF0tw.js";import{O as Se}from"./OCRQuestionCapture-DKZ53baR.js";import{S as he,L as Ee}from"./LoadingOverlay-QL4gMhH3.js";import{B as Ie}from"./DashboardPage-rTM-UDHw.js";import{a as $e,b as ke}from"./api-BzKpl5CV.js";import{A as Te}from"./index-B9PUOGrg.js";import"./clsx-B-dksMZM.js";import"./socket-M0HrJEIC.js";import"./Card-D8_v8k4n.js";import"./Skeleton-tDG4CQ6N.js";const Ae=({topics:u,onQuestionCreated:$,onCancel:x})=>{const{isVoiceModeEnabled:i,speak:a}=fe(),{user:s}=be(),[S,k]=o.useState({question:"",options:["","","",""],correctIndex:0,selectedTopic:u[0]||""}),[B,L]=o.useState(""),[_,E]=o.useState(!1),[D,R]=o.useState(""),p=(m,r)=>{k(v=>({...v,options:v.options.map((T,V)=>V===m?r:T)}))},j=o.useCallback(()=>S.question.trim()?S.options.some(m=>!m.trim())?"Todas las opciones son requeridas":"":"La pregunta es requerida",[S]);o.useEffect(()=>{const m=j();L(m)},[S,s,j]);const w=async m=>{m.preventDefault();const r=j();if(r){L(r);return}E(!0),L(""),R("");try{const v={text:S.question,options:S.options,correctAnswerIndex:S.correctIndex,category:S.selectedTopic,explanation:""};if(R("Guardando..."),$){const T=await Promise.resolve($(v)),V=T&&T.text?T.text:v.text;R(`Pregunta creada: "${V}"`)}else R("¬°Pregunta preparada!")}catch(v){console.error("Error al preparar la pregunta:",v),L(v.message||"Error al guardar la pregunta")}finally{E(!1)}};return e.jsxs("form",{className:"grid gap-4",onSubmit:w,children:[i&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(C,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const m=[];m.push("Formulario para escribir preguntas manualmente."),m.push("Campo Tema: selecciona el tema de la pregunta."),m.push("Campo Pregunta: escribe el texto de la pregunta."),m.push("Opciones: escribe las posibles respuestas. Marca cu√°l es la correcta con el bot√≥n de opci√≥n."),m.push("Bot√≥n Atr√°s: vuelve al generador de preguntas."),m.push("Bot√≥n Guardar: guarda la pregunta actual."),await a(m.join(" "),{action:"page_guide",questionId:"manual_question_form",force:!0})},"aria-label":"Explicar la p√°gina",children:"üõà Explicar p√°gina"})}),e.jsxs("div",{className:"p-4 bg-gradient-to-br from-bb-primary/20 to-bb-primary/10 rounded-xl border-2 border-bb-primary/40 mb-4",children:[e.jsx("h3",{className:"text-lg font-bold mb-1",children:"‚úèÔ∏è Escribe tu pregunta"}),e.jsx("p",{className:"text-xs text-white/70",children:"Rellena todos los campos correctamente"})]}),B&&e.jsx(se,{intent:"error",children:B}),D&&e.jsx(se,{intent:"success",children:D}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm font-semibold text-white",htmlFor:"topic-select",children:"Tema *"}),e.jsx("select",{id:"topic-select",value:S.selectedTopic,onChange:m=>k(r=>({...r,selectedTopic:m.target.value})),disabled:_,className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none transition",children:u.map(m=>e.jsx("option",{value:m,children:m},m))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm font-semibold text-white",htmlFor:"question-input",children:"Pregunta *"}),e.jsx(me,{id:"question-input",type:"text",value:S.question,onChange:m=>k(r=>({...r,question:m.target.value})),disabled:_,placeholder:"Escribe la pregunta aqu√≠...",required:!0})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-semibold text-white",children:"Opciones de respuesta *"}),e.jsx("span",{className:"text-xs text-white/60",children:"4 opciones requeridas"})]}),e.jsx("div",{className:"grid gap-3 p-3 bg-white/5 rounded-lg border border-white/10",children:S.options.map((m,r)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"font-bold text-bb-primary text-lg min-w-[2rem]",children:[String.fromCharCode(65+r),")"]}),e.jsx(me,{type:"text",value:m,onChange:v=>p(r,v.target.value),disabled:_,placeholder:"Escribe la opci√≥n...",className:"flex-1",required:!0}),e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"correctOption",checked:S.correctIndex===r,onChange:()=>k(v=>({...v,correctIndex:r})),disabled:_,className:"h-5 w-5 accent-bb-primary cursor-pointer"}),e.jsx("span",{className:"text-xs text-white/70 whitespace-nowrap",children:"Correcta"})]})]},r))})]}),e.jsxs("div",{className:"p-3 bg-bb-primary/15 rounded-lg border border-bb-primary/40",children:[e.jsx("p",{className:"text-xs text-white/70 mb-1",children:"Respuesta correcta seleccionada:"}),e.jsxs("p",{className:"text-sm font-semibold text-white",children:[String.fromCharCode(65+S.correctIndex),") ",S.options[S.correctIndex]||"(sin llenar)"]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(C,{type:"button",variant:"secondary",onClick:x,disabled:_,className:"flex-1",onFocus:()=>i&&a("Atr√°s: vuelve al generador de preguntas.",{force:!0}),onMouseEnter:()=>i&&a("Atr√°s: vuelve al generador de preguntas.",{force:!0}),children:"Atr√°s"}),e.jsx(C,{type:"submit",disabled:_,className:"flex-1",onFocus:()=>i&&a("Guardar: guarda la pregunta actual.",{force:!0}),onMouseEnter:()=>i&&a("Guardar: guarda la pregunta actual.",{force:!0}),children:_?"‚è≥ Guardando‚Ä¶":"‚úì Guardar"})]})]})},ze=4*1024*1024,ye=["image/jpeg","image/png","image/webp"],Me=80*1024,je=["","","",""],Fe=(u=[])=>{const $=new Set;return u.filter(x=>{const i=x?.toLowerCase?.()||x;return!i||$.has(i)?!1:($.add(i),!0)})};function xe(u=""){return u?u.charAt(0).toUpperCase()+u.slice(1):""}const Ne=(u="")=>{if(!u||typeof u!="string")return 0;const $=u.includes(",")?u.split(",")[1]:u;return Math.floor($.length*3/4)},Pe=u=>new Promise(($,x)=>{const i=new Image;i.onload=()=>$(i),i.onerror=x,i.src=u}),Oe=async(u,$,x=640)=>{const i=await Pe(u),a=Math.min(1,x/Math.max(i.width,i.height)),s=document.createElement("canvas");s.width=Math.max(1,Math.round(i.width*a)),s.height=Math.max(1,Math.round(i.height*a)),s.getContext("2d").drawImage(i,0,0,s.width,s.height);const k=[.8,.7,.6,.5,.4];for(const B of k){const L=s.toDataURL("image/jpeg",B);if(Ne(L)<=$)return L}return s.toDataURL("image/jpeg",.35)},qe=async(u,$=Me)=>{if(!u||Ne(u)<=$)return u;try{return await Oe(u,$)}catch{return u}},Be=({topics:u=[],onQuestionCreated:$,onCancel:x})=>{const{user:i}=be(),{isVoiceModeEnabled:a,speak:s}=fe(),S=o.useRef(null),k=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",[B,L]=o.useState(u[0]||""),[_,E]=o.useState(null),[D,R]=o.useState(""),[p,j]=o.useState(null),[w,m]=o.useState(null),[r,v]=o.useState({text:"",options:[...je],correctIndex:0,explanation:"",imageBase64:""}),[T,V]=o.useState(!1),[H,P]=o.useState(!1),[X,A]=o.useState(""),[ee,G]=o.useState(""),[oe,J]=o.useState(!1),Z=t=>ye.includes(t.type)?t.size>ze?"La imagen debe ser menor a 4MB.":null:"Formato inv√°lido. Usa JPG, PNG o WebP.",Q=t=>new Promise((d,f)=>{const b=new FileReader;b.onload=O=>d(O.target.result),b.onerror=()=>f(new Error("No se pudo leer la imagen")),b.readAsDataURL(t)}),ie=async t=>{const d=t.target.files?.[0];if(!d)return;const f=Z(d);if(f){A(f);return}try{const b=await Q(d),O=await qe(b);E(d),R(b),j(null),m(null),v({text:"",options:[...je],correctIndex:0,explanation:"",imageBase64:O}),A(""),G(""),J(!1),a&&s("Imagen seleccionada. Ahora pulsa analizar imagen para obtener una sugerencia de pregunta.",{force:!1,action:"image_selected"})}catch(b){A(b.message),a&&s(`Error al leer la imagen: ${b.message}`,{force:!1,action:"image_error"})}},pe=async()=>{if(!_||!D){A("Selecciona una imagen v√°lida antes de analizar.");return}V(!0),A(""),G("");try{const t=i&&i.getIdToken?await i.getIdToken():null,d=await fetch(`${k}/vision/analyze-image`,{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}},body:JSON.stringify({imageBase64:D,mimeType:_.type,language:"es"})}),f=await d.json();if(!d.ok||!f.success)throw new Error(f.error||"Error analizando la imagen");if(j(f.analysis),m(f.questionSuggestions||null),le(f.analysis,f.questionSuggestions,r.imageBase64||D),G("Imagen analizada exitosamente"),a){const b=f.analysis?.description?.primary?.text,O=b?`An√°lisis completo. Descripci√≥n principal: ${b}. Ahora revisa la pregunta sugerida y las opciones antes de guardar.`:"An√°lisis completo. Ahora revisa la pregunta sugerida y las opciones antes de guardar.";s(O,{force:!1,action:"image_analysis_done"})}}catch(t){const d=t.message||"No se pudo analizar la imagen";A(d),a&&s(`Error al analizar la imagen: ${d}`,{force:!1,action:"image_analysis_error"})}finally{V(!1)}},le=(t,d,f)=>{const b=t?.description?.primary?.text,O=d?.question?d.question:b?"¬øQu√© describe mejor esta imagen?":"¬øQu√© se muestra en la imagen?",c=(t?.tags||[]).map(q=>q.name).filter(Boolean),g=(t?.objects||[]).map(q=>q.name).filter(Boolean),l=d?.options||[],N=Fe([...l,...c,...g]).map(xe);for(;N.length<4;)N.push("");const F=N.slice(0,4),y=d?.suggestedAnswer||F[0],Y=F.findIndex(q=>q&&q.toLowerCase()===(y||"").toLowerCase());v({text:O,options:F,correctIndex:Y>=0?Y:0,explanation:d?.descriptionContext?`Contexto: ${d.descriptionContext}`:"Pregunta generada a partir del an√°lisis de la imagen.",imageBase64:f}),!B&&u.length>0&&L(u[0])},z=(t,d)=>{J(!1),v(f=>({...f,options:f.options.map((b,O)=>O===t?d:b)}))},ae=()=>r.text.trim()?r.options.filter(d=>d.trim()).length<2?"Completa al menos 2 opciones de respuesta.":r.options[r.correctIndex]?.trim()?B?"":"Selecciona un tema para la pregunta.":"Selecciona una respuesta correcta v√°lida.":"Escribe la pregunta sugerida antes de guardar.",ne=async()=>{const t=ae();if(t){A(t),a&&s(t,{force:!1,action:"image_question_validation_error"});return}if(!$){A("No se proporcion√≥ manejador para guardar la pregunta.");return}P(!0),A(""),G("");const d={text:r.text.trim(),options:r.options.map(f=>f.trim()),correctAnswerIndex:r.correctIndex,category:B,explanation:r.explanation||"",imageBase64:r.imageBase64,imageAnalysis:p};try{await Promise.resolve($(d)),G("Pregunta generada y enviada correctamente."),J(!0),a&&s("Pregunta guardada exitosamente. Puedes crear otra pregunta con esta imagen o volver al panel.",{force:!1,action:"image_question_saved"}),setTimeout(()=>G(""),2e3),setTimeout(()=>J(!1),3e3)}catch(f){A(f.message||"No se pudo guardar la pregunta"),J(!1)}finally{P(!1)}},ce=()=>{E(null),R(""),j(null),m(null),v({text:"",options:[...je],correctIndex:0,explanation:"",imageBase64:""}),A(""),G(""),J(!1),S.current&&(S.current.value="")};return e.jsxs("div",{className:"grid gap-4 p-4",children:[a&&e.jsx("div",{className:"flex justify-end",children:e.jsx(C,{variant:"outline",size:"sm",type:"button",onClick:async()=>{await s(["Sube una imagen relacionada con tu pregunta.","Haz clic en Analizar imagen para obtener descripciones, etiquetas y objetos detectados.","Edita la pregunta sugerida y las opciones antes de guardar.","Al finalizar, guarda la pregunta o vuelve atr√°s."].join(" "),{force:!0,action:"image_analysis_help"})},onMouseEnter:()=>a&&s("Explicar flujo: describe c√≥mo usar esta herramienta para crear preguntas desde im√°genes.",{force:!0}),onFocus:()=>a&&s("Explicar flujo: describe c√≥mo usar esta herramienta para crear preguntas desde im√°genes.",{force:!0}),children:"üõà Explicar flujo"})}),X&&e.jsx(se,{intent:"error",children:X}),ee&&e.jsx(se,{intent:"success",children:ee}),e.jsxs("div",{className:"grid gap-3 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"1. Subir imagen"}),e.jsxs("label",{className:"flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed border-white/20 bg-white/5 px-4 py-10 text-center text-sm text-white/70 hover:border-bb-primary/60 hover:bg-white/10 transition cursor-pointer",onMouseEnter:()=>a&&s(D?"Imagen seleccionada. Haz clic para cambiar la imagen.":"√Årea de subida de imagen. Haz clic o arrastra una imagen JPG, PNG o WebP de m√°ximo 4 megabytes.",{force:!0}),onFocus:()=>a&&s(D?"Imagen seleccionada. Haz clic para cambiar la imagen.":"√Årea de subida de imagen. Haz clic o arrastra una imagen JPG, PNG o WebP de m√°ximo 4 megabytes.",{force:!0}),children:[D?e.jsx("img",{src:D,alt:"Vista previa",className:"max-h-64 rounded-lg object-contain"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-2xl",children:"üñºÔ∏è"}),e.jsx("span",{children:"Haz clic o arrastra una imagen (JPG, PNG, WebP, m√°x. 4MB)"})]}),e.jsx("input",{ref:S,type:"file",accept:ye.join(","),className:"hidden",onChange:ie})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(C,{type:"button",disabled:!_||T,onClick:pe,onMouseEnter:()=>a&&!T&&s("Analizar imagen: analiza la imagen con inteligencia artificial para generar descripciones, etiquetas y sugerencias de pregunta.",{force:!0}),onFocus:()=>a&&!T&&s("Analizar imagen: analiza la imagen con inteligencia artificial para generar descripciones, etiquetas y sugerencias de pregunta.",{force:!0}),children:T?e.jsxs(e.Fragment,{children:[e.jsx(he,{size:16,className:"mr-2"}),"Analizando‚Ä¶"]}):"üîç Analizar imagen"}),e.jsx(C,{type:"button",variant:"secondary",disabled:!_||T,onClick:ce,onMouseEnter:()=>a&&s("Limpiar: elimina la imagen y el an√°lisis actual para empezar de nuevo.",{force:!0}),onFocus:()=>a&&s("Limpiar: elimina la imagen y el an√°lisis actual para empezar de nuevo.",{force:!0}),children:"Limpiar"}),e.jsx(C,{type:"button",variant:"ghost",onClick:x,onMouseEnter:()=>a&&s("Volver: cierra esta herramienta y regresa al generador de preguntas.",{force:!0}),onFocus:()=>a&&s("Volver: cierra esta herramienta y regresa al generador de preguntas.",{force:!0}),children:"Volver"})]})]}),p&&e.jsxs("div",{className:"grid gap-4 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"2. Resultados del an√°lisis"}),p?.description?.primary?.text&&e.jsxs("div",{className:"rounded-xl border border-white/10 bg-bb-primary/10 p-3",onMouseEnter:()=>a&&s(`Descripci√≥n principal: ${p.description.primary.text}. Confianza: ${(p.description.primary.confidence*100).toFixed(1)} por ciento.`,{force:!0}),onFocus:()=>a&&s(`Descripci√≥n principal: ${p.description.primary.text}. Confianza: ${(p.description.primary.confidence*100).toFixed(1)} por ciento.`,{force:!0}),tabIndex:0,role:"region","aria-label":"Descripci√≥n principal del an√°lisis",children:[e.jsx("p",{className:"text-sm text-white/70 uppercase tracking-wide",children:"Descripci√≥n principal"}),e.jsx("p",{className:"text-base font-semibold text-white mt-1",children:p.description.primary.text}),e.jsxs("p",{className:"text-xs text-white/60 mt-1",children:["Confianza: ",(p.description.primary.confidence*100).toFixed(1),"%"]})]}),p.tags?.length>0&&e.jsxs("div",{className:"grid gap-2",onMouseEnter:()=>a&&s(`Tags detectados: ${p.tags.map(t=>`${t.name} con ${(t.confidence*100).toFixed(0)} por ciento de confianza`).join(", ")}.`,{force:!0}),onFocus:()=>a&&s(`Tags detectados: ${p.tags.map(t=>`${t.name} con ${(t.confidence*100).toFixed(0)} por ciento de confianza`).join(", ")}.`,{force:!0}),tabIndex:0,role:"region","aria-label":"Tags detectados",children:[e.jsx("p",{className:"text-sm text-white/70 font-semibold",children:"Tags detectados"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.tags.map(t=>e.jsxs(Ie,{variant:"primary",children:[t.name," ‚Ä¢ ",(t.confidence*100).toFixed(0),"%"]},t.name))})]}),p.categories?.length>0&&e.jsxs("div",{className:"grid gap-1",onMouseEnter:()=>a&&s(`Categor√≠as detectadas: ${p.categories.map(t=>`${t.name} con ${(t.confidence*100).toFixed(1)} por ciento`).join(", ")}.`,{force:!0}),onFocus:()=>a&&s(`Categor√≠as detectadas: ${p.categories.map(t=>`${t.name} con ${(t.confidence*100).toFixed(1)} por ciento`).join(", ")}.`,{force:!0}),tabIndex:0,role:"region","aria-label":"Categor√≠as detectadas",children:[e.jsx("p",{className:"text-sm text-white/70 font-semibold",children:"Categor√≠as"}),p.categories.map(t=>e.jsxs("p",{className:"text-sm text-white/80",children:[t.name," (",(t.confidence*100).toFixed(1),"%)"]},t.name))]}),p.objectSummary?.length>0&&e.jsxs("div",{className:"grid gap-1",onMouseEnter:()=>a&&s(`Objetos detectados: ${p.objectSummary.map(t=>`${xe(t.name)} ${t.count} ${t.count===1?"vez":"veces"}`).join(", ")}.`,{force:!0}),onFocus:()=>a&&s(`Objetos detectados: ${p.objectSummary.map(t=>`${xe(t.name)} ${t.count} ${t.count===1?"vez":"veces"}`).join(", ")}.`,{force:!0}),tabIndex:0,role:"region","aria-label":"Objetos detectados",children:[e.jsx("p",{className:"text-sm text-white/70 font-semibold",children:"Objetos detectados"}),p.objectSummary.map(t=>e.jsxs("p",{className:"text-sm text-white/80",children:[xe(t.name)," ‚Ä¢ ",t.count," ",t.count===1?"vez":"veces"]},t.name))]}),p.colors&&e.jsxs("div",{className:"grid gap-2",onMouseEnter:()=>a&&s(`Colores dominantes: ${(p.colors.dominantColors||[]).join(", ")}. ${p.colors.accentColor?`Color de acento: ${p.colors.accentColor}.`:""}`,{force:!0}),onFocus:()=>a&&s(`Colores dominantes: ${(p.colors.dominantColors||[]).join(", ")}. ${p.colors.accentColor?`Color de acento: ${p.colors.accentColor}.`:""}`,{force:!0}),tabIndex:0,role:"region","aria-label":"Colores dominantes",children:[e.jsx("p",{className:"text-sm text-white/70 font-semibold",children:"Colores dominantes"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(p.colors.dominantColors||[]).map(t=>e.jsx("span",{className:"px-3 py-1 text-xs font-semibold rounded-full border border-white/10 bg-white/10 text-white/80",children:t},t)),p.colors.accentColor&&e.jsxs("span",{className:"flex items-center gap-2 text-xs text-white/80",children:["Acento:",e.jsx("span",{className:"inline-flex h-4 w-4 rounded-full border border-white/40",style:{backgroundColor:`#${p.colors.accentColor}`}}),"#",p.colors.accentColor]})]})]})]}),p&&e.jsxs("div",{className:"grid gap-4 rounded-2xl border border-white/10 bg-white/5 p-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"3. Generar pregunta"}),w&&e.jsxs("div",{className:"rounded-xl border border-bb-primary/40 bg-bb-primary/10 p-3 text-sm text-white/80",onMouseEnter:()=>a&&s(`Sugerencia de pregunta: ${w.question}. ${w.descriptionContext?`Contexto: ${w.descriptionContext}.`:""} ${w.categorySuggestion?`Categor√≠a sugerida: ${w.categorySuggestion}.`:""}`,{force:!0}),onFocus:()=>a&&s(`Sugerencia de pregunta: ${w.question}. ${w.descriptionContext?`Contexto: ${w.descriptionContext}.`:""} ${w.categorySuggestion?`Categor√≠a sugerida: ${w.categorySuggestion}.`:""}`,{force:!0}),tabIndex:0,role:"region","aria-label":"Sugerencia de pregunta",children:[e.jsx("p",{className:"font-semibold",children:"Sugerencia:"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1 mt-1",children:[e.jsxs("li",{children:["Pregunta base: ",w.question]}),w.descriptionContext&&e.jsxs("li",{children:["Contexto: ",w.descriptionContext]}),w.categorySuggestion&&e.jsxs("li",{children:["Categor√≠a sugerida: ",w.categorySuggestion]})]})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm text-white/70 font-semibold",children:"Tema"}),e.jsx("select",{value:B,onChange:t=>L(t.target.value),className:"rounded-xl border-2 border-white/10 bg-white/5 px-4 py-2 text-white focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30",onMouseEnter:()=>a&&s(`Tema: selecciona el tema de la pregunta. Tema actual: ${B}.`,{force:!0}),onFocus:()=>a&&s(`Tema: selecciona el tema de la pregunta. Tema actual: ${B}.`,{force:!0}),children:u.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/70 font-semibold",children:"Pregunta propuesta"}),e.jsx("textarea",{value:r.text,onChange:t=>{J(!1),v(d=>({...d,text:t.target.value}))},rows:3,className:"w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-2 text-white focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30",placeholder:"¬øQu√© se muestra en la imagen?",onMouseEnter:()=>a&&s(`Pregunta propuesta: edita el texto de la pregunta. ${r.text?`Texto actual: ${r.text}`:"Campo vac√≠o, escribe la pregunta aqu√≠."}`,{force:!0}),onFocus:()=>a&&s(`Pregunta propuesta: edita el texto de la pregunta. ${r.text?`Texto actual: ${r.text}`:"Campo vac√≠o, escribe la pregunta aqu√≠."}`,{force:!0})})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm text-white/70 font-semibold",children:"Opciones de respuesta"}),e.jsx("span",{className:"text-xs text-white/50",children:"Marca la correcta"})]}),e.jsx("div",{className:"grid gap-3 p-3 bg-white/5 rounded-xl border border-white/10",children:r.options.map((t,d)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-lg font-bold text-bb-primary min-w-[2rem]",children:[String.fromCharCode(65+d),")"]}),e.jsx(me,{value:t,onChange:f=>z(d,f.target.value),placeholder:"Escribe una opci√≥n‚Ä¶",className:"flex-1",onMouseEnter:()=>a&&s(`Opci√≥n ${String.fromCharCode(65+d)}: ${t||"campo vac√≠o, escribe una opci√≥n aqu√≠."}`,{force:!0}),onFocus:()=>a&&s(`Opci√≥n ${String.fromCharCode(65+d)}: ${t||"campo vac√≠o, escribe una opci√≥n aqu√≠."}`,{force:!0})}),e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer text-xs text-white/70",onMouseEnter:()=>a&&s(`Marcar opci√≥n ${String.fromCharCode(65+d)} como correcta. ${r.correctIndex===d?"Esta opci√≥n est√° marcada como correcta.":"Haz clic para marcar esta opci√≥n como la respuesta correcta."}`,{force:!0}),onFocus:()=>a&&s(`Marcar opci√≥n ${String.fromCharCode(65+d)} como correcta. ${r.correctIndex===d?"Esta opci√≥n est√° marcada como correcta.":"Haz clic para marcar esta opci√≥n como la respuesta correcta."}`,{force:!0}),children:[e.jsx("input",{type:"radio",name:"correctOption",checked:r.correctIndex===d,onChange:()=>{J(!1),v(f=>({...f,correctIndex:d}))},className:"h-4 w-4 accent-bb-primary cursor-pointer"}),"Correcta"]})]},d))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/70 font-semibold",children:"Explicaci√≥n (opcional)"}),e.jsx("textarea",{value:r.explanation,onChange:t=>{J(!1),v(d=>({...d,explanation:t.target.value}))},rows:2,className:"w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-2 text-white focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30",placeholder:"A√±ade un contexto o pista opcional‚Ä¶",onMouseEnter:()=>a&&s(`Explicaci√≥n opcional: a√±ade un contexto o pista para la pregunta. ${r.explanation?`Texto actual: ${r.explanation}`:"Campo vac√≠o, puedes a√±adir una explicaci√≥n opcional."}`,{force:!0}),onFocus:()=>a&&s(`Explicaci√≥n opcional: a√±ade un contexto o pista para la pregunta. ${r.explanation?`Texto actual: ${r.explanation}`:"Campo vac√≠o, puedes a√±adir una explicaci√≥n opcional."}`,{force:!0})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{type:"button",onClick:ne,disabled:H,onMouseEnter:()=>a&&!H&&s("Guardar pregunta: guarda la pregunta actual con la imagen y el an√°lisis. Puedes crear m√°s preguntas despu√©s.",{force:!0}),onFocus:()=>a&&!H&&s("Guardar pregunta: guarda la pregunta actual con la imagen y el an√°lisis. Puedes crear m√°s preguntas despu√©s.",{force:!0}),children:H?e.jsxs(e.Fragment,{children:[e.jsx(he,{size:16,className:"mr-2"}),"Guardando‚Ä¶"]}):"Guardar pregunta"}),oe&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 text-sm text-emerald-400 font-medium animate-in fade-in duration-300",children:[e.jsx("span",{className:"text-lg",children:"‚úì"}),e.jsx("span",{children:"Guardado"})]})]}),e.jsx(C,{type:"button",variant:"secondary",onClick:x,onMouseEnter:()=>a&&s("Finalizar: cierra esta herramienta y regresa al generador de preguntas. Las preguntas guardadas estar√°n disponibles.",{force:!0}),onFocus:()=>a&&s("Finalizar: cierra esta herramienta y regresa al generador de preguntas. Las preguntas guardadas estar√°n disponibles.",{force:!0}),children:"Finalizar"})]})]})]})},De=4*1024*1024,we=["image/jpeg","image/png","image/webp"];function Le({topics:u=[],onQuestionCreated:$,onCancel:x}){const{user:i}=be(),{isVoiceModeEnabled:a,speak:s}=fe(),S=o.useRef(null),k=o.useRef(null),B=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",[L,_]=o.useState(null),[E,D]=o.useState(null),[R,p]=o.useState(!1),[j,w]=o.useState(null),[m,r]=o.useState(""),[v,T]=o.useState(""),[V,H]=o.useState(.5),[P,X]=o.useState(null),[A,ee]=o.useState("identification"),[G,oe]=o.useState(null),[J,Z]=o.useState("upload"),[Q,ie]=o.useState(0),[pe,le]=o.useState(!1),[z,ae]=o.useState({text:"",options:["","","",""],correctIndex:0,explanation:""}),ne=c=>{const g=c.target.files?.[0];if(!g)return;if(!we.includes(g.type)){r("‚ùå Formato inv√°lido. Usa JPG, PNG o WebP.");return}if(g.size>De){r("‚ùå La imagen debe ser menor a 4MB.");return}_(g);const l=new FileReader;l.onload=N=>{D(N.target.result),Z("upload"),ie(0),le(!1),a&&s("Imagen seleccionada correctamente. Presiona detectar objetos para continuar.",{force:!0}),r(""),T("‚úÖ Imagen cargada")},l.readAsDataURL(g)},ce=async()=>{if(!E){r("‚ùå Selecciona una imagen primero.");return}p(!0),r(""),T("");try{const c=i&&i.getIdToken?await i.getIdToken():null,l=await(await fetch(`${B}/vision/detect-objects`,{method:"POST",headers:{"Content-Type":"application/json",...c?{Authorization:`Bearer ${c}`}:{}},body:JSON.stringify({imageBase64:E,minConfidence:V,language:"es"})})).json();if(!l.success){r(`‚ùå ${l.error||"Error detectando objetos"}`);return}if(w(l.detection),r(""),T(`‚úÖ Se detectaron ${l.detection.stats.totalObjects} objetos`),X(null),setTimeout(()=>{Z("results"),t(l.detection.objects)},100),a){const N=l.detection.stats.totalObjects,F=l.detection.topObjects.slice(0,3).map(y=>`${y.name} con ${(y.confidence*100).toFixed(0)}% confianza`).join(", ");s(`Detecci√≥n completada. Se encontraron ${N} objeto${N!==1?"s":""}. 
           ${F}. Selecciona un objeto para crear la pregunta.`,{force:!0})}}catch(c){console.error("Error:",c),r(`‚ùå ${c.message}`)}finally{p(!1)}},t=c=>{if(!k.current||!E)return;const g=new Image;g.onload=()=>{const l=k.current;l.width=g.width,l.height=g.height;const N=l.getContext("2d");N.drawImage(g,0,0),c.forEach(F=>{if(!F.rectangle)return;const{x:y,y:Y,w:q,h:n}=F.rectangle,I=`hsl(${Math.max(0,Math.min(120,F.confidence*120))}, 100%, 50%)`;N.strokeStyle=I,N.lineWidth=3,N.strokeRect(y,Y,q,n),N.fillStyle=I,N.font="bold 14px Arial";const M=`${F.name} (${(F.confidence*100).toFixed(0)}%)`,U=N.measureText(M).width;N.fillRect(y,Y-28,U+8,24),N.fillStyle="white",N.fillText(M,y+4,Y-10)})},g.src=E},d=()=>{if(!j||!P){r("‚ùå Selecciona un objeto primero.");return}const c=j.objects.filter(y=>y.confidence>=V);let g="",l=[],N=-1,F="";if(A==="identification"){g="¬øQu√© objeto aparece en esta imagen?";const y=[P.name],Y=new Set([P.name]);for(const q of c)!Y.has(q.name)&&y.length<4&&(y.push(q.name),Y.add(q.name));if(y.length<4)for(const q of j.objects)!Y.has(q.name)&&y.length<4&&(y.push(q.name),Y.add(q.name));for(;y.length<4;)y.push("Ninguno de los anteriores");l=y,N=0,F=`Se detectaron ${j.stats.totalObjects} objeto(s) en total.`}else{const y=j.objectCounts[P.name]||0;g=`¬øCu√°nto${y!==1?"s":""} ${P.name} hay en la imagen?`,l=["0","1","2","3","4+"],N=y>4?4:y,F=`Se detect√≥(ron) ${y} ${P.name}(s) en la imagen.`}if(l.length!==4)if(l.length<4)for(;l.length<4;)l.push("");else l=l.slice(0,4);ae({text:g,options:l,correctIndex:N,explanation:F}),Z("preview"),a&&s(`Pregunta generada. ${g}. Las opciones son: ${l.filter(y=>y).join(", ")}. Edita antes de guardar.`,{force:!0})},f=()=>{if(!z.text.trim()){r("‚ùå La pregunta no puede estar vac√≠a.");return}if(z.options.filter(l=>l.trim()).length<2){r("‚ùå Necesitas al menos 2 opciones v√°lidas.");return}if(!z.options[z.correctIndex]?.trim()){r("‚ùå La opci√≥n correcta no puede estar vac√≠a.");return}const g={text:z.text.trim(),options:z.options.map(l=>l.trim()),correctAnswerIndex:z.correctIndex,category:"Detecci√≥n de Objetos",explanation:z.explanation||"",imageBase64:E,questionType:`detectionObjects_${A}`,difficulty:"media",imageAnalysis:{detectedObjects:j.objects,objectCounts:j.objectCounts,totalObjects:j.stats.totalObjects,service:"Azure Computer Vision",timestamp:new Date().toISOString()}};$?.(g),ie(l=>l+1),le(!0),T(`‚úÖ Pregunta ${Q+1} guardada`),a&&s(`Pregunta ${Q+1} guardada. Puedes crear otra pregunta con esta imagen.`,{force:!0}),setTimeout(()=>{le(!1),T("")},2e3),Z("results"),X(null),ee("identification"),ae({text:"",options:["","","",""],correctIndex:0,explanation:""})},b=j?.objects.filter(c=>c.confidence>=V)||[],O=()=>{Q>0&&a&&s(`Se guardaron ${Q} pregunta${Q!==1?"s":""}. Volviendo al panel de preguntas.`,{force:!0}),x?.()};return e.jsxs("div",{className:"object-detection-creator",children:[J==="upload"&&e.jsxs("div",{className:"od-section",children:[e.jsxs("div",{className:"od-header",children:[e.jsx("h2",{children:"üéØ Crear Pregunta con Detecci√≥n de Objetos"}),e.jsx("p",{children:"Sube una imagen y el sistema detectar√° autom√°ticamente los objetos presentes"})]}),e.jsx("div",{className:"od-upload-zone",children:e.jsxs("label",{className:"od-upload-label",children:[E?e.jsxs("div",{className:"od-preview-thumb",children:[e.jsx("img",{src:E,alt:"Preview"}),e.jsx("div",{className:"od-preview-overlay",children:"‚úì Imagen lista"})]}):e.jsxs("div",{className:"od-upload-empty",children:[e.jsx("span",{className:"od-upload-icon",children:"üñºÔ∏è"}),e.jsx("span",{className:"od-upload-text",children:"Haz clic o arrastra una imagen"}),e.jsx("span",{className:"od-upload-hint",children:"JPG, PNG o WebP (m√°ximo 4MB)"})]}),e.jsx("input",{ref:S,type:"file",accept:we.join(","),onChange:ne,className:"od-file-input"})]})}),E&&e.jsx(C,{disabled:R,onClick:ce,className:"od-button-primary od-button-full",children:R?e.jsxs(e.Fragment,{children:[e.jsx(he,{size:"small"}),e.jsx("span",{children:"Detectando objetos..."})]}):"‚òÅÔ∏è Detectar Objetos"}),m&&e.jsx(se,{intent:"error",children:m}),v&&e.jsx(se,{intent:"success",children:v}),e.jsx(C,{variant:"secondary",onClick:O,className:"od-button-full",children:"Cancelar"})]}),J==="results"&&j&&e.jsxs("div",{className:"od-section",children:[e.jsxs("div",{className:"od-header",children:[e.jsx("h2",{children:"üìä Objetos Detectados"}),e.jsxs("p",{children:["Se encontraron ",j.stats.totalObjects," objeto(s)"]})]}),e.jsxs("div",{className:"od-canvas-container",children:[e.jsx("canvas",{ref:k,className:"od-canvas"}),e.jsxs("div",{className:"od-canvas-legend",children:[e.jsx("span",{children:"üü¢ Verde: Alta confianza (80-100%)"}),e.jsx("span",{children:"üü° Amarillo: Confianza media (50-80%)"}),e.jsx("span",{children:"üî¥ Rojo: Confianza baja (0-50%)"})]})]}),e.jsx("div",{className:"od-controls",children:e.jsxs("div",{className:"od-confidence-slider",children:[e.jsxs("label",{children:["Confianza m√≠nima: ",(V*100).toFixed(0),"%"]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:V,onChange:c=>H(parseFloat(c.target.value)),className:"od-slider"}),e.jsxs("div",{className:"od-slider-labels",children:[e.jsx("span",{children:"Baja"}),e.jsx("span",{children:"Media"}),e.jsx("span",{children:"Alta"})]})]})}),e.jsxs("div",{className:"od-objects-list",children:[e.jsx("h3",{children:"Selecciona un objeto:"}),e.jsx("div",{className:"od-objects-grid",children:b.map((c,g)=>e.jsxs("button",{onClick:()=>X(c),onMouseEnter:()=>oe(c.id),onMouseLeave:()=>oe(null),className:`od-object-card ${P?.id===c.id?"od-selected":""} ${G===c.id?"od-hovered":""}`,children:[e.jsx("div",{className:"od-object-name",children:c.name}),e.jsxs("div",{className:"od-object-confidence",children:[e.jsx("div",{className:"od-confidence-bar",children:e.jsx("div",{className:"od-confidence-fill",style:{width:`${c.confidence*100}%`}})}),e.jsxs("span",{children:[(c.confidence*100).toFixed(0),"%"]})]})]},g))}),b.length===0&&e.jsxs("div",{className:"od-no-objects",children:[e.jsx("p",{children:"No hay objetos con la confianza m√≠nima requerida"}),e.jsx("button",{className:"od-button-secondary",onClick:()=>H(.3),children:"Bajar umbral de confianza"})]})]}),e.jsxs("div",{className:"od-stats",children:[e.jsxs("div",{className:"od-stat-card",children:[e.jsx("span",{className:"od-stat-label",children:"Total de objetos"}),e.jsx("span",{className:"od-stat-value",children:j.stats.totalObjects})]}),e.jsxs("div",{className:"od-stat-card",children:[e.jsx("span",{className:"od-stat-label",children:"Tipos √∫nicos"}),e.jsx("span",{className:"od-stat-value",children:j.stats.totalTypes})]}),e.jsxs("div",{className:"od-stat-card",children:[e.jsx("span",{className:"od-stat-label",children:"Confianza promedio"}),e.jsxs("span",{className:"od-stat-value",children:[(j.stats.averageConfidence*100).toFixed(0),"%"]})]})]}),P&&e.jsxs("div",{className:"od-question-type",children:[e.jsx("h3",{children:"Tipo de pregunta:"}),e.jsxs("div",{className:"od-question-options",children:[e.jsxs("label",{className:"od-radio-option",children:[e.jsx("input",{type:"radio",value:"identification",checked:A==="identification",onChange:c=>ee(c.target.value)}),e.jsx("span",{children:"üéØ ¬øQu√© objeto aparece?"})]}),e.jsxs("label",{className:"od-radio-option",children:[e.jsx("input",{type:"radio",value:"counting",checked:A==="counting",onChange:c=>ee(c.target.value)}),e.jsxs("span",{children:["üî¢ ¬øCu√°nto",j.objectCounts[P.name]!==1?"s":""," ",P.name," hay?"]})]})]})]}),m&&e.jsx(se,{intent:"error",children:m}),e.jsxs("div",{className:"od-button-group",children:[P&&e.jsx(C,{onClick:d,className:"od-button-primary",children:"‚úÖ Generar Pregunta"}),e.jsx(C,{variant:"secondary",onClick:()=>Z("upload"),className:"od-button-secondary",children:"‚Üê Volver"}),Q>0&&e.jsxs(C,{variant:"ghost",onClick:O,className:"od-button-secondary",children:["Finalizar (",Q," pregunta",Q!==1?"s":"",")"]})]})]}),J==="preview"&&j&&e.jsxs("div",{className:"od-section",children:[e.jsxs("div",{className:"od-header",children:[e.jsx("h2",{children:"üëÅÔ∏è Editar Pregunta"}),e.jsx("p",{children:"Revisa y edita la pregunta antes de guardarla"})]}),e.jsxs("div",{className:"od-preview-card",children:[e.jsx("img",{src:E,alt:"Question",className:"od-preview-image"}),e.jsxs("div",{className:"od-preview-question",children:[e.jsx("h3",{children:"üìù Pregunta:"}),e.jsx("input",{type:"text",value:z.text,onChange:c=>ae(g=>({...g,text:c.target.value})),className:"od-input",placeholder:"Escribe tu pregunta"})]}),e.jsxs("div",{className:"od-preview-options",children:[e.jsx("h3",{children:"üìã Opciones de Respuesta:"}),e.jsx("div",{className:"od-options-list",children:z.options.map((c,g)=>e.jsxs("div",{className:`od-option-editor ${g===z.correctIndex?"od-selected-correct":""}`,children:[e.jsxs("label",{className:"od-radio-option",children:[e.jsx("input",{type:"radio",name:"correctAnswer",checked:g===z.correctIndex,onChange:()=>ae(l=>({...l,correctIndex:g}))}),e.jsxs("span",{className:"od-option-letter",children:[String.fromCharCode(65+g),"."]})]}),e.jsx("input",{type:"text",value:c,onChange:l=>{const N=[...z.options];N[g]=l.target.value,ae(F=>({...F,options:N}))},className:"od-option-input",placeholder:`Opci√≥n ${g+1}`}),g===z.correctIndex&&e.jsx("span",{className:"od-correct-badge",children:"‚úì Correcta"})]},g))})]}),e.jsxs("div",{className:"od-preview-explanation",children:[e.jsx("h3",{children:"üí° Explicaci√≥n:"}),e.jsx("textarea",{value:z.explanation,onChange:c=>ae(g=>({...g,explanation:c.target.value})),className:"od-explanation-textarea",placeholder:"Explicaci√≥n de la respuesta (opcional)",rows:"3"})]})]}),m&&e.jsx(se,{intent:"error",children:m}),e.jsxs("div",{className:"od-button-group",children:[e.jsx(C,{onClick:f,className:"od-button-primary",children:"üíæ Guardar Pregunta"}),e.jsx(C,{variant:"secondary",onClick:()=>Z("results"),className:"od-button-secondary",children:"‚Üê Volver"}),Q>0&&e.jsxs(C,{variant:"ghost",onClick:O,className:"od-button-secondary",children:["Finalizar (",Q," pregunta",Q!==1?"s":"",")"]})]})]})]})}function _e({open:u,title:$,onClose:x,children:i,className:a=""}){return o.useEffect(()=>{const s=k=>{k.key==="Escape"&&x?.()};u&&document.addEventListener("keydown",s);const S=document.body.style.overflow;return u&&(document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",s),document.body.style.overflow=S}},[u,x]),e.jsx(Te,{children:u&&e.jsxs(ve.div,{className:"fixed inset-0 z-[3000] flex items-center justify-center px-4 py-8",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("button",{"aria-label":"Cerrar",className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:x}),e.jsxs(ve.div,{role:"dialog","aria-modal":"true",className:`relative w-full max-w-2xl max-h-[85vh] overflow-auto rounded-2xl border border-white/10 bg-bb-bg-primary/90 shadow-xl ${a}`,initial:{scale:.98,y:10,opacity:0},animate:{scale:1,y:0,opacity:1},exit:{scale:.98,y:10,opacity:0},transition:{type:"spring",stiffness:200,damping:22},children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 px-6 py-5 border-b border-white/10 bg-bb-bg-primary/90",children:[$?e.jsx("h2",{className:"text-xl md:text-2xl font-bold",children:$}):e.jsx("span",{className:"sr-only",children:"Modal"}),e.jsx("button",{onClick:x,className:"rounded-md p-2 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-bb-primary","aria-label":"Cerrar",children:"‚úï"})]}),e.jsx("div",{className:"px-6 py-5",children:i})]})]})})}const aa=({onQuestionsGenerated:u,onClose:$})=>{const{isVoiceModeEnabled:x,speak:i}=fe(),{user:a}=be(),[s,S]=o.useState([]),[k,B]=o.useState(""),[L,_]=o.useState("medium"),[E,D]=o.useState(null),[R,p]=o.useState(""),[j,w]=o.useState(!1),[m,r]=o.useState(!1),[v,T]=o.useState(!1),[V,H]=o.useState(!1),[P,X]=o.useState(!1),[A,ee]=o.useState(null),[G,oe]=o.useState(""),[J,Z]=o.useState(0),[Q,ie]=o.useState([]),[pe,le]=o.useState(""),[z,ae]=o.useState([]),[ne,ce]=o.useState([]),[t,d]=o.useState(""),[f,b]=o.useState(!1),[O,c]=o.useState(""),[g,l]=o.useState(""),[N,F]=o.useState([]);o.useEffect(()=>{y(),Y()},[]),o.useEffect(()=>{p(typeof E=="number"?String(E):"")},[E]),o.useEffect(()=>{oe(typeof A=="number"?String(A):"")},[A]);const y=async()=>{try{const n=await $e();S(n),n.length>0&&B(n[0])}catch{c("Error obteniendo temas. Por favor intenta de nuevo.")}},Y=async()=>{try{const n=await ke();F(n)}catch{c("No se pudieron cargar los niveles de dificultad. Por favor, intenta de nuevo m√°s tarde.")}},q=async()=>{if(!k){c("Por favor selecciona un tema v√°lido");return}if(!E||E<1){c("Por favor ingresa una cantidad v√°lida de preguntas (m√≠nimo 1)");return}b(!0),c(""),console.log(`ü§ñ Iniciando generaci√≥n de ${E} preguntas sobre "${k}" (dificultad: ${L})...`);try{const n=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",h=a&&a.getIdToken?await a.getIdToken():null;console.log("üì° Enviando solicitud al backend...");const I=await fetch(`${n}/ai/generate-questions`,{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({topic:k,difficulty:L,count:E,useAI:j})});if(console.log(`üì• Respuesta recibida con status ${I.status}`),!I.ok){const re=await I.json();throw new Error(re.error||`Error del servidor: ${I.status}`)}const M=await I.json();if(!M.success||!M.questions||M.questions.length===0)throw new Error(M.error||"Error desconocido al generar preguntas");console.log(`‚úÖ Se generaron ${M.questions.length} preguntas exitosamente`);const K=M.questions.map(re=>({...(()=>{if(!Array.isArray(re.options)||typeof re.correctAnswerIndex!="number")return re;const ue=re.options.map((te,ge)=>({opt:te,origIdx:ge}));for(let te=ue.length-1;te>0;te--){const ge=Math.floor(Math.random()*(te+1));[ue[te],ue[ge]]=[ue[ge],ue[te]]}const Ce=ue.findIndex(te=>te.origIdx===re.correctAnswerIndex);return{...re,options:ue.map(te=>te.opt),correctAnswerIndex:Ce}})(),createdBy:a?.uid||"anon",createdAt:Date.now(),category:k,difficulty:L}));console.log("üíæ Guardando preguntas en Firestore...");const U=a&&a.getIdToken?await a.getIdToken():null,de=await(await fetch(`${n}/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",...U?{Authorization:`Bearer ${U}`}:{}},body:JSON.stringify({questions:K})})).json();if(!de.success)throw new Error(de.error||"Error al guardar las preguntas en la base de datos");console.log("‚úÖ Preguntas guardadas exitosamente"),u(M.questions)}catch(n){console.error("‚ùå Error:",n.message),c(n.message||"Error al generar preguntas. Por favor, intenta nuevamente.")}finally{b(!1)}};return e.jsxs(_e,{open:!0,title:"ü§ñ Generador de Preguntas",onClose:$,children:[x&&!m&&!v&&!V&&!P&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(C,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const n=[];!m&&!j?(n.push("Est√°s en el generador de preguntas."),n.push("Bot√≥n Crear con IA: genera preguntas autom√°ticamente usando inteligencia artificial."),n.push("Bot√≥n Escribir preguntas: te permite escribir preguntas manualmente."),n.push("Selecciona una opci√≥n para continuar.")):j&&!m&&(n.push("Formulario para generar preguntas con inteligencia artificial."),n.push("Campo Tema: selecciona el tema de las preguntas."),n.push("Campo Dificultad: elige la dificultad."),n.push("Campo Cantidad: indica cu√°ntas preguntas quieres generar."),n.push("Bot√≥n Crear preguntas: genera las preguntas."),n.push("Bot√≥n Atr√°s: vuelve a la pantalla anterior.")),await i(n.join(" "),{action:"page_guide",questionId:"ai_question_generator",force:!0})},"aria-label":"Explicar la p√°gina",onFocus:()=>i("Explicar p√°gina: describe la funci√≥n de cada bot√≥n y campo en esta vista.",{force:!0}),onMouseEnter:()=>i("Explicar p√°gina: describe la funci√≥n de cada bot√≥n y campo en esta vista.",{force:!0}),children:"üõà Explicar p√°gina"})}),f&&e.jsx(Ee,{text:"Generando‚Ä¶",mobileOnly:!0}),O&&e.jsx(se,{intent:"error",children:O}),g&&e.jsx(se,{intent:"success",children:g}),!m&&!j&&!v&&!V&&!P&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(C,{onClick:()=>{w(!0),r(!1),T(!1),H(!1),X(!1)},size:"lg",onFocus:()=>x&&i("Crear con IA: genera preguntas autom√°ticamente usando inteligencia artificial.",{force:!0}),onMouseEnter:()=>x&&i("Crear con IA: genera preguntas autom√°ticamente usando inteligencia artificial.",{force:!0}),children:"ü§ñ Crear con IA"}),e.jsx(C,{variant:"secondary",size:"lg",onClick:()=>{r(!0),w(!1),T(!1),H(!1),X(!1),Z(0),ie([])},onFocus:()=>x&&i("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),onMouseEnter:()=>x&&i("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),children:"‚úèÔ∏è Escribir preguntas"}),e.jsx(C,{variant:"secondary",size:"lg",onClick:()=>{T(!0),w(!1),H(!1),X(!1)},onFocus:()=>x&&i("Capturar pregunta: extrae preguntas de im√°genes usando OCR.",{force:!0}),onMouseEnter:()=>x&&i("Capturar pregunta: extrae preguntas de im√°genes usando OCR.",{force:!0}),children:"üì∏ Capturar pregunta"}),e.jsx(C,{variant:"secondary",size:"lg",onClick:()=>{H(!0),w(!1),r(!1),T(!1),X(!1)},onFocus:()=>x&&i("Analizar imagen: genera preguntas autom√°ticamente usando Azure Computer Vision.",{force:!0}),onMouseEnter:()=>x&&i("Analizar imagen: genera preguntas autom√°ticamente usando Azure Computer Vision.",{force:!0}),children:"üñºÔ∏è Analizar imagen"}),e.jsx(C,{variant:"secondary",size:"lg",onClick:()=>{X(!0),w(!1),r(!1),T(!1),H(!1)},onFocus:()=>x&&i("Detectar objetos: crea preguntas interactivas identificando objetos espec√≠ficos en im√°genes.",{force:!0}),onMouseEnter:()=>x&&i("Detectar objetos: crea preguntas interactivas identificando objetos espec√≠ficos en im√°genes.",{force:!0}),children:"üéØ Detectar objetos"})]}),!m&&j&&!v&&e.jsxs("form",{className:"mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4",onSubmit:async n=>{n.preventDefault(),await q()},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"topic",className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{id:"topic",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:k,onChange:n=>B(n.target.value),disabled:s.length===0,children:s.length===0?e.jsx("option",{value:"",children:"No hay temas"}):s.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"difficulty",className:"block mb-1 text-sm text-white/80",children:"Dificultad"}),e.jsxs("select",{id:"difficulty",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:L,onChange:n=>_(n.target.value),children:[e.jsx("option",{value:"easy",children:"F√°cil"}),e.jsx("option",{value:"medium",children:"Media"}),e.jsx("option",{value:"hard",children:"Dif√≠cil"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"numQuestions",className:"block mb-1 text-sm text-white/80",children:"Cantidad"}),e.jsxs("div",{children:[e.jsx(me,{id:"numQuestions",type:"text",inputMode:"numeric",pattern:"[0-9]*",value:R,onChange:n=>{const h=n.target.value.replace(/\D+/g,"");p(h);const I=h?parseInt(h,10):NaN;Number.isNaN(I)?D(null):D(I)},onBlur:()=>{const n=parseInt(R||"",10);if(Number.isNaN(n)||n<1){D(null),p("");return}const h=Math.max(1,n);D(h),p(String(h))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(R===""||E===null)&&e.jsx("div",{className:`mt-1 text-xs ${R===""?"text-white/60":"text-red-300"}`,children:R===""?"Ingresa un n√∫mero (>= 1)":"Valor inv√°lido"})]})]}),O&&e.jsx(se,{intent:"error",className:"sm:col-span-3",children:O}),e.jsxs("div",{className:"sm:col-span-3 mt-2 flex flex-wrap gap-3 justify-end items-center",children:[e.jsx(C,{type:"button",variant:"secondary",onClick:()=>w(!1),disabled:f,onFocus:()=>x&&i("Atr√°s: vuelve a la pantalla anterior.",{force:!0}),onMouseEnter:()=>x&&i("Atr√°s: vuelve a la pantalla anterior.",{force:!0}),children:"Atr√°s"}),e.jsx(C,{type:"submit",disabled:f||!k||E===null,title:k?E===null?"Ingresa la cantidad de preguntas":"Crear preguntas":"Selecciona un tema",onFocus:()=>x&&i("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),onMouseEnter:()=>x&&i("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),children:f?e.jsxs(e.Fragment,{children:[e.jsx(he,{size:16,className:"mr-2"}),"Creando‚Ä¶"]}):"Crear preguntas"})]})]}),m&&e.jsx("div",{className:"mt-2",children:J===0?e.jsxs("form",{className:"grid grid-cols-1 gap-4",onSubmit:n=>{n.preventDefault(),Z(1),ie([]),le(k)},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{value:k,onChange:n=>B(n.target.value),className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",children:s.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"¬øCu√°ntas preguntas?"}),e.jsxs("div",{children:[e.jsx(me,{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:G,onChange:n=>{const h=n.target.value.replace(/\D+/g,"");oe(h);const I=h?parseInt(h,10):NaN;Number.isNaN(I)?ee(null):ee(I)},onBlur:()=>{const n=parseInt(G||"",10);if(Number.isNaN(n)||n<1){ee(null),oe("");return}const h=Math.max(1,n);ee(h),oe(String(h))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(G===""||A===null)&&e.jsx("div",{className:`mt-1 text-xs ${G===""?"text-white/60":"text-red-300"}`,children:G===""?"Ingresa un n√∫mero (>= 1)":"Valor inv√°lido"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(C,{type:"button",variant:"secondary",onClick:()=>r(!1),onFocus:()=>x&&i("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),onMouseEnter:()=>x&&i("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),children:"Volver"}),e.jsx(C,{type:"submit",onFocus:()=>x&&i("Empezar: inicia la creaci√≥n manual de preguntas.",{force:!0}),onMouseEnter:()=>x&&i("Empezar: inicia la creaci√≥n manual de preguntas.",{force:!0}),children:"Empezar"})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"text-center mb-3 font-bold",children:["¬°Vamos! Pregunta ",Q.length+1," de ",A]}),e.jsx(Ae,{topics:[pe],onQuestionCreated:async n=>{try{b(!0),c("");const h=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api";if(!a||!a.getIdToken)throw new Error("Debes iniciar sesi√≥n para crear preguntas");const I=await a.getIdToken(),M=await fetch(`${h}/questions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify(n)}),K=await M.json();if(!M.ok)throw new Error(K.error||"Error al guardar la pregunta");const U=K.question||{...n},W=[...Q,{...U,category:pe}];if(W.length===A){const de=await fetch(`${h}/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify({questions:W})}),re=await de.json();if(!de.ok)throw new Error(re.error||"Error al guardar las preguntas en lote");return u&&u(W),l("¬°Todas las preguntas han sido guardadas exitosamente!"),setTimeout(()=>{r(!1),l("")},1500),W}else return ie(W),Z(de=>de+1),l(`¬°Pregunta ${W.length} de ${A} guardada exitosamente!`),setTimeout(()=>l(""),1500),U}catch(h){c("No se pudo guardar la pregunta: "+(h.message||"Por favor, intenta de nuevo."))}finally{b(!1)}},onCancel:()=>{r(!1)}})]})}),v&&e.jsx(Se,{topics:s,onQuestionExtracted:async n=>{b(!0),c("");try{const h=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",I=a&&a.getIdToken?await a.getIdToken():null,M=await fetch(`${h}/questions`,{method:"POST",headers:{"Content-Type":"application/json",...I?{Authorization:`Bearer ${I}`}:{}},body:JSON.stringify(n)});if(M.ok){const U=(await M.json()).question||{...n},W=[...z,U];ae(W),l(`‚úÖ Pregunta ${W.length} guardada exitosamente. Puedes agregar m√°s o finalizar.`),b(!1)}else c("No se pudo guardar la pregunta"),b(!1)}catch(h){c("Error al guardar la pregunta: "+(h.message||"Por favor, intenta de nuevo.")),b(!1)}},onCancel:()=>{T(!1),z.length>0&&(l(`‚úÖ Se guardaron ${z.length} pregunta(s) de OCR`),setTimeout(()=>{u(z),ae([]),l("")},1500))}}),V&&e.jsx(Be,{topics:s,onQuestionCreated:async n=>{b(!0),c("");try{const h=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",I=a&&a.getIdToken?await a.getIdToken():null,M=await fetch(`${h}/questions`,{method:"POST",headers:{"Content-Type":"application/json",...I?{Authorization:`Bearer ${I}`}:{}},body:JSON.stringify(n)}),K=await M.json();if(!M.ok)throw new Error(K.error||"No se pudo guardar la pregunta");const U=K.question||{...n},W=[...ne,U];return ce(W),l(`‚úÖ Pregunta ${W.length} guardada desde an√°lisis de imagen`),U}catch(h){throw c("Error al guardar la pregunta: "+(h.message||"Intenta de nuevo.")),h}finally{b(!1)}},onCancel:()=>{H(!1),ne.length>0&&(l(`‚úÖ Se guardaron ${ne.length} pregunta(s) desde an√°lisis de imagen`),setTimeout(()=>{u(ne),ce([]),l("")},1500))}}),P&&e.jsx(Le,{topics:s,onQuestionCreated:async n=>{b(!0),c("");try{const h=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",I=a&&a.getIdToken?await a.getIdToken():null,M=await fetch(`${h}/questions`,{method:"POST",headers:{"Content-Type":"application/json",...I?{Authorization:`Bearer ${I}`}:{}},body:JSON.stringify(n)}),K=await M.json();if(!M.ok)throw new Error(K.error||"No se pudo guardar la pregunta");const U=K.question||{...n},W=[...ne,U];return ce(W),l("‚úÖ Pregunta guardada. Puedes crear otra o finalizar."),setTimeout(()=>{l("")},2e3),U}catch(h){throw c("Error al guardar la pregunta: "+(h.message||"Intenta de nuevo.")),h}finally{b(!1)}},onCancel:()=>{X(!1),setTimeout(()=>{u(ne),ce([]),l("")},300)}})]})};export{aa as default};
//# sourceMappingURL=AIQuestionGenerator-80P0KPaB.js.map
