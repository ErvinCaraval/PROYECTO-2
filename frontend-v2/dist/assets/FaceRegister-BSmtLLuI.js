import{r as c,u as B,b as I,j as e}from"./index-BOaVjrce.js";import{B as f}from"./Button-D2tu_0bI.js";import{A as k}from"./Alert-BchDzBqE.js";import{F as S,o as A,g as y}from"./imageOptimizer-BDifxBkI.js";function L(){const[E,n]=c.useState(""),[v,m]=c.useState(""),[l,h]=c.useState(!1),[x,p]=c.useState(null),[b,g]=c.useState(null),{user:o}=B(),d=I(),[N,w]=c.useState(!1),T=async a=>{try{const r=await A(a,300,300,.6),s=y(a),i=y(r);console.log(`Imagen optimizada: ${s}KB â†’ ${i}KB (${Math.round((1-i/s)*100)}% reducciÃ³n)`),p(r),g(r)}catch(r){console.error("Error optimizando imagen, usando original:",r),p(a),g(a)}},C=()=>{p(null),g(null),n(""),m("")},R=async()=>{if(!x){n("Por favor, captura una foto primero");return}if(!o){n("Debes estar autenticado para registrar tu cara. Redirigiendo al login..."),setTimeout(()=>{d("/login")},2e3);return}h(!0),n(""),m("");try{console.log("1. Iniciando registro facial...");let a;try{a=await o.getIdToken(),console.log("2. Token obtenido correctamente")}catch(t){throw console.error("Error obteniendo token:",t),new Error("No se pudo obtener el token de autenticaciÃ³n. Por favor, inicia sesiÃ³n nuevamente.")}const r="http://localhost:5000";console.log("3. API URL:",r),console.log("4. TamaÃ±o de imagen:",x.length,"caracteres");const s=new AbortController,i=setTimeout(()=>s.abort(),6e4);try{console.log("5. Enviando peticiÃ³n al backend...");const t=await fetch(`${r}/api/face/register`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({image:x,token:a}),signal:s.signal});clearTimeout(i),console.log("6. Respuesta recibida. Status:",t.status);const j=t.headers.get("content-type");if(!j||!j.includes("application/json")){const $=await t.text();throw console.error("Respuesta no es JSON:",$.substring(0,200)),new Error(`El servidor devolviÃ³ un error (${t.status}). Verifica la consola para mÃ¡s detalles.`)}const u=await t.json();if(console.log("7. Datos JSON parseados:",u),!t.ok)throw console.error("Respuesta no OK:",u),new Error(u.error||`Error en el servidor (${t.status})`);if(u.success)console.log("8. Registro facial exitoso!"),m("Â¡Registro facial completado exitosamente!"),setTimeout(()=>{o!=null&&o.displayName?d("/dashboard"):d("/complete-profile")},2e3);else throw new Error(u.error||"Error en el registro")}catch(t){throw clearTimeout(i),t.name==="AbortError"?(console.error("Timeout en la peticiÃ³n"),new Error("La peticiÃ³n tardÃ³ demasiado tiempo. Intenta con una imagen mÃ¡s pequeÃ±a.")):t instanceof TypeError?(console.error("Error de conexiÃ³n:",t),new Error(`No se pudo conectar al servidor (${r}). Verifica que estÃ© activo.`)):t}}catch(a){const r=a.message||"Error al registrar la cara. Por favor, intenta de nuevo.";n(r),console.error("Error en registro facial:",a)}finally{h(!1)}};c.useEffect(()=>{(async()=>{if(!o)return w(!1);try{const r=await o.getIdToken(),t=await(await fetch("http://localhost:5000/api/face/exists",{method:"GET",headers:{Authorization:`Bearer ${r}`}})).json();w(!!t.exists)}catch(r){console.error("Error checking face registration:",r)}})()},[o]);const z=async()=>{if(!o){n("Debes estar autenticado para eliminar tu registro facial");return}if(confirm("Â¿EstÃ¡s seguro de eliminar tu registro facial? Esta acciÃ³n no se puede deshacer.")){h(!0);try{const a=await o.getIdToken(),s=await fetch(`http://localhost:5000/api/face/${o.uid}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}}),i=await s.json();if(!s.ok)throw new Error(i.error||"Error eliminando registro facial");m("Registro facial eliminado correctamente"),w(!1),g(null),p(null)}catch(a){n(a.message||"Error eliminando registro facial")}finally{h(!1)}}};return e.jsx("div",{className:"container min-h-screen px-4 py-10",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-extrabold",children:"ğŸ“¸ Registro Facial"}),e.jsx("p",{className:"text-white/70 mt-2",children:o?"Captura una foto de tu rostro para habilitar el login facial":"Paso 2: Captura una foto de tu rostro para completar tu registro"}),!o&&e.jsx("p",{className:"text-white/50 text-sm mt-1",children:"Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6",children:[E&&e.jsx(k,{intent:"error",className:"mb-4",children:E}),v&&e.jsx(k,{intent:"success",className:"mb-4",children:v}),b?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative bg-black rounded-lg overflow-hidden",children:e.jsx("img",{src:b,alt:"Foto capturada",className:"w-full h-auto max-h-[480px] mx-auto"})}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(f,{onClick:C,variant:"outline",disabled:l,size:"lg",children:"ğŸ”„ Tomar Otra Foto"}),e.jsx(f,{onClick:R,disabled:l,size:"lg",children:l?"Registrando...":"âœ… Registrar Cara"})]})]}):e.jsx(S,{onCapture:T,onCancel:()=>d("/dashboard"),disabled:l,buttonText:"ğŸ“· Capturar Foto",showCancel:!0}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(f,{onClick:()=>d("/dashboard"),variant:"ghost",size:"sm",children:"â† Volver al Dashboard"}),N&&e.jsx(f,{onClick:z,variant:"destructive",size:"sm",disabled:l,children:"ğŸ—‘ï¸ Eliminar registro facial"})]})})]})]})})}export{L as default};
//# sourceMappingURL=FaceRegister-BSmtLLuI.js.map
