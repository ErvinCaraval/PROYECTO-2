{"version":3,"file":"FaceRegister-BkcUQhiD.js","sources":["../../src/services/faceCache.js","../../src/pages/FaceRegister.jsx"],"sourcesContent":["/**\n * Servicio de caching local para embeddings faciales\n * Almacena embeddings en IndexedDB para r√°pida verificaci√≥n de login\n */\n\nconst DB_NAME = 'BrainBlitzFaceDB';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'faceEmbeddings';\n\n/**\n * Abre la base de datos IndexedDB\n */\nfunction openDB() {\n  return new Promise((resolve, reject) => {\n    const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n    request.onerror = () => reject(request.error);\n    request.onsuccess = () => resolve(request.result);\n\n    request.onupgradeneeded = (event) => {\n      const db = event.target.result;\n      if (!db.objectStoreNames.contains(STORE_NAME)) {\n        db.createObjectStore(STORE_NAME, { keyPath: 'email' });\n      }\n    };\n  });\n}\n\n/**\n * Guarda embeddings faciales en cache local\n * @param {string} email - Email del usuario\n * @param {Array} embeddings - Array de embeddings\n * @param {object} metadata - Informaci√≥n adicional (timestamp, etc)\n */\nexport async function cacheFaceEmbeddings(email, embeddings, metadata = {}) {\n  try {\n    const db = await openDB();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    const data = {\n      email,\n      embeddings,\n      timestamp: Date.now(),\n      ...metadata\n    };\n\n    return new Promise((resolve, reject) => {\n      const request = store.put(data);\n      request.onsuccess = () => {\n        console.log(`‚úì Embeddings cacheados para ${email}`);\n        resolve(data);\n      };\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error('Error cacheando embeddings:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene embeddings faciales del cache local\n * @param {string} email - Email del usuario\n * @returns {object|null} Datos con embeddings o null\n */\nexport async function getCachedFaceEmbeddings(email) {\n  try {\n    const db = await openDB();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n\n    return new Promise((resolve, reject) => {\n      const request = store.get(email);\n      request.onsuccess = () => {\n        const data = request.result;\n        if (data) {\n          console.log(`‚úì Embeddings encontrados en cache para ${email}`);\n          resolve(data);\n        } else {\n          resolve(null);\n        }\n      };\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error('Error obteniendo embeddings del cache:', error);\n    return null;\n  }\n}\n\n/**\n * Elimina embeddings faciales del cache local\n * @param {string} email - Email del usuario\n */\nexport async function deleteCachedFaceEmbeddings(email) {\n  try {\n    const db = await openDB();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    return new Promise((resolve, reject) => {\n      const request = store.delete(email);\n      request.onsuccess = () => {\n        console.log(`‚úì Embeddings eliminados del cache para ${email}`);\n        resolve(true);\n      };\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error('Error eliminando embeddings del cache:', error);\n    throw error;\n  }\n}\n\n/**\n * Limpia todo el cache local\n */\nexport async function clearFaceCache() {\n  try {\n    const db = await openDB();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    return new Promise((resolve, reject) => {\n      const request = store.clear();\n      request.onsuccess = () => {\n        console.log('‚úì Cache facial limpiado completamente');\n        resolve(true);\n      };\n      request.onerror = () => reject(request.error);\n    });\n  } catch (error) {\n    console.error('Error limpiando cache:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene informaci√≥n del cache (tama√±o, cantidad de entradas)\n */\nexport async function getFaceCacheInfo() {\n  try {\n    const db = await openDB();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n\n    return new Promise((resolve, reject) => {\n      const countRequest = store.count();\n      countRequest.onsuccess = () => {\n        const count = countRequest.result;\n        console.log(`‚Ñπ Cache: ${count} embeddings almacenados`);\n        resolve({\n          count,\n          dbName: DB_NAME,\n          storeName: STORE_NAME\n        });\n      };\n      countRequest.onerror = () => reject(countRequest.error);\n    });\n  } catch (error) {\n    console.error('Error obteniendo info del cache:', error);\n    return { count: 0, error: error.message };\n  }\n}\n","import React, { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuth } from '../AuthContext';\nimport Button from '../components/ui/Button';\nimport Alert from '../components/ui/Alert';\nimport FaceCaptureCamera from '../components/FaceCaptureCamera';\nimport { optimizeImage, getImageSize, optimizeImageUltra } from '../utils/imageOptimizer';\nimport { cacheFaceEmbeddings } from '../services/faceCache';\n\nexport default function FaceRegister() {\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [progress, setProgress] = useState('');\n  const [capturedImage, setCapturedImage] = useState(null);\n  const [preview, setPreview] = useState(null);\n  const [useUltraCompression, setUseUltraCompression] = useState(false); // Opci√≥n nueva\n  \n  const { user } = useAuth();\n  const navigate = useNavigate();\n  const [hasRegistration, setHasRegistration] = useState(false);\n\n  const handleCapture = async (base64String) => {\n    try {\n      setProgress('Optimizando imagen...');\n      // Seleccionar nivel de compresi√≥n\n      const optimized = useUltraCompression\n        ? await optimizeImageUltra(base64String)  // 160x160, calidad 0.2 - ULTRA\n        : await optimizeImage(base64String, 200, 200, 0.3);  // 200x200, calidad 0.3 - Est√°ndar\n      \n      const originalSize = getImageSize(base64String);\n      const optimizedSize = getImageSize(optimized);\n      const reduction = Math.round((1 - optimizedSize/originalSize) * 100);\n      console.log(`‚úì Imagen optimizada (${useUltraCompression ? 'ULTRA' : 'EST√ÅNDAR'}): ${originalSize}KB ‚Üí ${optimizedSize}KB (${reduction}% reducci√≥n)`);\n      setCapturedImage(optimized);\n      setPreview(optimized);\n      setProgress('');\n    } catch (error) {\n      console.error('Error optimizando imagen, usando original:', error);\n      setCapturedImage(base64String);\n      setPreview(base64String);\n      setProgress('');\n    }\n  };\n\n  const retakePhoto = () => {\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  const registerFace = async () => {\n    if (!capturedImage) {\n      setError('Por favor, captura una foto primero');\n      return;\n    }\n\n    if (!user) {\n      setError('Debes estar autenticado para registrar tu cara. Redirigiendo al login...');\n      setTimeout(() => {\n        navigate('/login');\n      }, 2000);\n      return;\n    }\n\n    setLoading(true);\n    setProgress('Preparando registro...');\n    setError('');\n    setSuccess('');\n\n    try {\n      console.log('1. Iniciando registro facial...');\n      \n      // Obtener token de Firebase\n      let token;\n      try {\n        setProgress('Obteniendo autenticaci√≥n...');\n        token = await user.getIdToken();\n        console.log('2. Token obtenido correctamente');\n      } catch (tokenErr) {\n        console.error('Error obteniendo token:', tokenErr);\n        throw new Error('No se pudo obtener el token de autenticaci√≥n. Por favor, inicia sesi√≥n nuevamente.');\n      }\n\n      // Obtener URL base de la API\n      const apiBase = (typeof window !== 'undefined' && window.ENV?.VITE_API_URL) || import.meta.env.VITE_API_URL || 'http://localhost:5000/api';\n      console.log('3. API URL:', apiBase);\n      console.log('4. Tama√±o de imagen:', capturedImage.length, 'caracteres');\n\n      // Crear un timeout para la petici√≥n (30 segundos - ULTRA OPTIMIZADO)\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout\n\n      try {\n        console.log('5. Enviando petici√≥n al backend...');\n        setProgress('Enviando imagen...');\n        // Comprimir payload para env√≠o m√°s r√°pido\n        const payload = JSON.stringify({\n          image: capturedImage,\n          token: token\n        });\n        console.log(`Tama√±o del payload: ${(payload.length / 1024).toFixed(2)}KB`);\n        \n        // Enviar imagen al backend\n        const response = await fetch(`${apiBase}/face/register`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${token}`,\n            'Accept-Encoding': 'gzip, deflate' // Permitir compresi√≥n\n          },\n          body: payload,\n          signal: controller.signal,\n          priority: 'high' // Prioridad alta de red\n        });\n\n        clearTimeout(timeoutId);\n        console.log('6. Respuesta recibida. Status:', response.status);\n        setProgress('Procesando resultado...');\n\n        // Verificar que la respuesta sea JSON\n        const contentType = response.headers.get('content-type');\n        if (!contentType || !contentType.includes('application/json')) {\n          const text = await response.text();\n          console.error('Respuesta no es JSON:', text.substring(0, 200));\n          throw new Error(`El servidor devolvi√≥ un error (${response.status}). Verifica la consola para m√°s detalles.`);\n        }\n\n        const data = await response.json();\n        console.log('7. Datos JSON parseados:', data);\n\n        if (!response.ok) {\n          console.error('Respuesta no OK:', data);\n          throw new Error(data.error || `Error en el servidor (${response.status})`);\n        }\n\n        if (data.success) {\n          console.log('8. Registro facial exitoso!');\n          setSuccess('¬°Registro facial completado exitosamente!');\n          setProgress('');\n          \n          // Cachear embeddings localmente si est√°n disponibles (para login r√°pido)\n          if (data.embeddings && user?.email) {\n            try {\n              await cacheFaceEmbeddings(user.email, data.embeddings, {\n                registrationDate: new Date().toISOString()\n              });\n            } catch (cacheErr) {\n              console.warn('No se pudo cachear embeddings, pero el registro fue exitoso:', cacheErr);\n            }\n          }\n          \n          // Redirigir a completar perfil o dashboard despu√©s de 2 segundos\n          setTimeout(() => {\n            // Verificar si el usuario tiene displayName, si no, ir a complete-profile\n            if (!user?.displayName) {\n              navigate('/complete-profile');\n            } else {\n              navigate('/dashboard');\n            }\n          }, 2000);\n        } else {\n          throw new Error(data.error || 'Error en el registro');\n        }\n      } catch (fetchErr) {\n        clearTimeout(timeoutId);\n        \n        if (fetchErr.name === 'AbortError') {\n          console.error('Timeout en la petici√≥n');\n          throw new Error('La petici√≥n tard√≥ demasiado tiempo. Intenta con una imagen m√°s peque√±a.');\n        }\n        \n        if (fetchErr instanceof TypeError) {\n          console.error('Error de conexi√≥n:', fetchErr);\n          throw new Error(`No se pudo conectar al servidor (${apiBase}). Verifica que est√© activo.`);\n        }\n        \n        throw fetchErr;\n      }\n    } catch (err) {\n      const errorMsg = err.message || 'Error al registrar la cara. Por favor, intenta de nuevo.';\n      setError(errorMsg);\n      console.error('Error en registro facial:', err);\n    } finally {\n      setLoading(false);\n      setProgress('');\n    }\n  };\n\n  // Check if current user already has a facial registration\n  useEffect(() => {\n    const check = async () => {\n      if (!user) return setHasRegistration(false);\n      try {\n        const token = await user.getIdToken();\n        const apiBase = (typeof window !== 'undefined' && window.ENV?.VITE_API_URL) || import.meta.env.VITE_API_URL || 'http://localhost:5000/api';\n        const res = await fetch(`${apiBase}/face/exists`, {\n          method: 'GET',\n          headers: { Authorization: `Bearer ${token}` }\n        });\n        const data = await res.json();\n        setHasRegistration(!!data.exists);\n      } catch (err) {\n        console.error('Error checking face registration:', err);\n      }\n    };\n    check();\n  }, [user]);\n\n  const deleteFaceRegistration = async () => {\n    if (!user) {\n      setError('Debes estar autenticado para eliminar tu registro facial');\n      return;\n    }\n    if (!confirm('¬øEst√°s seguro de eliminar tu registro facial? Esta acci√≥n no se puede deshacer.')) return;\n\n    setLoading(true);\n    try {\n      const token = await user.getIdToken();\n      const apiBase = (typeof window !== 'undefined' && window.ENV?.VITE_API_URL) || import.meta.env.VITE_API_URL || 'http://localhost:5000/api';\n      const res = await fetch(`${apiBase}/face/${user.uid}`, {\n        method: 'DELETE',\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data.error || 'Error eliminando registro facial');\n      setSuccess('Registro facial eliminado correctamente');\n      setHasRegistration(false);\n      setPreview(null);\n      setCapturedImage(null);\n    } catch (err) {\n      setError(err.message || 'Error eliminando registro facial');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"container min-h-screen px-4 py-10\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"text-center mb-6\">\n          <h1 className=\"text-3xl font-extrabold\">üì∏ Registro Facial</h1>\n          <p className=\"text-white/70 mt-2\">\n            {user ? \n              'Captura una foto de tu rostro para habilitar el login facial' :\n              'Paso 2: Captura una foto de tu rostro para completar tu registro'\n            }\n          </p>\n          {!user && (\n            <p className=\"text-white/50 text-sm mt-1\">\n              Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial\n            </p>\n          )}\n          \n          {/* Opci√≥n de compresi√≥n ultra para conexiones lentas */}\n          <div className=\"mt-4 flex items-center justify-center gap-2\">\n            <label className=\"flex items-center gap-2 text-sm text-white/70 cursor-pointer hover:text-white\">\n              <input\n                type=\"checkbox\"\n                checked={useUltraCompression}\n                onChange={(e) => setUseUltraCompression(e.target.checked)}\n                disabled={loading}\n                className=\"w-4 h-4 accent-bb-primary cursor-pointer\"\n              />\n              <span>üöÄ Compresi√≥n Ultra (si es muy lento)</span>\n            </label>\n          </div>\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6\">\n          {error && <Alert intent=\"error\" className=\"mb-4\">{error}</Alert>}\n          {success && <Alert intent=\"success\" className=\"mb-4\">{success}</Alert>}\n          {progress && <Alert intent=\"info\" className=\"mb-4\">‚è≥ {progress}</Alert>}\n\n          {!preview ? (\n            <FaceCaptureCamera\n              onCapture={handleCapture}\n              onCancel={() => navigate('/dashboard')}\n              disabled={loading}\n              buttonText=\"üì∑ Capturar Foto\"\n              showCancel={true}\n            />\n          ) : (\n            <div className=\"space-y-4\">\n              {/* Preview de la foto capturada */}\n              <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                <img\n                  src={preview}\n                  alt=\"Foto capturada\"\n                  className=\"w-full h-auto max-h-[480px] mx-auto\"\n                />\n              </div>\n\n              {/* Botones de acci√≥n */}\n              <div className=\"flex gap-4 justify-center\">\n                <Button\n                  onClick={retakePhoto}\n                  variant=\"outline\"\n                  disabled={loading}\n                  size=\"lg\"\n                >\n                  üîÑ Tomar Otra Foto\n                </Button>\n                <Button\n                  onClick={registerFace}\n                  disabled={loading}\n                  size=\"lg\"\n                >\n                  {loading ? '‚è≥ Registrando...' : '‚úÖ Registrar Cara'}\n                </Button>\n              </div>\n            </div>\n          )}\n\n          <div className=\"mt-6 text-center\">\n            <div className=\"flex items-center justify-center gap-3\">\n              <Button\n                onClick={() => navigate('/dashboard')}\n                variant=\"ghost\"\n                size=\"sm\"\n              >\n                ‚Üê Volver al Dashboard\n              </Button>\n\n              {hasRegistration && (\n                <Button\n                  onClick={deleteFaceRegistration}\n                  variant=\"destructive\"\n                  size=\"sm\"\n                  disabled={loading}\n                >\n                  üóëÔ∏è Eliminar registro facial\n                </Button>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":["DB_NAME","DB_VERSION","STORE_NAME","openDB","resolve","reject","request","event","db","cacheFaceEmbeddings","email","embeddings","metadata","store","data","error","FaceRegister","setError","useState","success","setSuccess","loading","setLoading","progress","setProgress","capturedImage","setCapturedImage","preview","setPreview","useUltraCompression","setUseUltraCompression","user","useAuth","navigate","useNavigate","hasRegistration","setHasRegistration","handleCapture","base64String","optimized","optimizeImageUltra","optimizeImage","originalSize","getImageSize","optimizedSize","reduction","retakePhoto","registerFace","token","tokenErr","apiBase","controller","timeoutId","payload","response","contentType","text","cacheErr","fetchErr","err","errorMsg","useEffect","deleteFaceRegistration","res","jsxs","jsx","e","Alert","Button","FaceCaptureCamera"],"mappings":"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"}