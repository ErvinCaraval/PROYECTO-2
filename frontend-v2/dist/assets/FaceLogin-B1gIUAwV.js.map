{"version":3,"file":"FaceLogin-B1gIUAwV.js","sources":["../../src/pages/FaceLogin.jsx"],"sourcesContent":["import React, { useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { signInWithCustomToken } from 'firebase/auth';\nimport { auth } from '../services/firebase';\nimport Button from '../components/ui/Button';\nimport Input from '../components/ui/Input';\nimport Alert from '../components/ui/Alert';\nimport FaceCaptureCamera from '../components/FaceCaptureCamera';\nimport { optimizeImage, getImageSize, optimizeImageUltra } from '../utils/imageOptimizer';\nimport { getCachedFaceEmbeddings } from '../services/faceCache';\n\nexport default function FaceLogin() {\n  const [email, setEmail] = useState('');\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [progress, setProgress] = useState('');\n  const [capturedImage, setCapturedImage] = useState(null);\n  const [preview, setPreview] = useState(null);\n  const [step, setStep] = useState('email'); // 'email' o 'capture'\n  const [useUltraCompression, setUseUltraCompression] = useState(false); // Opci√≥n nueva\n  \n  const navigate = useNavigate();\n\n  const handleCapture = async (base64String) => {\n    try {\n      setProgress('Optimizando imagen...');\n      // Seleccionar nivel de compresi√≥n\n      const optimized = useUltraCompression\n        ? await optimizeImageUltra(base64String)  // 160x160, calidad 0.2 - ULTRA\n        : await optimizeImage(base64String, 200, 200, 0.3);  // 200x200, calidad 0.3 - Est√°ndar\n      const originalSize = getImageSize(base64String);\n      const optimizedSize = getImageSize(optimized);\n      const reduction = Math.round((1 - optimizedSize/originalSize) * 100);\n      console.log(`‚úì Imagen optimizada: ${originalSize}KB ‚Üí ${optimizedSize}KB (${reduction}% reducci√≥n)`);\n      setCapturedImage(optimized);\n      setPreview(optimized);\n      setProgress('');\n    } catch (error) {\n      console.error('Error optimizando imagen, usando original:', error);\n      setCapturedImage(base64String);\n      setPreview(base64String);\n      setProgress('');\n    }\n  };\n\n  const retakePhoto = () => {\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  const handleEmailSubmit = (e) => {\n    e.preventDefault();\n    if (!email) {\n      setError('Por favor, ingresa tu email');\n      return;\n    }\n    setError('');\n    setStep('capture');\n  };\n\n  const loginWithFace = async () => {\n    if (!capturedImage) {\n      setError('Por favor, captura una foto primero');\n      return;\n    }\n\n    if (!email) {\n      setError('Email requerido');\n      setStep('email');\n      return;\n    }\n\n    setLoading(true);\n    setProgress('Enviando imagen...');\n    setError('');\n    setSuccess('');\n\n    try {\n      // Obtener URL base de la API\n      const apiBase = import.meta.env.VITE_API_URL || 'http://localhost:5000';\n\n      // Enviar imagen al backend para verificaci√≥n\n      setProgress('Verificando rostro...');\n      const payload = JSON.stringify({\n        image: capturedImage,\n        email: email\n      });\n      console.log(`Tama√±o del payload: ${(payload.length / 1024).toFixed(2)}KB`);\n      \n      const response = await fetch(`${apiBase}/face/login`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept-Encoding': 'gzip, deflate' // Permitir compresi√≥n\n        },\n        body: payload,\n        priority: 'high' // Prioridad alta de red\n      });\n\n      // Verificar que la respuesta sea JSON\n      const contentType = response.headers.get('content-type');\n      if (!contentType || !contentType.includes('application/json')) {\n        const text = await response.text();\n        console.error('Respuesta no es JSON:', text.substring(0, 200));\n        throw new Error(`El servidor devolvi√≥ un error. Verifica que el backend est√© corriendo en ${apiBase}`);\n      }\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Error en el login facial');\n      }\n\n      if (data.success && data.verified) {\n        // Login exitoso - usar el customToken para autenticar\n        if (data.customToken) {\n          setProgress('Autenticando...');\n          await signInWithCustomToken(auth, data.customToken);\n          setSuccess('¬°Login facial exitoso! Redirigiendo...');\n          \n          // Redirigir despu√©s de 1 segundo\n          setTimeout(() => {\n            navigate('/dashboard');\n          }, 1000);\n        } else {\n          throw new Error('No se recibi√≥ token de autenticaci√≥n');\n        }\n      } else {\n        throw new Error(data.error || 'Las caras no coinciden. Acceso denegado.');\n      }\n    } catch (err) {\n      setError(err.message || 'Error al verificar la cara. Por favor, intenta de nuevo.');\n      console.error('Error en login facial:', err);\n    } finally {\n      setLoading(false);\n      setProgress('');\n    }\n  };\n\n  const backToEmail = () => {\n    setStep('email');\n    setCapturedImage(null);\n    setPreview(null);\n    setError('');\n    setSuccess('');\n  };\n\n  return (\n    <div className=\"container min-h-screen px-4 py-10\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"text-center mb-6\">\n          <h1 className=\"text-3xl font-extrabold\">üîê Login Facial</h1>\n          <p className=\"text-white/70 mt-2\">\n            Inicia sesi√≥n usando reconocimiento facial\n          </p>\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6\">\n          {error && <Alert intent=\"error\" className=\"mb-4\">{error}</Alert>}\n          {success && <Alert intent=\"success\" className=\"mb-4\">{success}</Alert>}\n          {progress && <Alert intent=\"info\" className=\"mb-4\">‚è≥ {progress}</Alert>}\n\n          {step === 'email' ? (\n            <form onSubmit={handleEmailSubmit} className=\"space-y-4\">\n              <div>\n                <label className=\"block mb-1 text-sm text-white/80\" htmlFor=\"email\">\n                  Correo electr√≥nico\n                </label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"t√∫@correo.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  disabled={loading}\n                />\n              </div>\n\n              <Button type=\"submit\" size=\"lg\" disabled={loading} className=\"w-full\">\n                Continuar con Login Facial\n              </Button>\n            </form>\n          ) : (\n            <div className=\"space-y-4\">\n              {!preview ? (\n                <FaceCaptureCamera\n                  onCapture={handleCapture}\n                  onCancel={backToEmail}\n                  disabled={loading}\n                  buttonText=\"üì∑ Capturar Foto\"\n                  showCancel={true}\n                />\n              ) : (\n                <>\n                  {/* Preview de la foto capturada */}\n                  <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                    <img\n                      src={preview}\n                      alt=\"Foto capturada\"\n                      className=\"w-full h-auto max-h-[480px] mx-auto\"\n                    />\n                  </div>\n\n                  {/* Botones de acci√≥n */}\n                  <div className=\"flex gap-4 justify-center\">\n                    <Button\n                      onClick={retakePhoto}\n                      variant=\"outline\"\n                      disabled={loading}\n                      size=\"lg\"\n                    >\n                      üîÑ Tomar Otra Foto\n                    </Button>\n                    <Button\n                      onClick={loginWithFace}\n                      disabled={loading}\n                      size=\"lg\"\n                    >\n                      {loading ? '‚è≥ Verificando...' : '‚úÖ Verificar y Login'}\n                    </Button>\n                  </div>\n                </>\n              )}\n            </div>\n          )}\n\n          <div className=\"mt-6 text-center space-y-2\">\n            {step === 'email' && (\n              <Button\n                onClick={() => navigate('/login')}\n                variant=\"ghost\"\n                size=\"sm\"\n              >\n                ‚Üê Volver a Login Normal\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":["FaceLogin","email","setEmail","useState","error","setError","success","setSuccess","loading","setLoading","progress","setProgress","capturedImage","setCapturedImage","preview","setPreview","step","setStep","useUltraCompression","setUseUltraCompression","navigate","useNavigate","handleCapture","base64String","optimized","optimizeImageUltra","optimizeImage","originalSize","getImageSize","optimizedSize","reduction","retakePhoto","handleEmailSubmit","e","loginWithFace","apiBase","payload","response","contentType","text","data","signInWithCustomToken","auth","err","backToEmail","jsxs","Alert","jsx","Input","Button","Fragment","FaceCaptureCamera"],"mappings":"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"}