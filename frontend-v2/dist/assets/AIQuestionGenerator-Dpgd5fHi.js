import{a as ee,u as te,r,j as e}from"./index-CGdjcbgg.js";import{B as j}from"./Button-BVl7jPIk.js";import{I as J}from"./Input-BhfJptjA.js";import{A as D}from"./Alert-CiOSpG0n.js";import{O as le}from"./OCRQuestionCapture-BoRzf-2s.js";import{a as ce,b as ue}from"./api-DoyG0mL_.js";import{A as de}from"./Skeleton-Cg2gbrAn.js";import{m as Z}from"./socket-DMrvrCBC.js";import{L as pe,S as me}from"./LoadingOverlay-BPWbBUhW.js";const ge=({topics:h,onQuestionCreated:T,onCancel:o})=>{const{isVoiceModeEnabled:n,speak:i}=ee(),{user:w}=te(),[d,g]=r.useState({question:"",options:["","","",""],correctIndex:0,selectedTopic:h[0]||""}),[q,k]=r.useState(""),[C,S]=r.useState(!1),[M,N]=r.useState(""),P=(a,c)=>{g(p=>({...p,options:p.options.map((I,v)=>v===a?c:I)}))},E=r.useCallback(()=>d.question.trim()?d.options.some(a=>!a.trim())?"Todas las opciones son requeridas":"":"La pregunta es requerida",[d]);r.useEffect(()=>{const a=E();k(a)},[d,w,E]);const z=async a=>{a.preventDefault();const c=E();if(c){k(c);return}S(!0),k(""),N("");try{const p={text:d.question,options:d.options,correctAnswerIndex:d.correctIndex,category:d.selectedTopic,explanation:""};if(N("Guardando..."),T){const I=await Promise.resolve(T(p)),v=I&&I.text?I.text:p.text;N(`Pregunta creada: "${v}"`)}else N("Â¡Pregunta preparada!")}catch(p){console.error("Error al preparar la pregunta:",p),k(p.message||"Error al guardar la pregunta")}finally{S(!1)}};return e.jsxs("form",{className:"grid gap-4",onSubmit:z,children:[n&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(j,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const a=[];a.push("Formulario para escribir preguntas manualmente."),a.push("Campo Tema: selecciona el tema de la pregunta."),a.push("Campo Pregunta: escribe el texto de la pregunta."),a.push("Opciones: escribe las posibles respuestas. Marca cuÃ¡l es la correcta con el botÃ³n de opciÃ³n."),a.push("BotÃ³n AtrÃ¡s: vuelve al generador de preguntas."),a.push("BotÃ³n Guardar: guarda la pregunta actual."),await i(a.join(" "),{action:"page_guide",questionId:"manual_question_form",force:!0})},"aria-label":"Explicar la pÃ¡gina",children:"ðŸ›ˆ Explicar pÃ¡gina"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Escribe tu pregunta"}),q&&e.jsx(D,{intent:"error",children:q}),M&&e.jsx(D,{intent:"success",children:M}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/80",htmlFor:"topic-select",children:"Tema"}),e.jsx("select",{id:"topic-select",value:d.selectedTopic,onChange:a=>g(c=>({...c,selectedTopic:a.target.value})),disabled:C,className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",children:h.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("label",{className:"text-sm text-white/80",htmlFor:"question-input",children:"Pregunta"}),e.jsx(J,{id:"question-input",type:"text",value:d.question,onChange:a=>g(c=>({...c,question:a.target.value})),disabled:C,required:!0})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("label",{className:"text-sm text-white/80",children:"Opciones"}),e.jsx("div",{className:"grid gap-3",children:d.options.map((a,c)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(J,{type:"text",value:a,onChange:p=>P(c,p.target.value),disabled:C,required:!0,placeholder:`OpciÃ³n ${c+1}`,className:"flex-1"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"radio",name:"correctOption",checked:d.correctIndex===c,onChange:()=>g(p=>({...p,correctIndex:c})),disabled:C,className:"h-4 w-4"}),e.jsx("span",{children:"Correcta"})]})]},c))})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(j,{type:"button",variant:"secondary",onClick:o,disabled:C,onFocus:()=>n&&i("AtrÃ¡s: vuelve al generador de preguntas.",{force:!0}),onMouseEnter:()=>n&&i("AtrÃ¡s: vuelve al generador de preguntas.",{force:!0}),children:"AtrÃ¡s"}),e.jsx(j,{type:"submit",disabled:C,onFocus:()=>n&&i("Guardar: guarda la pregunta actual.",{force:!0}),onMouseEnter:()=>n&&i("Guardar: guarda la pregunta actual.",{force:!0}),children:C?"Guardandoâ€¦":"Guardar"})]})]})};function fe({open:h,title:T,onClose:o,children:n,className:i=""}){return r.useEffect(()=>{const w=g=>{g.key==="Escape"&&o?.()};h&&document.addEventListener("keydown",w);const d=document.body.style.overflow;return h&&(document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",w),document.body.style.overflow=d}},[h,o]),e.jsx(de,{children:h&&e.jsxs(Z.div,{className:"fixed inset-0 z-[3000] flex items-center justify-center px-4 py-8",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("button",{"aria-label":"Cerrar",className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:o}),e.jsxs(Z.div,{role:"dialog","aria-modal":"true",className:`relative w-full max-w-2xl max-h-[85vh] overflow-auto rounded-2xl border border-white/10 bg-bb-bg-primary/90 shadow-xl ${i}`,initial:{scale:.98,y:10,opacity:0},animate:{scale:1,y:0,opacity:1},exit:{scale:.98,y:10,opacity:0},transition:{type:"spring",stiffness:200,damping:22},children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 px-6 py-5 border-b border-white/10 bg-bb-bg-primary/90",children:[T?e.jsx("h2",{className:"text-xl md:text-2xl font-bold",children:T}):e.jsx("span",{className:"sr-only",children:"Modal"}),e.jsx("button",{onClick:o,className:"rounded-md p-2 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-bb-primary","aria-label":"Cerrar",children:"âœ•"})]}),e.jsx("div",{className:"px-6 py-5",children:n})]})]})})}const Ie=({onQuestionsGenerated:h,onClose:T})=>{const{isVoiceModeEnabled:o,speak:n}=ee(),{user:i}=te(),[w,d]=r.useState([]),[g,q]=r.useState(""),[k,C]=r.useState("medium"),[S,M]=r.useState(null),[N,P]=r.useState(""),[E,z]=r.useState(!1),[a,c]=r.useState(!1),[p,I]=r.useState(!1),[v,Q]=r.useState(null),[B,L]=r.useState(""),[ae,W]=r.useState(0),[H,U]=r.useState([]),[K,re]=r.useState(""),[V,X]=r.useState([]),[he,xe]=r.useState(""),[R,x]=r.useState(!1),[G,u]=r.useState(""),[Y,A]=r.useState(""),[be,se]=r.useState([]);r.useEffect(()=>{ne(),oe()},[]),r.useEffect(()=>{P(typeof S=="number"?String(S):"")},[S]),r.useEffect(()=>{L(typeof v=="number"?String(v):"")},[v]);const ne=async()=>{try{const t=await ce();d(t),t.length>0&&q(t[0])}catch{u("Error obteniendo temas. Por favor intenta de nuevo.")}},oe=async()=>{try{const t=await ue();se(t)}catch{u("No se pudieron cargar los niveles de dificultad. Por favor, intenta de nuevo mÃ¡s tarde.")}},ie=async()=>{if(!g){u("Por favor selecciona un tema vÃ¡lido");return}x(!0),u("");try{const t="http://localhost:5000/api",s=i&&i.getIdToken?await i.getIdToken():null,y=await(await fetch(`${t}/ai/generate-questions`,{method:"POST",headers:{"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{}},body:JSON.stringify({topic:g,difficulty:k,count:S,useAI:E})})).json();if(y.success){const $=y.questions.map(l=>({...(()=>{if(!Array.isArray(l.options)||typeof l.correctAnswerIndex!="number")return l;const f=l.options.map((m,_)=>({opt:m,origIdx:_}));for(let m=f.length-1;m>0;m--){const _=Math.floor(Math.random()*(m+1));[f[m],f[_]]=[f[_],f[m]]}const F=f.findIndex(m=>m.origIdx===l.correctAnswerIndex);return{...l,options:f.map(m=>m.opt),correctAnswerIndex:F}})(),createdBy:i?.uid||"anon",createdAt:Date.now(),category:g,difficulty:k}));let O=!1;try{const l=i&&i.getIdToken?await i.getIdToken():null,F=await(await fetch(`${t}/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",...l?{Authorization:`Bearer ${l}`}:{}},body:JSON.stringify({questions:$})})).json();F.success?O=!0:(u(m=>(m?m+" | ":"")+(F.error||"Error guardando preguntas en Firestore")),u("No se pudieron guardar las preguntas. "+(F.error||"Por favor, intenta de nuevo.")))}catch{u("OcurriÃ³ un error al guardar las preguntas. Por favor, verifica tu conexiÃ³n e intenta de nuevo.")}if(!O){x(!1);return}h(y.questions),x(!1)}else u(y.error||"Error generando preguntas"),u("No se pudieron generar las preguntas: "+(y.error||"Por favor, intenta de nuevo."))}catch{u("Error de conexiÃ³n. Por favor, verifica tu conexiÃ³n a internet e intenta nuevamente.")}finally{x(!1)}};return e.jsxs(fe,{open:!0,title:"ðŸ¤– Generador de Preguntas",onClose:T,children:[o&&!a&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx(j,{variant:"outline",size:"sm",type:"button",onClick:async()=>{const t=[];!a&&!E?(t.push("EstÃ¡s en el generador de preguntas."),t.push("BotÃ³n Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial."),t.push("BotÃ³n Escribir preguntas: te permite escribir preguntas manualmente."),t.push("Selecciona una opciÃ³n para continuar.")):E&&!a&&(t.push("Formulario para generar preguntas con inteligencia artificial."),t.push("Campo Tema: selecciona el tema de las preguntas."),t.push("Campo Dificultad: elige la dificultad."),t.push("Campo Cantidad: indica cuÃ¡ntas preguntas quieres generar."),t.push("BotÃ³n Crear preguntas: genera las preguntas."),t.push("BotÃ³n AtrÃ¡s: vuelve a la pantalla anterior.")),await n(t.join(" "),{action:"page_guide",questionId:"ai_question_generator",force:!0})},"aria-label":"Explicar la pÃ¡gina",onFocus:()=>n("Explicar pÃ¡gina: describe la funciÃ³n de cada botÃ³n y campo en esta vista.",{force:!0}),onMouseEnter:()=>n("Explicar pÃ¡gina: describe la funciÃ³n de cada botÃ³n y campo en esta vista.",{force:!0}),children:"ðŸ›ˆ Explicar pÃ¡gina"})}),R&&e.jsx(pe,{text:"Generandoâ€¦",mobileOnly:!0}),G&&e.jsx(D,{intent:"error",children:G}),Y&&e.jsx(D,{intent:"success",children:Y}),!a&&!E&&!p&&e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(j,{onClick:()=>z(!0),size:"lg",onFocus:()=>o&&n("Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial.",{force:!0}),onMouseEnter:()=>o&&n("Crear con IA: genera preguntas automÃ¡ticamente usando inteligencia artificial.",{force:!0}),children:"ðŸ¤– Crear con IA"}),e.jsx(j,{variant:"secondary",size:"lg",onClick:()=>{c(!0),z(!1),W(0),U([])},onFocus:()=>o&&n("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),onMouseEnter:()=>o&&n("Escribir preguntas: te permite escribir preguntas manualmente.",{force:!0}),children:"âœï¸ Escribir preguntas"}),e.jsx(j,{variant:"secondary",size:"lg",onClick:()=>{I(!0),z(!1)},onFocus:()=>o&&n("Capturar pregunta: extrae preguntas de imÃ¡genes usando OCR.",{force:!0}),onMouseEnter:()=>o&&n("Capturar pregunta: extrae preguntas de imÃ¡genes usando OCR.",{force:!0}),children:"ðŸ“¸ Capturar pregunta"})]}),!a&&E&&!p&&e.jsxs("form",{className:"mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4",onSubmit:async t=>{t.preventDefault(),x(!0),u("");try{await ie(),u("")}catch{u("Error al generar preguntas. Por favor, intÃ©ntalo de nuevo.")}finally{x(!1)}},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"topic",className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{id:"topic",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:g,onChange:t=>q(t.target.value),disabled:w.length===0,children:w.length===0?e.jsx("option",{value:"",children:"No hay temas"}):w.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"difficulty",className:"block mb-1 text-sm text-white/80",children:"Dificultad"}),e.jsxs("select",{id:"difficulty",className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",value:k,onChange:t=>C(t.target.value),children:[e.jsx("option",{value:"easy",children:"FÃ¡cil"}),e.jsx("option",{value:"medium",children:"Media"}),e.jsx("option",{value:"hard",children:"DifÃ­cil"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"numQuestions",className:"block mb-1 text-sm text-white/80",children:"Cantidad"}),e.jsxs("div",{children:[e.jsx(J,{id:"numQuestions",type:"text",inputMode:"numeric",pattern:"[0-9]*",value:N,onChange:t=>{const s=t.target.value.replace(/\D+/g,"");P(s);const b=s?parseInt(s,10):NaN;Number.isNaN(b)?M(null):M(b)},onBlur:()=>{const t=parseInt(N||"",10);if(Number.isNaN(t)||t<1){M(null),P("");return}const s=Math.max(1,t);M(s),P(String(s))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(N===""||S===null)&&e.jsx("div",{className:`mt-1 text-xs ${N===""?"text-white/60":"text-red-300"}`,children:N===""?"Ingresa un nÃºmero (>= 1)":"Valor invÃ¡lido"})]})]}),G&&e.jsx(D,{intent:"error",className:"sm:col-span-3",children:G}),e.jsxs("div",{className:"sm:col-span-3 mt-2 flex flex-wrap gap-3 justify-end items-center",children:[e.jsx(j,{type:"button",variant:"secondary",onClick:()=>z(!1),disabled:R,onFocus:()=>o&&n("AtrÃ¡s: vuelve a la pantalla anterior.",{force:!0}),onMouseEnter:()=>o&&n("AtrÃ¡s: vuelve a la pantalla anterior.",{force:!0}),children:"AtrÃ¡s"}),e.jsx(j,{type:"submit",disabled:R,onFocus:()=>o&&n("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),onMouseEnter:()=>o&&n("Crear preguntas: genera las preguntas con inteligencia artificial.",{force:!0}),children:R?e.jsxs(e.Fragment,{children:[e.jsx(me,{size:16,className:"mr-2"}),"Creandoâ€¦"]}):"Crear preguntas"})]})]}),a&&e.jsx("div",{className:"mt-2",children:ae===0?e.jsxs("form",{className:"grid grid-cols-1 gap-4",onSubmit:t=>{t.preventDefault(),W(1),U([]),re(g)},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"Tema"}),e.jsx("select",{value:g,onChange:t=>q(t.target.value),className:"block w-full rounded-xl border-2 border-white/10 bg-white/5 px-4 py-3 text-white backdrop-blur-md focus:border-bb-primary focus:ring-2 focus:ring-bb-primary/30 focus:outline-none",children:w.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm text-white/80",children:"Â¿CuÃ¡ntas preguntas?"}),e.jsxs("div",{children:[e.jsx(J,{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:B,onChange:t=>{const s=t.target.value.replace(/\D+/g,"");L(s);const b=s?parseInt(s,10):NaN;Number.isNaN(b)?Q(null):Q(b)},onBlur:()=>{const t=parseInt(B||"",10);if(Number.isNaN(t)||t<1){Q(null),L("");return}const s=Math.max(1,t);Q(s),L(String(s))},required:!0,placeholder:"Cantidad",className:"w-28 text-center"}),(B===""||v===null)&&e.jsx("div",{className:`mt-1 text-xs ${B===""?"text-white/60":"text-red-300"}`,children:B===""?"Ingresa un nÃºmero (>= 1)":"Valor invÃ¡lido"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(j,{type:"button",variant:"secondary",onClick:()=>c(!1),onFocus:()=>o&&n("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),onMouseEnter:()=>o&&n("Volver: cierra el formulario de preguntas manuales y regresa a la pantalla anterior.",{force:!0}),children:"Volver"}),e.jsx(j,{type:"submit",onFocus:()=>o&&n("Empezar: inicia la creaciÃ³n manual de preguntas.",{force:!0}),onMouseEnter:()=>o&&n("Empezar: inicia la creaciÃ³n manual de preguntas.",{force:!0}),children:"Empezar"})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"text-center mb-3 font-bold",children:["Â¡Vamos! Pregunta ",H.length+1," de ",v]}),e.jsx(ge,{topics:[K],onQuestionCreated:async t=>{try{x(!0),u("");const s="http://localhost:5000/api";if(!i||!i.getIdToken)throw new Error("Debes iniciar sesiÃ³n para crear preguntas");const b=await i.getIdToken(),y=await fetch(`${s}/questions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`},body:JSON.stringify(t)}),$=await y.json();if(!y.ok)throw new Error($.error||"Error al guardar la pregunta");const O=$.question||{...t},l=[...H,{...O,category:K}];if(l.length===v){const f=await fetch(`${s}/questions/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`},body:JSON.stringify({questions:l})}),F=await f.json();if(!f.ok)throw new Error(F.error||"Error al guardar las preguntas en lote");return h&&h(l),A("Â¡Todas las preguntas han sido guardadas exitosamente!"),setTimeout(()=>{c(!1),A("")},1500),l}else return U(l),W(f=>f+1),A(`Â¡Pregunta ${l.length} de ${v} guardada exitosamente!`),setTimeout(()=>A(""),1500),O}catch(s){u("No se pudo guardar la pregunta: "+(s.message||"Por favor, intenta de nuevo."))}finally{x(!1)}},onCancel:()=>{c(!1)}})]})}),p&&e.jsx(le,{topics:w,onQuestionExtracted:async t=>{x(!0),u("");try{const s="http://localhost:5000/api",b=i&&i.getIdToken?await i.getIdToken():null,y=await fetch(`${s}/questions`,{method:"POST",headers:{"Content-Type":"application/json",...b?{Authorization:`Bearer ${b}`}:{}},body:JSON.stringify(t)});if(y.ok){const O=(await y.json()).question||{...t},l=[...V,O];X(l),A(`âœ… Pregunta ${l.length} guardada exitosamente. Puedes agregar mÃ¡s o finalizar.`),x(!1)}else u("No se pudo guardar la pregunta"),x(!1)}catch(s){u("Error al guardar la pregunta: "+(s.message||"Por favor, intenta de nuevo.")),x(!1)}},onCancel:()=>{I(!1),V.length>0&&(A(`âœ… Se guardaron ${V.length} pregunta(s) de OCR`),setTimeout(()=>{h(V),X([]),A("")},1500))}})]})};export{Ie as default};
//# sourceMappingURL=AIQuestionGenerator-Dpgd5fHi.js.map
