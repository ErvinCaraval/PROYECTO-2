import{r as u,u as F,b as O,j as e}from"./index-B7SNj0r6.js";import{B as v}from"./Button-BAFGbEtv.js";import{A as R}from"./Alert-CmJLF0tw.js";import{F as U,o as V,a as _,g as S}from"./imageOptimizer-C7-BxCaI.js";import"./clsx-B-dksMZM.js";import"./index-B9PUOGrg.js";const L="BrainBlitzFaceDB",q=1,y="faceEmbeddings";function K(){return new Promise((g,s)=>{const i=indexedDB.open(L,q);i.onerror=()=>s(i.error),i.onsuccess=()=>g(i.result),i.onupgradeneeded=c=>{const l=c.target.result;l.objectStoreNames.contains(y)||l.createObjectStore(y,{keyPath:"email"})}})}async function M(g,s,i={}){try{const x=(await K()).transaction(y,"readwrite").objectStore(y),w={email:g,embeddings:s,timestamp:Date.now(),...i};return new Promise((n,b)=>{const m=x.put(w);m.onsuccess=()=>{console.log(`âœ“ Embeddings cacheados para ${g}`),n(w)},m.onerror=()=>b(m.error)})}catch(c){throw console.error("Error cacheando embeddings:",c),c}}function X(){const[g,s]=u.useState(""),[i,c]=u.useState(""),[l,x]=u.useState(!1),[w,n]=u.useState(""),[b,m]=u.useState(null),[C,j]=u.useState(null),[N,z]=u.useState(!1),{user:a}=F(),E=O(),[B,k]=u.useState(!1),A=async t=>{try{n("Optimizando imagen...");const r=N?await V(t):await _(t,200,200,.3),d=S(t),p=S(r),o=Math.round((1-p/d)*100);console.log(`âœ“ Imagen optimizada (${N?"ULTRA":"ESTÃNDAR"}): ${d}KB â†’ ${p}KB (${o}% reducciÃ³n)`),m(r),j(r),n("")}catch(r){console.error("Error optimizando imagen, usando original:",r),m(t),j(t),n("")}},P=()=>{m(null),j(null),s(""),c("")},$=async()=>{if(!b){s("Por favor, captura una foto primero");return}if(!a){s("Debes estar autenticado para registrar tu cara. Redirigiendo al login..."),setTimeout(()=>{E("/login")},2e3);return}x(!0),n("Preparando registro..."),s(""),c("");try{console.log("1. Iniciando registro facial...");let t;try{n("Obteniendo autenticaciÃ³n..."),t=await a.getIdToken(),console.log("2. Token obtenido correctamente")}catch(o){throw console.error("Error obteniendo token:",o),new Error("No se pudo obtener el token de autenticaciÃ³n. Por favor, inicia sesiÃ³n nuevamente.")}const r=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api";console.log("3. API URL:",r),console.log("4. TamaÃ±o de imagen:",b.length,"caracteres");const d=new AbortController,p=setTimeout(()=>d.abort(),3e4);try{console.log("5. Enviando peticiÃ³n al backend..."),n("Enviando imagen...");const o=JSON.stringify({image:b,token:t});console.log(`TamaÃ±o del payload: ${(o.length/1024).toFixed(2)}KB`);const h=await fetch(`${r}/face/register`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"Accept-Encoding":"gzip, deflate"},body:o,signal:d.signal,priority:"high"});clearTimeout(p),console.log("6. Respuesta recibida. Status:",h.status),n("Procesando resultado...");const I=h.headers.get("content-type");if(!I||!I.includes("application/json")){const T=await h.text();throw console.error("Respuesta no es JSON:",T.substring(0,200)),new Error(`El servidor devolviÃ³ un error (${h.status}). Verifica la consola para mÃ¡s detalles.`)}const f=await h.json();if(console.log("7. Datos JSON parseados:",f),!h.ok)throw console.error("Respuesta no OK:",f),new Error(f.error||`Error en el servidor (${h.status})`);if(f.success){if(console.log("8. Registro facial exitoso!"),c("Â¡Registro facial completado exitosamente!"),n(""),f.embeddings&&a?.email)try{await M(a.email,f.embeddings,{registrationDate:new Date().toISOString()})}catch(T){console.warn("No se pudo cachear embeddings, pero el registro fue exitoso:",T)}setTimeout(()=>{a?.displayName?E("/dashboard"):E("/complete-profile")},2e3)}else throw new Error(f.error||"Error en el registro")}catch(o){throw clearTimeout(p),o.name==="AbortError"?(console.error("Timeout en la peticiÃ³n"),new Error("La peticiÃ³n tardÃ³ demasiado tiempo. Intenta con una imagen mÃ¡s pequeÃ±a.")):o instanceof TypeError?(console.error("Error de conexiÃ³n:",o),new Error(`No se pudo conectar al servidor (${r}). Verifica que estÃ© activo.`)):o}}catch(t){const r=t.message||"Error al registrar la cara. Por favor, intenta de nuevo.";s(r),console.error("Error en registro facial:",t)}finally{x(!1),n("")}};u.useEffect(()=>{(async()=>{if(!a)return k(!1);try{const r=await a.getIdToken(),d=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",o=await(await fetch(`${d}/face/exists`,{method:"GET",headers:{Authorization:`Bearer ${r}`}})).json();k(!!o.exists)}catch(r){console.error("Error checking face registration:",r)}})()},[a]);const D=async()=>{if(!a){s("Debes estar autenticado para eliminar tu registro facial");return}if(confirm("Â¿EstÃ¡s seguro de eliminar tu registro facial? Esta acciÃ³n no se puede deshacer.")){x(!0);try{const t=await a.getIdToken(),r=typeof window<"u"&&window.ENV?.VITE_API_URL||"https://backend-v1-latest.onrender.com/api",d=await fetch(`${r}/face/${a.uid}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}}),p=await d.json();if(!d.ok)throw new Error(p.error||"Error eliminando registro facial");c("Registro facial eliminado correctamente"),k(!1),j(null),m(null)}catch(t){s(t.message||"Error eliminando registro facial")}finally{x(!1)}}};return e.jsx("div",{className:"container min-h-screen px-4 py-10",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-extrabold",children:"ğŸ“¸ Registro Facial"}),e.jsx("p",{className:"text-white/70 mt-2",children:a?"Captura una foto de tu rostro para habilitar el login facial":"Paso 2: Captura una foto de tu rostro para completar tu registro"}),!a&&e.jsx("p",{className:"text-white/50 text-sm mt-1",children:"Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial"}),e.jsx("div",{className:"mt-4 flex items-center justify-center gap-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-white/70 cursor-pointer hover:text-white",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:t=>z(t.target.checked),disabled:l,className:"w-4 h-4 accent-bb-primary cursor-pointer"}),e.jsx("span",{children:"ğŸš€ CompresiÃ³n Ultra (si es muy lento)"})]})})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6",children:[g&&e.jsx(R,{intent:"error",className:"mb-4",children:g}),i&&e.jsx(R,{intent:"success",className:"mb-4",children:i}),w&&e.jsxs(R,{intent:"info",className:"mb-4",children:["â³ ",w]}),C?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative bg-black rounded-lg overflow-hidden",children:e.jsx("img",{src:C,alt:"Foto capturada",className:"w-full h-auto max-h-[480px] mx-auto"})}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(v,{onClick:P,variant:"outline",disabled:l,size:"lg",children:"ğŸ”„ Tomar Otra Foto"}),e.jsx(v,{onClick:$,disabled:l,size:"lg",children:l?"â³ Registrando...":"âœ… Registrar Cara"})]})]}):e.jsx(U,{onCapture:A,onCancel:()=>E("/dashboard"),disabled:l,buttonText:"ğŸ“· Capturar Foto",showCancel:!0}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(v,{onClick:()=>E("/dashboard"),variant:"ghost",size:"sm",children:"â† Volver al Dashboard"}),B&&e.jsx(v,{onClick:D,variant:"destructive",size:"sm",disabled:l,children:"ğŸ—‘ï¸ Eliminar registro facial"})]})})]})]})})}export{X as default};
//# sourceMappingURL=FaceRegister-BkcUQhiD.js.map
