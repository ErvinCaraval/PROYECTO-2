import{r as c,u as I,b as P,j as e}from"./index-BaYh_0Lp.js";import{B as x}from"./Button-CeP88Yp2.js";import{A as b}from"./Alert-CT4I4Ncm.js";import{F as A,o as F,g as T}from"./imageOptimizer-Dm8w1KB1.js";function K(){const[v,l]=c.useState(""),[j,h]=c.useState(""),[d,g]=c.useState(!1),[k,s]=c.useState(""),[w,p]=c.useState(null),[y,f]=c.useState(null),{user:o}=I(),u=P(),[C,E]=c.useState(!1),z=async r=>{try{s("Optimizando imagen...");const t=await F(r,240,240,.5),i=T(r),n=T(t),a=Math.round((1-n/i)*100);console.log(`âœ“ Imagen optimizada: ${i}KB â†’ ${n}KB (${a}% reducciÃ³n)`),p(t),f(t),s("")}catch(t){console.error("Error optimizando imagen, usando original:",t),p(r),f(r),s("")}},R=()=>{p(null),f(null),l(""),h("")},S=async()=>{if(!w){l("Por favor, captura una foto primero");return}if(!o){l("Debes estar autenticado para registrar tu cara. Redirigiendo al login..."),setTimeout(()=>{u("/login")},2e3);return}g(!0),s("Preparando registro..."),l(""),h("");try{console.log("1. Iniciando registro facial...");let r;try{s("Obteniendo autenticaciÃ³n..."),r=await o.getIdToken(),console.log("2. Token obtenido correctamente")}catch(a){throw console.error("Error obteniendo token:",a),new Error("No se pudo obtener el token de autenticaciÃ³n. Por favor, inicia sesiÃ³n nuevamente.")}const t="http://localhost:5000/api";console.log("3. API URL:",t),console.log("4. TamaÃ±o de imagen:",w.length,"caracteres");const i=new AbortController,n=setTimeout(()=>i.abort(),45e3);try{console.log("5. Enviando peticiÃ³n al backend..."),s("Enviando imagen...");const a=await fetch(`${t}/face/register`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({image:w,token:r}),signal:i.signal});clearTimeout(n),console.log("6. Respuesta recibida. Status:",a.status),s("Procesando resultado...");const N=a.headers.get("content-type");if(!N||!N.includes("application/json")){const B=await a.text();throw console.error("Respuesta no es JSON:",B.substring(0,200)),new Error(`El servidor devolviÃ³ un error (${a.status}). Verifica la consola para mÃ¡s detalles.`)}const m=await a.json();if(console.log("7. Datos JSON parseados:",m),!a.ok)throw console.error("Respuesta no OK:",m),new Error(m.error||`Error en el servidor (${a.status})`);if(m.success)console.log("8. Registro facial exitoso!"),h("Â¡Registro facial completado exitosamente!"),s(""),setTimeout(()=>{o?.displayName?u("/dashboard"):u("/complete-profile")},2e3);else throw new Error(m.error||"Error en el registro")}catch(a){throw clearTimeout(n),a.name==="AbortError"?(console.error("Timeout en la peticiÃ³n"),new Error("La peticiÃ³n tardÃ³ demasiado tiempo. Intenta con una imagen mÃ¡s pequeÃ±a.")):a instanceof TypeError?(console.error("Error de conexiÃ³n:",a),new Error(`No se pudo conectar al servidor (${t}). Verifica que estÃ© activo.`)):a}}catch(r){const t=r.message||"Error al registrar la cara. Por favor, intenta de nuevo.";l(t),console.error("Error en registro facial:",r)}finally{g(!1),s("")}};c.useEffect(()=>{(async()=>{if(!o)return E(!1);try{const t=await o.getIdToken(),a=await(await fetch("http://localhost:5000/api/face/exists",{method:"GET",headers:{Authorization:`Bearer ${t}`}})).json();E(!!a.exists)}catch(t){console.error("Error checking face registration:",t)}})()},[o]);const $=async()=>{if(!o){l("Debes estar autenticado para eliminar tu registro facial");return}if(confirm("Â¿EstÃ¡s seguro de eliminar tu registro facial? Esta acciÃ³n no se puede deshacer.")){g(!0);try{const r=await o.getIdToken(),i=await fetch(`http://localhost:5000/api/face/${o.uid}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}}),n=await i.json();if(!i.ok)throw new Error(n.error||"Error eliminando registro facial");h("Registro facial eliminado correctamente"),E(!1),f(null),p(null)}catch(r){l(r.message||"Error eliminando registro facial")}finally{g(!1)}}};return e.jsx("div",{className:"container min-h-screen px-4 py-10",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-extrabold",children:"ğŸ“¸ Registro Facial"}),e.jsx("p",{className:"text-white/70 mt-2",children:o?"Captura una foto de tu rostro para habilitar el login facial":"Paso 2: Captura una foto de tu rostro para completar tu registro"}),!o&&e.jsx("p",{className:"text-white/50 text-sm mt-1",children:"Ya creaste tu cuenta, ahora completa tu registro con reconocimiento facial"})]}),e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-6",children:[v&&e.jsx(b,{intent:"error",className:"mb-4",children:v}),j&&e.jsx(b,{intent:"success",className:"mb-4",children:j}),k&&e.jsxs(b,{intent:"info",className:"mb-4",children:["â³ ",k]}),y?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative bg-black rounded-lg overflow-hidden",children:e.jsx("img",{src:y,alt:"Foto capturada",className:"w-full h-auto max-h-[480px] mx-auto"})}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(x,{onClick:R,variant:"outline",disabled:d,size:"lg",children:"ğŸ”„ Tomar Otra Foto"}),e.jsx(x,{onClick:S,disabled:d,size:"lg",children:d?"â³ Registrando...":"âœ… Registrar Cara"})]})]}):e.jsx(A,{onCapture:z,onCancel:()=>u("/dashboard"),disabled:d,buttonText:"ğŸ“· Capturar Foto",showCancel:!0}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(x,{onClick:()=>u("/dashboard"),variant:"ghost",size:"sm",children:"â† Volver al Dashboard"}),C&&e.jsx(x,{onClick:$,variant:"destructive",size:"sm",disabled:d,children:"ğŸ—‘ï¸ Eliminar registro facial"})]})})]})]})})}export{K as default};
//# sourceMappingURL=FaceRegister-1zvA97JE.js.map
